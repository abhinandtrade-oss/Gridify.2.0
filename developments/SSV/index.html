<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Login - Event Tracker By Gridify</title>
    <link rel="icon" href="public/assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="public/assets/css/login-new.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="public/assets/js/firebase-config.js"></script>
    <script src="public/assets/js/auth.js"></script>
</head>

<body>

    <div class="login-container">
        <div class="login-card">
            <div class="brand-section">
                <!-- Added filter to ensure logo is visible on dark background if transparent -->
                <img src="public/assets/images/logo.png" alt="SSV">
                <h2>Event Tracker</h2>
                <p>by Gridify</p>
                <p style="margin-top: 5px; font-size: 0.75rem; color: #6366F1;">dedicated portal for Jobins KJ</p>
            </div>

            <form id="userLoginForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="email" class="form-control" required placeholder="name@company.com">
                </div>

                <div class="form-group">
                    <label class="form-label flex-label">
                        Password
                        <a href="#" onclick="showForgotPassword()" class="forgot-link">Forgot password?</a>
                    </label>
                    <input type="password" id="password" class="form-control" required placeholder="••••••••">
                </div>

                <div style="margin-top: 2rem;">
                    <button type="submit" class="btn btn-primary">Sign In</button>
                </div>
            </form>

            <div id="message" style="margin-top: 1rem; text-align: center; font-size: 0.9rem;"></div>

            <!-- Kept footer logic but styled -->
            <div class="footer-text">
                powered by <a href="https://www.gridify.in" target="_blank">GRIDIFY</a>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Reset Password</h3>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">
                Enter your email address and we'll send you a link to reset your password.
            </p>
            <div class="form-group">
                <input type="email" id="resetEmail" class="form-control" placeholder="Enter your email">
            </div>
            <div class="flex-label" style="margin-top: 1.5rem;">
                <button onclick="closeForgotModal()" class="btn btn-danger">Cancel</button>
                <button onclick="sendResetLink()" class="btn btn-primary-modal">Send Link</button>
            </div>
            <p id="resetMessage" style="margin-top:1rem; text-align:center; font-size:0.9rem;"></p>
        </div>
    </div>

    <script>
        document.getElementById('userLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const msg = document.getElementById('message');

            msg.style.color = 'var(--text-muted)';
            msg.innerText = 'Authenticating...';

            // Slight delay for UX
            await new Promise(r => setTimeout(r, 500));

            const result = await AuthService.login(email, password);

            if (result.success) {
                // Check Role
                const profile = await AuthService.getUserProfile(result.user.uid);

                if (!profile) {
                    msg.style.color = '#EF4444'; // Red
                    msg.innerText = 'Access Denied: You must be added by an admin.';
                    auth.signOut();
                    return;
                }

                msg.style.color = '#10B981'; // Green
                msg.innerText = 'Login successful! Redirecting...';

                setTimeout(() => {
                    // Logic Update: Admin Redirect
                    if (profile.role === 'admin' || profile.role === 'super_admin') {
                        window.location.href = 'public/admin/dashboard.html';
                    } else if (profile.role === 'user') {
                        window.location.href = 'public/user/dashboard.html';
                    } else {
                        // Fallback for unknown roles
                        window.location.href = 'public/user/dashboard.html';
                    }
                }, 800);
            } else {
                msg.style.color = '#EF4444';
                msg.innerText = result.message;
            }
        });

        // Forgot Password Logic
        function showForgotPassword() {
            const emailVal = document.getElementById('email').value;
            if (emailVal) document.getElementById('resetEmail').value = emailVal;
            document.getElementById('forgotPasswordModal').classList.add('active');
        }

        function closeForgotModal() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
            document.getElementById('resetMessage').innerText = '';
        }

        async function sendResetLink() {
            const email = document.getElementById('resetEmail').value;
            if (!email) {
                document.getElementById('resetMessage').style.color = '#EF4444';
                document.getElementById('resetMessage').innerText = 'Please enter an email.';
                return;
            }

            const res = await AuthService.sendPasswordResetEmail(email);
            if (res.success) {
                document.getElementById('resetMessage').style.color = '#10B981';
                document.getElementById('resetMessage').innerText = 'Reset link sent! Check your email.';
                setTimeout(closeForgotModal, 3000);
            } else {
                document.getElementById('resetMessage').style.color = '#EF4444';
                document.getElementById('resetMessage').innerText = res.message;
            }
        }

        // Close modal on outside click
        document.getElementById('forgotPasswordModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('forgotPasswordModal')) {
                closeForgotModal();
            }
        });
    </script>
</body>

</html>