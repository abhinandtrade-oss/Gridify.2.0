<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Admin Dashboard</title>
    <link rel="icon" href="../assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="../assets/css/style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/db.js"></script>
    <script type="module">
        import { CSVExport, formatDate } from '../assets/js/utils.js';
        window.CSVExport = CSVExport;
        window.formatDate = formatDate;
    </script>
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div style="text-align: left; padding-left: 0.75rem; margin-bottom: 2rem;">
                <img src="../assets/images/logo.png" alt="SSV" style="height: 32px;">
            </div>
            <h2
                style="color: var(--text-primary); margin: 0; font-size: 1.2rem; letter-spacing: 0.05em; text-transform: uppercase; font-weight: 700;">
                Event Tracker Admin</h2>
            <div class="sidebar-brand-sub" style="color: var(--text-secondary); font-size: 0.8rem; opacity: 0.7;">
                dedicated portal for <span style="color: var(--primary-color);">Jobins KJ</span></div>

            <nav>
                <a href="dashboard.html" class="btn btn-primary"
                    style="justify-content: flex-start; background: transparent; border: 1px solid transparent; color: var(--text-secondary);">
                    Dashboard
                </a>
                <a href="events.html" class="btn btn-primary"
                    style="justify-content: flex-start; background: transparent; border: 1px solid transparent; color: var(--text-secondary);">
                    Events
                </a>
                <a href="staff-data.html" class="btn btn-primary"
                    style="justify-content: flex-start; background: transparent; border: 1px solid transparent; color: var(--text-secondary);">
                    Update Staff Data
                </a>
                <a href="reports.html" class="btn btn-primary"
                    style="justify-content: flex-start; background: rgba(99, 102, 241, 0.05); color: var(--primary-color); border: 1px solid rgba(99, 102, 241, 0.1);">
                    Reports
                </a>
                <a href="../user/dashboard.html" class="btn btn-primary"
                    style="justify-content: flex-start; background: transparent; border: 1px solid transparent; color: var(--text-secondary);">
                    User View
                </a>
            </nav>

            <div style="margin-top: auto; padding: 0.75rem;">
                <button onclick="AuthService.logout()" class="btn btn-danger"
                    style="width: 100%; border-radius: 0.5rem; font-size: 0.85rem; padding: 0.5rem;">Logout</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="content-area">
            <header class="flex justify-between items-center mb-4">
                <h1>Report Generation</h1>
                <span class="status-badge status-urgent">Admin Access</span>
            </header>

            <div class="card p-standard animate-fade-in" style="margin-bottom: 2rem;">
                <h3>Summary Report</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    Download a comprehensive report of all events, including completion status and coordinator details.
                </p>
                <div class="flex gap-4">
                    <button onclick="exportAll()" class="btn btn-primary">Download All Events CSV</button>
                </div>
            </div>

            <div class="card p-standard animate-fade-in">
                <h3>Monthly Breakdown</h3>
                <div id="monthlyStats" class="flex gap-4" style="flex-wrap: wrap; margin-top: 1rem;">
                    <p style="color: var(--text-secondary);">Loading stats...</p>
                </div>
            </div>

            <footer class="footer">
                powered by <a href="https://www.gridify.in" target="_blank">GRIDIFY</a>
            </footer>
        </main>
    </div>

    <script type="module">
        import { CSVExport, formatDate } from '../assets/js/utils.js';

        AuthService.requireRole('admin');

        let allEvents = [];

        async function init() {
            allEvents = await DBService.getEvents();
            generateStats();
            document.getElementById('monthlyStats').innerHTML = ''; // Clear loading
        }

        window.exportAll = () => {
            if (allEvents.length === 0) return alert("No events to export.");
            CSVExport.downloadCSV(allEvents, `SSV_Full_Report_${new Date().toISOString().slice(0, 10)}.csv`);
        };

        function generateStats() {
            if (!allEvents.length) return;

            // Group by Month
            const stats = {};

            allEvents.forEach(e => {
                const date = new Date(e.eventDate);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`; // YYYY-MM
                if (!stats[key]) stats[key] = { total: 0, completed: 0 };
                stats[key].total++;
                if (e.status === 'Completed' || e.status === 'Report Received') stats[key].completed++;
            });

            const container = document.getElementById('monthlyStats');

            Object.keys(stats).sort().reverse().forEach(key => {
                const div = document.createElement('div');
                div.className = 'card';
                div.style.minWidth = '200px';
                div.style.padding = '1rem';
                div.style.background = '#ffffff';
                div.style.border = '1px solid var(--border-color)';
                div.innerHTML = `
                    <h4 style="margin-bottom:0.5rem; color:var(--primary-color)">${key}</h4>
                    <div style="font-size:2rem; font-weight:bold; color: var(--text-primary);">${stats[key].total} <span style="font-size:0.8rem; font-weight:normal; color:var(--text-secondary)">events</span></div>
                    <div style="font-size:0.9rem; color: #10b981;">${stats[key].completed} Completed</div>
                `;
                container.appendChild(div);
            });
        }

        init();
    </script>
</body>

</html>