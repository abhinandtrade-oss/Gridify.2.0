<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Update Staff Data - Admin Dashboard</title>
    <link rel="icon" href="../assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        .sort-icon {
            display: inline-block;
            font-size: 0.8rem;
            margin-left: 4px;
            color: var(--primary-color);
            min-width: 12px;
        }

        .filter-icon {
            display: inline-flex;
            width: 16px;
            height: 16px;
            margin-left: 4px;
            cursor: pointer;
            opacity: 0.5;
            vertical-align: middle;
            color: var(--primary-color);
        }

        .filter-icon:hover,
        .filter-icon.active {
            opacity: 1;
        }

        .filter-popover {
            position: absolute;
            background: #1e293b;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            width: 200px;
            z-index: 100;
            padding: 0.5rem;
            display: none;
        }

        .filter-popover.visible {
            display: block;
        }

        .filter-search {
            width: 100%;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.5rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 0.25rem;
            font-size: 0.85rem;
        }

        .filter-options {
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 0.2rem;
            cursor: pointer;
        }

        .filter-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .filter-actions {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* Fix for select options in dark mode */
        select option {
            background-color: #1e293b;
            color: white;
        }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/db.js"></script>
    <script type="module">
        import { CSVExport } from '../assets/js/utils.js';
        window.CSVExport = CSVExport;
    </script>
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div style="text-align: center; margin-bottom: 1rem;">
                <img src="../assets/images/logo.png" alt="SSV" style="height: 150px;">
            </div>
            <h2 style="color: var(--secondary-color); margin-bottom: 0.2rem; text-align: center;">Event Tracker Admin
            </h2>
            <div class="sidebar-brand-sub"
                style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">by
                Gridify</div>
            <p style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-bottom: 2rem;">
                dedicated portal for Jobins KJ</p>

            <nav style="display: flex; flex-direction: column; gap: 1rem;">
                <a href="dashboard.html" class="btn btn-primary"
                    style="justify-content: flex-start; background: transparent; border: 1px solid var(--border-color);">
                    Dashboard
                </a>
                <a href="events.html" class="btn btn-primary"
                    style="justify-content: flex-start; background: transparent; border: 1px solid var(--border-color);">
                    Events
                </a>
                <a href="staff-data.html" class="btn btn-primary"
                    style="justify-content: flex-start; background: rgba(255,255,255,0.1); border:none;">
                    Update Staff Data
                </a>
                <a href="reports.html" class="btn btn-primary"
                    style="justify-content: flex-start; background: transparent; border: 1px solid var(--border-color);">
                    Reports
                </a>
                <a href="../user/dashboard.html" class="btn btn-primary"
                    style="justify-content: flex-start; background: transparent; border: 1px solid var(--border-color);">
                    User View
                </a>
            </nav>

            <div style="margin-top: auto;">
                <button onclick="AuthService.logout()" class="btn btn-danger" style="width: 100%;">Logout</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="content-area">
            <header class="flex justify-between items-center mb-4">
                <h1>Staff Data Management</h1>
                <div class="flex items-center gap-3">
                    <button onclick="openCreateStaffModal()" class="btn btn-primary">
                        <span style="margin-right:0.5rem;">+</span> Create Staff
                    </button>
                    <span class="status-badge status-urgent">Admin Access</span>
                </div>
            </header>

            <!-- Actions Card -->
            <div class="card mb-4"
                style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
                <h3>Bulk Update Staff</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                    Upload a CSV file to update or populate the staff directory. <br>
                    <strong>Format:</strong> Staff Name, Email, Department, Designation (Staff/HOD), HOD Email
                </p>
                <div class="flex gap-4 items-center">

                    <div style="position: relative; overflow: hidden; display: inline-block;">
                        <button class="btn btn-primary">Upload CSV</button>
                        <input type="file" id="csvFileInput" accept=".csv" onchange="handleFileUpload(this)"
                            style="font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer;">
                    </div>
                </div>
            </div>

            <!-- Staff Directory Table -->
            <div class="card animate-fade-in">
                <div class="flex justify-between items-center mb-2" style="flex-wrap: wrap; gap: 10px;">
                    <div class="flex items-center gap-4">
                        <h3>Staff Directory</h3>
                        <button onclick="clearAllFilters()" id="btnClearFilters" class="btn btn-danger btn-outline"
                            style="font-size: 0.75rem; padding: 2px 8px; display:none; border: 1px solid var(--border-color);">
                            Reset Filters
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="downloadFiltered()" class="btn btn-primary btn-outline"
                            style="font-size: 0.85rem; padding: 4px 12px; background: transparent; border: 1px solid var(--border-color);">
                            Export All
                        </button>
                        <button onclick="downloadSelected()" id="btnDownloadSelected"
                            class="btn btn-primary btn-outline"
                            style="font-size: 0.85rem; padding: 4px 12px; background: transparent; border: 1px solid var(--border-color);"
                            disabled>
                            Download Selected (0)
                        </button>
                        <span id="staffCount"
                            style="color: var(--text-secondary); font-size: 0.9rem; margin-left: 10px;">0 Staff</span>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; text-align: left; min-width: 600px;">
                        <thead>
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <th style="width: 40px; text-align: center; padding: 1rem;">
                                    <input type="checkbox" id="selectAllCheckbox"
                                        onchange="toggleSelectAll(this.checked)"
                                        style="accent-color: var(--primary-color); cursor: pointer; width: 16px; height: 16px;">
                                </th>
                                <th style="padding: 1rem; cursor: pointer; user-select: none;">
                                    <div style="display:flex; align-items:center; justify-content: space-between;"
                                        onclick="handleSort('name')">
                                        <span>Name <span id="sort-name" class="sort-icon"></span></span>
                                        <svg class="filter-icon"
                                            onclick="event.stopPropagation(); toggleFilter(event, 'name')"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
                                        </svg>
                                    </div>
                                </th>
                                <th style="padding: 1rem; cursor: pointer; user-select: none;">
                                    <div style="display:flex; align-items:center; justify-content: space-between;"
                                        onclick="handleSort('email')">
                                        <span>Email <span id="sort-email" class="sort-icon"></span></span>
                                        <svg class="filter-icon"
                                            onclick="event.stopPropagation(); toggleFilter(event, 'email')"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
                                        </svg>
                                    </div>
                                </th>
                                <th style="padding: 1rem; cursor: pointer; user-select: none;">
                                    <div style="display:flex; align-items:center; justify-content: space-between;"
                                        onclick="handleSort('department')">
                                        <span>Department <span id="sort-department" class="sort-icon"></span></span>
                                        <svg class="filter-icon"
                                            onclick="event.stopPropagation(); toggleFilter(event, 'department')"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
                                        </svg>
                                    </div>
                                </th>
                                <th style="padding: 1rem; cursor: pointer; user-select: none;">
                                    <div style="display:flex; align-items:center; justify-content: space-between;"
                                        onclick="handleSort('designation')">
                                        <span>Designation <span id="sort-designation" class="sort-icon"></span></span>
                                        <svg class="filter-icon"
                                            onclick="event.stopPropagation(); toggleFilter(event, 'designation')"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
                                        </svg>
                                    </div>
                                </th>
                                <th style="padding: 1rem; cursor: pointer; user-select: none;">
                                    <div style="display:flex; align-items:center; justify-content: space-between;"
                                        onclick="handleSort('hodEmail')">
                                        <span>HOD Email <span id="sort-hodEmail" class="sort-icon"></span></span>
                                        <svg class="filter-icon"
                                            onclick="event.stopPropagation(); toggleFilter(event, 'hodEmail')"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
                                        </svg>
                                    </div>
                                </th>
                                <th style="padding: 1rem;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <tr>
                                <td colspan="6" style="padding: 1rem; text-align: center;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Filter Popover -->
        <div id="filterPopover" class="filter-popover">
            <input type="text" id="filterSearch" class="filter-search" placeholder="Search..."
                oninput="filterOptions(this.value)">
            <div id="filterOptions" class="filter-options"></div>
            <div class="filter-actions">
                <button class="btn btn-primary btn-sm" style="font-size:0.7rem; padding: 0.2rem 0.5rem;"
                    onclick="applyColumnFilter()">Apply</button>
                <button class="btn btn-danger btn-sm" style="font-size:0.7rem; padding: 0.2rem 0.5rem;"
                    onclick="closeFilter()">Close</button>
            </div>
        </div>

    </div>

    <!-- Create Staff Modal -->
    <div class="modal-overlay" id="createStaffModal">
        <div class="modal-content" style="max-width: 500px; width: 95%;">
            <h3>Create New Staff Member</h3>
            <form id="createStaffForm" onsubmit="handleCreateStaff(event)">
                <div class="form-group mb-4" style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary);">Name</label>
                    <input type="text" id="newStaffName" class="form-control"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px;"
                        required>
                </div>
                <div class="form-group mb-4" style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary);">Email</label>
                    <input type="email" id="newStaffEmail" class="form-control"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px;"
                        required>
                </div>
                <div class="form-group mb-4" style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary);">Department</label>
                    <select id="newStaffDeptSelect" class="form-control"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px;"
                        onchange="handleDeptSelectChange()" required>
                        <option value="">Select Department</option>
                        <option value="NEW">+ Add New Department</option>
                    </select>
                    <input type="text" id="newStaffDeptInput" class="form-control"
                        placeholder="Enter new department name"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px; margin-top: 0.5rem; display: none;">
                </div>
                <div class="form-group mb-4" style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary);">Designation</label>
                    <select id="newStaffDesig" class="form-control"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px;"
                        onchange="toggleHODField()" required>
                        <option value="Staff">Staff</option>
                        <option value="HOD">HOD</option>
                    </select>
                </div>
                <div class="form-group mb-4" id="divHODEmail" style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary);">HOD Email</label>
                    <input type="email" id="newStaffHODEmail" class="form-control"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px;">
                </div>
                <div class="flex justify-end gap-4 mt-6" style="margin-top:1.5rem;">
                    <button type="button" onclick="closeCreateStaffModal()" class="btn btn-danger"
                        style="background: transparent; border: 1px solid var(--danger-color);">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Staff</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Staff Modal -->
    <div class="modal-overlay" id="editStaffModal">
        <div class="modal-content" style="max-width: 500px; width: 95%;">
            <h3>Edit Staff Member</h3>
            <form id="editStaffForm" onsubmit="handleEditStaff(event)">
                <input type="hidden" id="editStaffId">
                <div class="form-group mb-4" style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary);">Name</label>
                    <input type="text" id="editStaffName" class="form-control"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px;"
                        required>
                </div>
                <div class="form-group mb-4" style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary);">Email</label>
                    <input type="email" id="editStaffEmail" class="form-control"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px;"
                        required>
                </div>
                <div class="form-group mb-4" style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary);">Department</label>
                    <select id="editStaffDeptSelect" class="form-control"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px;"
                        onchange="handleEditDeptSelectChange()" required>
                        <option value="">Select Department</option>
                        <option value="NEW">+ Add New Department</option>
                    </select>
                    <input type="text" id="editStaffDeptInput" class="form-control"
                        placeholder="Enter new department name"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px; margin-top: 0.5rem; display: none;">
                </div>
                <div class="form-group mb-4" style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary);">Designation</label>
                    <select id="editStaffDesig" class="form-control"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px;"
                        onchange="toggleEditHODField()" required>
                        <option value="Staff">Staff</option>
                        <option value="HOD">HOD</option>
                    </select>
                </div>
                <div class="form-group mb-4" id="divEditHODEmail" style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; color:var(--text-secondary);">HOD Email</label>
                    <input type="email" id="editStaffHODEmail" class="form-control"
                        style="width:100%; padding:0.5rem; background:rgba(255,255,255,0.05); border:1px solid var(--border-color); color:white; border-radius:4px;">
                </div>
                <div class="flex justify-end gap-4 mt-6" style="margin-top:1.5rem;">
                    <button type="button" onclick="closeEditStaffModal()" class="btn btn-danger"
                        style="background: transparent; border: 1px solid var(--danger-color);">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Changes Review Modal -->
    <div class="modal-overlay" id="reviewModal">
        <div class="modal-content" style="max-width: 800px; width: 95%;">
            <h3>Review Changes</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Please review the changes detected from your CSV file.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <div class="card" style="padding: 0.5rem; text-align: center; border-color: var(--success-color);">
                    <h4 style="color: var(--success-color);">New</h4>
                    <span id="countNew" style="font-size: 1.5rem; font-weight: bold;">0</span>
                </div>
                <div class="card" style="padding: 0.5rem; text-align: center; border-color: var(--primary-color);">
                    <h4 style="color: var(--primary-color);">Updated</h4>
                    <span id="countUpdated" style="font-size: 1.5rem; font-weight: bold;">0</span>
                </div>
                <div class="card" style="padding: 0.5rem; text-align: center; border-color: var(--danger-color);">
                    <h4 style="color: var(--danger-color);">To Remove</h4>
                    <span id="countRemoved" style="font-size: 1.5rem; font-weight: bold;">0</span>
                </div>
            </div>

            <div
                style="max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <ul id="changeLog" style="list-style: none; padding: 0; font-size: 0.9rem;">
                    <!-- Log items -->
                </ul>
            </div>

            <div class="flex justify-end gap-4">
                <button onclick="closeReviewModal()" class="btn btn-danger"
                    style="background: transparent; border: 1px solid var(--danger-color);">Cancel</button>
                <button onclick="confirmChanges()" class="btn btn-primary">Approve & Update DB</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="customAlert" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 id="alertTitle">Alert</h3>
            <p id="alertMessage" style="margin-bottom: 1rem; color: var(--text-secondary);"></p>
            <button onclick="document.getElementById('customAlert').classList.remove('active')"
                class="btn btn-primary">OK</button>
        </div>
    </div>

    <script type="module">
        import { CSVExport } from '../assets/js/utils.js';

        // Make global for inline calls
        window.CSVExport = CSVExport;

        AuthService.requireRole('admin');

        let currentStaff = [];
        let displayedStaff = [];
        let activeFilters = {};
        let sortConfig = { key: null, direction: 'asc' };
        let currentFilterColumn = null;
        let pendingChanges = null;
        let selectedStaff = new Set();

        window.loadStaff = async function () {
            try {
                const staff = await DBService.getStaff();
                currentStaff = staff;
                processData();
            } catch (e) {
                console.error("Error loading staff", e);
            }
        };

        // --- Filter Logic ---
        window.toggleFilter = function (event, column) {
            const popover = document.getElementById('filterPopover');

            if (currentFilterColumn === column && popover.classList.contains('visible')) {
                closeFilter();
                return;
            }

            currentFilterColumn = column;
            const iconRect = event.target.getBoundingClientRect();
            let left = iconRect.left;
            let top = iconRect.bottom + window.scrollY + 5;

            if (left + 220 > window.innerWidth) {
                left = window.innerWidth - 230;
            }

            popover.style.left = `${left}px`;
            popover.style.top = `${top}px`;
            popover.classList.add('visible');

            renderFilterOptions(column);
        }

        window.closeFilter = function () {
            const popover = document.getElementById('filterPopover');
            if (popover) popover.classList.remove('visible');
            currentFilterColumn = null;
        }

        function renderFilterOptions(column) {
            const container = document.getElementById('filterOptions');
            const searchInput = document.getElementById('filterSearch');
            searchInput.value = '';
            container.innerHTML = '';

            const uniqueValues = new Set(currentStaff.map(s => s[column] || '(Empty)'));
            const sortedValues = Array.from(uniqueValues).sort();

            const isAllSelected = !activeFilters[column] || activeFilters[column].size === sortedValues.length;

            const divAll = document.createElement('label');
            divAll.className = 'filter-option';
            divAll.innerHTML = `
                <input type="checkbox" onchange="toggleFilterSelectAll(this.checked)" ${isAllSelected ? 'checked' : ''}>
                (Select All)
            `;
            container.appendChild(divAll);

            sortedValues.forEach(val => {
                const isChecked = !activeFilters[column] || activeFilters[column].has(val);
                const div = document.createElement('label');
                div.className = 'filter-option option-item';
                div.innerHTML = `
                    <input type="checkbox" value="${val}" onchange="checkFilterState()" ${isChecked ? 'checked' : ''}>
                    ${val}
                `;
                container.appendChild(div);
            });
            checkFilterState();
        }

        window.toggleFilterSelectAll = function (checked) {
            const checkboxes = document.querySelectorAll('.option-item input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
        }

        window.checkFilterState = function () {
            const checkboxes = Array.from(document.querySelectorAll('.option-item input[type="checkbox"]'));
            const allChecked = checkboxes.every(cb => cb.checked);
            const someChecked = checkboxes.some(cb => cb.checked);
            const selectAllCb = document.querySelector('.filter-option input[type="checkbox"]');
            if (selectAllCb) {
                selectAllCb.checked = allChecked;
                selectAllCb.indeterminate = !allChecked && someChecked;
            }
        }

        window.filterOptions = function (query) {
            const items = document.querySelectorAll('.option-item');
            const lowerQuery = query.toLowerCase();
            let hasMatch = false;
            items.forEach(item => {
                const text = item.textContent.trim().toLowerCase();
                if (text.includes(lowerQuery)) {
                    item.style.display = 'flex';
                    hasMatch = true;
                } else {
                    item.style.display = 'none';
                }
            });

            let noMatchMsg = document.getElementById('filterNoMatch');
            if (!noMatchMsg) {
                const container = document.getElementById('filterOptions');
                noMatchMsg = document.createElement('div');
                noMatchMsg.id = 'filterNoMatch';
                noMatchMsg.style.padding = '0.5rem';
                noMatchMsg.style.color = 'var(--text-secondary)';
                noMatchMsg.style.fontSize = '0.85rem';
                noMatchMsg.style.textAlign = 'center';
                noMatchMsg.textContent = 'No Matches';
                container.appendChild(noMatchMsg);
            }
            noMatchMsg.style.display = hasMatch ? 'none' : 'block';
        }

        window.applyColumnFilter = function () {
            if (!currentFilterColumn) return;

            const checkboxes = Array.from(document.querySelectorAll('.option-item input[type="checkbox"]'));
            const selectedValues = checkboxes.filter(cb => cb.checked).map(cb => cb.value);

            const allColumnValues = new Set(currentStaff.map(s => s[currentFilterColumn] || '(Empty)'));

            if (selectedValues.length === allColumnValues.size) {
                delete activeFilters[currentFilterColumn];
            } else {
                activeFilters[currentFilterColumn] = new Set(selectedValues);
            }

            closeFilter();
            processData();
        }

        window.clearAllFilters = function () {
            activeFilters = {};
            currentFilterColumn = null;
            closeFilter();
            processData();
        }

        // --- Selection Logic ---
        window.toggleSelectAll = function (checked) {
            if (checked) {
                displayedStaff.forEach(p => selectedStaff.add(p.id));
            } else {
                selectedStaff.clear();
            }
            renderStaff(displayedStaff);
            updateSelectionUI();
        }

        window.toggleStaffSelection = function (id, checked) {
            if (checked) {
                selectedStaff.add(id);
            } else {
                selectedStaff.delete(id);
            }
            updateSelectionUI();

            // Update Select All Checkbox state
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) {
                const allSelected = displayedStaff.length > 0 &&
                    displayedStaff.every(p => selectedStaff.has(p.id));
                selectAll.checked = allSelected;
                selectAll.indeterminate = !allSelected && selectedStaff.size > 0;
            }
        }

        function updateSelectionUI() {
            const btn = document.getElementById('btnDownloadSelected');
            if (btn) {
                btn.innerText = `Download Selected (${selectedStaff.size})`;
                btn.disabled = selectedStaff.size === 0;
            }
        }

        // --- Download Logic ---
        window.downloadFiltered = function () {
            if (!displayedStaff || displayedStaff.length === 0) {
                showAlert("Info", "No data to export.");
                return;
            }
            const dataToExport = formatStartForExport(displayedStaff);
            window.CSVExport.downloadCSV(dataToExport, `staff_export_filtered_${new Date().getTime()}.csv`);
        }

        window.downloadSelected = function () {
            if (selectedStaff.size === 0) return;
            const selectedItems = currentStaff.filter(p => selectedStaff.has(p.id));
            const dataToExport = formatStartForExport(selectedItems);
            window.CSVExport.downloadCSV(dataToExport, `staff_export_selected_${new Date().getTime()}.csv`);
        }

        function formatStartForExport(list) {
            return list.map(p => ({
                'Name': p.name,
                'Email': p.email,
                'Department': p.department,
                'Designation': p.designation,
                'HOD Email': p.hodEmail || '',
                'ID': p.id
            }));
        }

        // --- Processing & Sorting ---
        window.processData = function () {
            // 1. Filter
            displayedStaff = currentStaff.filter(person => {
                const matchesValidFilters = Object.keys(activeFilters).every(key => {
                    let val = person[key] || '(Empty)';
                    return activeFilters[key].has(val);
                });
                return matchesValidFilters;
            });

            // 2. Sort
            applySort();

            // 3. Render
            renderStaff(displayedStaff);
            updateFilterIcons();
            updateSelectionUI();

            // Update Select All checkbox for current view
            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) {
                const allVisibleSelected = displayedStaff.length > 0 && displayedStaff.every(p => selectedStaff.has(p.id));
                selectAll.checked = allVisibleSelected;
            }
        }

        function updateFilterIcons() {
            document.querySelectorAll('.filter-icon').forEach(icon => {
                icon.style.opacity = '0.5';
                icon.style.color = 'currentColor';
            });

            const keys = ['name', 'email', 'department', 'designation', 'hodEmail'];
            const icons = document.querySelectorAll('.filter-icon');
            let hasActiveFilters = false;

            keys.forEach((key, index) => {
                if (activeFilters[key] && activeFilters[key].size > 0) {
                    if (icons[index]) {
                        icons[index].style.opacity = '1';
                        icons[index].style.color = 'var(--primary-color)';
                    }
                    hasActiveFilters = true;
                }
            });

            const btnReset = document.getElementById('btnClearFilters');
            if (btnReset) btnReset.style.display = hasActiveFilters ? 'inline-block' : 'none';
        }

        window.handleSort = function (key) {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = 'asc';
            }
            processData();
        }

        function applySort() {
            if (!sortConfig.key) return;

            displayedStaff.sort((a, b) => {
                let valA = a[sortConfig.key] || '';
                let valB = b[sortConfig.key] || '';

                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();

                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });

            updateSortIcons();
        }

        function updateSortIcons() {
            ['name', 'email', 'department', 'designation', 'hodEmail'].forEach(key => {
                const icon = document.getElementById(`sort-${key}`);
                if (icon) icon.textContent = '';
            });

            if (sortConfig.key) {
                const icon = document.getElementById(`sort-${sortConfig.key}`);
                if (icon) {
                    icon.textContent = sortConfig.direction === 'asc' ? ' ▲' : ' ▼';
                }
            }
        }

        function renderStaff(staff) {
            const tbody = document.getElementById('staffTableBody');
            const countEl = document.getElementById('staffCount');
            if (countEl) countEl.textContent = `${staff.length} Staff Members`;

            tbody.innerHTML = '';

            if (staff.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding: 1rem; text-align: center;">No matching records found.</td></tr>';
                return;
            }

            staff.forEach(person => {
                const isSelected = selectedStaff.has(person.id);
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid var(--border-color)';

                tr.innerHTML = `
                    <td style="padding: 1rem; text-align: center;">
                        <input type="checkbox" onchange="toggleStaffSelection('${person.id}', this.checked)" 
                        style="accent-color: var(--primary-color); cursor: pointer; width: 16px; height: 16px;"
                        ${isSelected ? 'checked' : ''}>
                    </td>
                    <td style="padding: 1rem;">${person.name}</td>
                    <td style="padding: 1rem;">${person.email}</td>
                    <td style="padding: 1rem;">${person.department}</td>
                    <td style="padding: 1rem;"><span class="status-badge ${person.designation === 'HOD' ? 'status-urgent' : 'status-pending'}">${person.designation}</span></td>
                    <td style="padding: 1rem;">${person.hodEmail || '-'}</td>
                    <td style="padding: 1rem;">
                        <button onclick="openEditStaffModal('${person.id}')" class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-right: 0.5rem; background: var(--primary-color); border: none;">Edit</button>
                        <button onclick="deleteStaff('${person.id}')" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">Remove</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.deleteStaff = async function (id) {
            if (confirm("Are you sure you want to remove this staff member?")) {
                const res = await DBService.deleteStaff(id);
                if (res.success) {
                    loadStaff();
                    showAlert("Success", "Staff removed.");
                } else {
                    showAlert("Error", res.message);
                }
            }
        }

        // --- CSV Upload Logic ---



        window.handleFileUpload = function (input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                processCSV(text);
                input.value = ''; // Reset
            };
            reader.readAsText(file);
        }

        function processCSV(csvText) {
            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length < 2) {
                return showAlert("Error", "CSV is empty or invalid.");
            }

            const dataRows = lines.slice(1);
            const uploadedStaff = [];

            dataRows.forEach(row => {
                const cols = row.split(',').map(c => c.trim());
                if (cols.length >= 4) {
                    uploadedStaff.push({
                        name: cols[0],
                        email: cols[1],
                        department: cols[2],
                        designation: cols[3],
                        hodEmail: cols[4] || ''
                    });
                }
            });

            analyzeChanges(uploadedStaff);
        }

        function analyzeChanges(uploaded) {
            const toAdd = [];
            const toUpdate = [];
            const toDeleteIds = [];

            const mapCurrent = new Map(currentStaff.map(s => [s.email.toLowerCase(), s]));
            const mapUploaded = new Map(uploaded.map(s => [s.email.toLowerCase(), s]));

            uploaded.forEach(u => {
                const existing = mapCurrent.get(u.email.toLowerCase());
                if (existing) {
                    if (existing.name !== u.name ||
                        existing.department !== u.department ||
                        existing.designation !== u.designation ||
                        existing.hodEmail !== u.hodEmail) {
                        toUpdate.push({ id: existing.id, ...u });
                    }
                } else {
                    toAdd.push(u);
                }
            });

            currentStaff.forEach(c => {
                if (!mapUploaded.has(c.email.toLowerCase())) {
                    toDeleteIds.push(c.id);
                }
            });

            pendingChanges = { toAdd, toUpdate, toDeleteIds };
            showReviewModal(pendingChanges);
        }

        window.showReviewModal = function (changes) {
            document.getElementById('countNew').innerText = changes.toAdd.length;
            document.getElementById('countUpdated').innerText = changes.toUpdate.length;
            document.getElementById('countRemoved').innerText = changes.toDeleteIds.length;

            const list = document.getElementById('changeLog');
            list.innerHTML = '';

            const appendLog = (msg, color) => {
                const li = document.createElement('li');
                li.style.color = color;
                li.style.marginBottom = '0.2rem';
                li.innerText = msg;
                list.appendChild(li);
            };

            changes.toAdd.forEach(x => appendLog(`[NEW] ${x.name} (${x.email})`, 'var(--success-color)'));
            changes.toUpdate.forEach(x => appendLog(`[UPDATE] ${x.name} (${x.email})`, 'var(--primary-color)'));

            if (changes.toDeleteIds.length > 0) {
                const idMap = new Map(currentStaff.map(s => [s.id, s]));
                changes.toDeleteIds.forEach(id => {
                    const s = idMap.get(id);
                    if (s) appendLog(`[REMOVE] ${s.name} (${s.email})`, 'var(--danger-color)');
                });
            }

            if (changes.toAdd.length === 0 && changes.toUpdate.length === 0 && changes.toDeleteIds.length === 0) {
                appendLog("No changes detected.", "var(--text-secondary)");
            }

            document.getElementById('reviewModal').classList.add('active');
        }

        window.closeReviewModal = function () {
            document.getElementById('reviewModal').classList.remove('active');
            pendingChanges = null;
        }

        window.confirmChanges = async function () {
            if (!pendingChanges) return;

            const { toAdd, toUpdate, toDeleteIds } = pendingChanges;

            if (toAdd.length === 0 && toUpdate.length === 0 && toDeleteIds.length === 0) {
                closeReviewModal();
                return;
            }

            const res = await DBService.batchUpdateStaff(toAdd, toUpdate, toDeleteIds);

            if (res.success) {
                showAlert("Success", "Database updated successfully.");
                closeReviewModal();
                loadStaff();
            } else {
                showAlert("Error", "Update failed: " + res.message);
            }
        }

        window.showAlert = function (title, msg) {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('customAlert').classList.add('active');
        }

        // --- Create Staff Manual Logic ---
        window.openCreateStaffModal = function () {
            document.getElementById('createStaffForm').reset();
            document.getElementById('newStaffDeptInput').style.display = 'none';
            document.getElementById('newStaffDeptInput').required = false;

            // Populate Departments Dropdown
            const deptSelect = document.getElementById('newStaffDeptSelect');
            // Keep first two options: "Select Department" and "+ Add New"
            const depts = new Set(currentStaff.map(s => s.department).filter(d => d));
            const sortedDepts = Array.from(depts).sort();

            // Clear existing dynamic options
            while (deptSelect.options.length > 2) {
                deptSelect.remove(2);
            }

            sortedDepts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                deptSelect.appendChild(opt);
            });

            if (window.toggleHODField) window.toggleHODField();
            document.getElementById('createStaffModal').classList.add('active');
        }

        window.handleDeptSelectChange = function () {
            const deptSelect = document.getElementById('newStaffDeptSelect');
            const deptInput = document.getElementById('newStaffDeptInput');
            const selectedVal = deptSelect.value;

            if (selectedVal === 'NEW') {
                deptInput.style.display = 'block';
                deptInput.required = true;
                document.getElementById('newStaffHODEmail').value = '';
            } else {
                deptInput.style.display = 'none';
                deptInput.required = false;

                if (selectedVal) {
                    // Try to find HOD email for this department
                    const hodUser = currentStaff.find(s => s.department === selectedVal && s.designation === 'HOD');
                    if (hodUser) {
                        document.getElementById('newStaffHODEmail').value = hodUser.email;
                    } else {
                        const peer = currentStaff.find(s => s.department === selectedVal && s.hodEmail);
                        if (peer) {
                            document.getElementById('newStaffHODEmail').value = peer.hodEmail;
                        } else {
                            document.getElementById('newStaffHODEmail').value = '';
                        }
                    }
                } else {
                    document.getElementById('newStaffHODEmail').value = '';
                }
            }
        }

        window.closeCreateStaffModal = function () {
            document.getElementById('createStaffModal').classList.remove('active');
        }

        window.toggleHODField = function () {
            const desig = document.getElementById('newStaffDesig').value;
            const div = document.getElementById('divHODEmail');
            const input = document.getElementById('newStaffHODEmail');
            if (desig === 'HOD') {
                div.style.opacity = '0.5';
                div.style.pointerEvents = 'none';
                input.value = '';
                input.required = false;
            } else {
                div.style.opacity = '1';
                div.style.pointerEvents = 'auto';
                input.required = true;
            }
        }

        window.handleCreateStaff = async function (e) {
            e.preventDefault();

            const name = document.getElementById('newStaffName').value.trim();
            const email = document.getElementById('newStaffEmail').value.trim();

            const deptSelect = document.getElementById('newStaffDeptSelect').value;
            const deptInput = document.getElementById('newStaffDeptInput').value.trim();
            const department = deptSelect === 'NEW' ? deptInput : deptSelect;

            const designation = document.getElementById('newStaffDesig').value;
            let hodEmail = document.getElementById('newStaffHODEmail').value.trim();

            if (designation === 'HOD') hodEmail = '';

            if (!name || !email || !department) {
                showAlert("Error", "Please fill in all required fields.");
                return;
            }

            const staffData = {
                name,
                email,
                department,
                designation,
                hodEmail
            };

            const exists = currentStaff.some(s => s.email.toLowerCase() === email.toLowerCase());
            if (exists) {
                showAlert("Error", "A staff member with this email already exists.");
                return;
            }

            const res = await DBService.addStaff(staffData);

            if (res.success) {
                closeCreateStaffModal();
                showAlert("Success", "Staff member created successfully.");
                loadStaff();
            } else {
                showAlert("Error", "Failed to create staff: " + res.message);
            }
        }

        // --- Edit Staff Logic ---
        window.openEditStaffModal = function (id) {
            const person = currentStaff.find(s => s.id === id);
            if (!person) return;

            document.getElementById('editStaffId').value = person.id;
            document.getElementById('editStaffName').value = person.name;
            document.getElementById('editStaffEmail').value = person.email;
            document.getElementById('editStaffDesig').value = person.designation;
            document.getElementById('editStaffHODEmail').value = person.hodEmail || '';

            // Populate Departments
            const deptSelect = document.getElementById('editStaffDeptSelect');
            const depts = new Set(currentStaff.map(s => s.department).filter(d => d));
            const sortedDepts = Array.from(depts).sort();

            while (deptSelect.options.length > 2) {
                deptSelect.remove(2);
            }

            sortedDepts.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                deptSelect.appendChild(opt);
            });

            deptSelect.value = person.department;
            document.getElementById('editStaffDeptInput').style.display = 'none';
            document.getElementById('editStaffDeptInput').required = false;

            window.toggleEditHODField();
            document.getElementById('editStaffModal').classList.add('active');
        }

        window.handleEditStaff = async function (e) {
            e.preventDefault();
            const id = document.getElementById('editStaffId').value;
            const name = document.getElementById('editStaffName').value.trim();
            const email = document.getElementById('editStaffEmail').value.trim();

            const deptSelect = document.getElementById('editStaffDeptSelect').value;
            const deptInput = document.getElementById('editStaffDeptInput').value.trim();
            const department = deptSelect === 'NEW' ? deptInput : deptSelect;

            const designation = document.getElementById('editStaffDesig').value;
            let hodEmail = document.getElementById('editStaffHODEmail').value.trim();

            if (designation === 'HOD') hodEmail = '';

            const data = { name, email, department, designation, hodEmail };

            const res = await DBService.updateStaff(id, data);
            if (res.success) {
                closeEditStaffModal();
                showAlert("Success", "Staff updated.");
                loadStaff();
            } else {
                showAlert("Error", res.message);
            }
        }

        window.closeEditStaffModal = function () {
            document.getElementById('editStaffModal').classList.remove('active');
        }

        window.handleEditDeptSelectChange = function () {
            const deptSelect = document.getElementById('editStaffDeptSelect');
            const deptInput = document.getElementById('editStaffDeptInput');
            if (deptSelect.value === 'NEW') {
                deptInput.style.display = 'block';
                deptInput.required = true;
            } else {
                deptInput.style.display = 'none';
                deptInput.required = false;
            }
        }

        window.toggleEditHODField = function () {
            const desig = document.getElementById('editStaffDesig').value;
            const div = document.getElementById('divEditHODEmail');
            const input = document.getElementById('editStaffHODEmail');
            if (desig === 'HOD') {
                div.style.opacity = '0.5';
                div.style.pointerEvents = 'none';
                input.value = '';
                input.required = false;
            } else {
                div.style.opacity = '1';
                div.style.pointerEvents = 'auto';
                input.required = true;
            }
        }

        // Init
        loadStaff();
    </script>
</body>

</html>