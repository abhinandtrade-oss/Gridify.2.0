<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Event Tracker By Gridify</title>
    <link rel="icon" href="../assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="../assets/css/style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/db.js"></script>
    <script type="module">
        import { CSVExport, formatDate } from '../assets/js/utils.js';
        window.CSVExport = CSVExport;
        window.formatDate = formatDate;
    </script>
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div style="text-align: center; margin-bottom: 1rem;">
                <img src="../assets/images/logo.png" alt="SSV" style="height: 150px;">
            </div>
            <h2 style="color: var(--primary-color); margin-bottom: 0.2rem; text-align: center;">Event Tracker</h2>
            <div class="sidebar-brand-sub"
                style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">by
                Gridify</div>
            <p style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-bottom: 2rem;">
                dedicated portal for Jobins KJ</p>

            <nav>
                <a href="dashboard.html" class="active">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="create-event.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                    </svg>
                    <span>Create</span>
                </a>
                <button onclick="openProfile()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    <span>Profile</span>
                </button>
            </nav>

            <div style="margin-top: auto;">
                <button onclick="AuthService.logout()" class="btn btn-danger" style="width: 100%;">Logout</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="content-area">
            <header class="flex justify-between items-center mb-4">
                <h1>My Dashboard</h1>
                <div class="flex gap-4">
                    <button onclick="exportCSV()" class="btn btn-primary btn-outline"
                        style="background: transparent; border: 1px solid var(--border-color);">Export
                        CSV</button>
                    <a href="create-event.html" class="btn btn-primary desktop-only">New Event</a>
                    <button onclick="AuthService.logout()" class="btn btn-danger mobile-only">Logout</button>
                </div>
            </header>

            <div class="card animate-fade-in">
                <!-- Mobile List View -->
                <div id="mobileEventList" class="mobile-event-list"></div>

                <!-- Desktop Table View -->
                <div class="desktop-table">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead>
                            <tr>
                                <th>Event Name</th>
                                <th>Date</th>
                                <th>Coordinator</th>
                                <th>Status</th>
                                <th>Reminders</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="eventTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Processing Request...</div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <h3>User Profile</h3>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="profileEmail" class="form-control" disabled>
                <div id="verificationSection" style="margin-top: 0.5rem;">
                    <!-- Populated by JS -->
                </div>
            </div>

            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid var(--border-color);">

            <h4>Change Password</h4>
            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
            </div>
            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password">
            </div>

            <div class="flex justify-between" style="margin-top: 1.5rem;">
                <button onclick="document.getElementById('profileModal').classList.remove('active')"
                    class="btn btn-danger"
                    style="border: 1px solid var(--border-color); color: var(--text-secondary);">Close</button>
                <button onclick="updateProfile()" class="btn btn-primary">Save Changes</button>
            </div>

            <div class="mobile-only"
                style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <button onclick="AuthService.logout()" class="btn btn-danger" style="width: 100%;">Logout</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="customAlert" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 id="alertTitle">Alert</h3>
            <p id="alertMessage" style="margin-bottom: 1rem; color: var(--text-secondary);"></p>
            <button onclick="document.getElementById('customAlert').classList.remove('active')"
                class="btn btn-primary">OK</button>
        </div>
    </div>

    <footer class="footer">
        powered by <a href="https://www.gridify.in" target="_blank">GRIDIFY</a>
    </footer>

    <script type="module">
        import { CSVExport, formatDate } from '../assets/js/utils.js';

        // Expose to window for inline calls
        window.formatDate = formatDate;

        AuthService.requireRole('user');

        let currentEvents = [];

        // Global Loading Functions
        window.showLoading = (text = "Processing Request...") => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.querySelector('.loading-text').textContent = text;
                overlay.classList.add('active');
            }
        };

        window.hideLoading = () => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.remove('active');
        };

        function renderEvents(events) {
            const tbody = document.getElementById('eventTableBody');
            const mobileList = document.getElementById('mobileEventList');

            if (!tbody || !mobileList) return;

            tbody.innerHTML = '';
            mobileList.innerHTML = '';

            if (events.length === 0) {
                const emptyHTML = `
                    <div class="empty-state" onclick="window.location.href='create-event.html'" style="cursor:pointer;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                        <p>No events yet.</p>
                        <span style="color: var(--primary-color); margin-top: 0.5rem; display: inline-block;">Tap to create your first event</span>
                    </div>
                `;
                tbody.innerHTML = '<tr><td colspan="6">' + emptyHTML + '</td></tr>';
                mobileList.innerHTML = emptyHTML;
                return;
            }

            events.forEach(event => {
                let statusClass = 'status-pending';
                if (event.status === 'Report Received') statusClass = 'status-received';
                if (event.status === 'Completed') statusClass = 'status-received';
                if (event.status === 'Under Review') statusClass = 'status-info';
                if (event.status === 'Changes Requested') statusClass = 'status-urgent';

                if (String(event.status).includes('Reminder 3')) statusClass = 'status-urgent';

                // Desktop Row
                const tr = document.createElement('tr');
                tr.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON') return;
                    window.location.href = `event-detail.html?id=${event.id}`;
                };
                tr.style.cursor = 'pointer';

                tr.innerHTML = `
                    <td>${event.eventName}</td>
                    <td>${formatDate(event.eventDate)}</td>
                    <td>${event.coordinatorName}</td>
                    <td><span class="status-badge ${statusClass}">${event.status}</span></td>
                    <td>${event.reminderCount} / 3</td>
                    <td>
                        <button onclick="window.location.href='event-detail.html?id=${event.id}'" class="btn btn-primary">View</button>
                    </td>
                `;
                tbody.appendChild(tr);

                // Mobile Card
                const card = document.createElement('div');
                card.className = 'event-card-mobile';
                card.onclick = () => window.location.href = `event-detail.html?id=${event.id}`;

                card.innerHTML = `
                    <div class="event-card-header">
                        <span class="event-name">${event.eventName}</span>
                        <span class="status-badge ${statusClass}" style="font-size: 0.7rem;">${event.status}</span>
                    </div>
                    <div class="event-coordinator">
                        By ${event.coordinatorName}
                    </div>
                    <div class="event-date">
                        <svg style="width:14px;height:14px;fill:currentColor;opacity:0.7" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
                        ${formatDate(event.eventDate)}
                    </div>
                `;
                mobileList.appendChild(card);
            });
        }

        function subscribeEvents() {
            window.showLoading("Loading Events...");
            // Returns unsubscribe function
            DBService.subscribeToEvents((events) => {
                currentEvents = events;
                renderEvents(events);
                window.hideLoading();
            }, (error) => {
                console.error("Subscription error:", error);
                window.hideLoading(); // Still hide loading on error so app doesn't freeze
            });
        }

        window.exportCSV = () => {
            CSVExport.downloadCSV(currentEvents, 'SSV_Events_Export.csv');
        };

        window.showAlert = (title, msg) => {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('customAlert').classList.add('active');
        };

        // Profile Functions
        window.openProfile = () => {
            const user = firebase.auth().currentUser;
            if (!user) return;

            document.getElementById('profileEmail').value = user.email;

            const verifyDiv = document.getElementById('verificationSection');
            if (user.emailVerified) {
                verifyDiv.innerHTML = '<span class="status-badge status-received">Email Verified</span>';
            } else {
                verifyDiv.innerHTML = `
                    <span class="status-badge status-urgent">Not Verified</span>
                    <button onclick="sendVerification()" class="btn btn-primary" style="margin-top:0.5rem; font-size:0.8rem; padding: 0.3rem 0.6rem;">Send Verification Email</button>
                `;
            }

            document.getElementById('profileModal').classList.add('active');
        };

        window.sendVerification = async () => {
            const user = firebase.auth().currentUser;
            if (user) {
                try {
                    await user.sendEmailVerification();
                    window.showAlert("Success", "Verification email sent! Please check your inbox.");
                } catch (error) {
                    window.showAlert("Error", error.message);
                }
            }
        };

        window.updateProfile = async () => {
            const user = firebase.auth().currentUser;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmNewPassword').value;

            if (newPass || confirmPass) {
                if (newPass !== confirmPass) {
                    return window.showAlert("Error", "Passwords do not match.");
                }
                if (newPass.length < 6) {
                    return window.showAlert("Error", "Password must be at least 6 characters.");
                }

                try {
                    await user.updatePassword(newPass);
                    window.showAlert("Success", "Password updated successfully.");
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } catch (error) {
                    window.showAlert("Error", "Failed to update password: " + error.message);
                    // Often requires re-login if sensitive
                }
            } else {
                window.showAlert("Info", "No changes made (password field empty).");
            }
        };

        const unsubscribe = subscribeEvents();
        window.addEventListener('beforeunload', () => {
            if (unsubscribe && typeof unsubscribe === 'function') unsubscribe();
        });

        // Check for hash to open profile
        if (window.location.hash === '#profile') {
            setTimeout(openProfile, 500); // Small delay to ensuring loading
            // Clear hash to avoid reopening on refresh
            history.replaceState(null, null, ' ');
        }
    </script>
</body>

</html>