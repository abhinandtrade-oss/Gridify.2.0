<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Event Tracker By Gridify</title>
    <link rel="icon" href="../assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="../assets/css/style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/db.js"></script>
    <script type="module">
        import { CSVExport, formatDate } from '../assets/js/utils.js';
        window.CSVExport = CSVExport;
        window.formatDate = formatDate;
    </script>
    <style>
        .sort-icon {
            display: inline-block;
            font-size: 0.8rem;
            margin-left: 4px;
            color: var(--primary-color);
            min-width: 12px;
        }

        input[type="checkbox"] {
            accent-color: var(--primary-color);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .toolbar-card label {
            color: var(--text-secondary);
        }

        /* Filter Styles */
        .filter-icon {
            display: inline-flex;
            width: 16px;
            height: 16px;
            margin-left: 4px;
            cursor: pointer;
            opacity: 0.5;
            vertical-align: middle;
            color: var(--primary-color);
        }

        .filter-icon:hover,
        .filter-icon.active {
            opacity: 1;
        }

        .filter-popover {
            position: absolute;
            background: #1e293b;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            width: 200px;
            z-index: 100;
            padding: 0.5rem;
            display: none;
        }

        .filter-popover.visible {
            display: block;
        }

        .filter-search {
            width: 100%;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.5rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 0.25rem;
            font-size: 0.85rem;
        }

        .filter-options {
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 0.2rem;
            cursor: pointer;
        }

        .filter-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .filter-actions {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
    </style>
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div style="text-align: left; padding-left: 0.75rem; margin-bottom: 2rem;">
                <img src="../assets/images/logo.png" alt="Gridify"
                    style="height: 32px; display: block; margin-bottom: 1rem;">
                <h2
                    style="color: var(--text-primary); margin: 0; font-size: 1.2rem; letter-spacing: 0.05em; text-transform: uppercase; font-weight: 700;">
                    Event Tracker</h2>
                <div style="color: var(--text-secondary); font-size: 0.8rem; opacity: 0.7;">dedicated portal for <span
                        style="color: var(--primary-color);">Jobins KJ</span></div>
            </div>

            <nav>
                <a href="dashboard.html" class="active">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="events.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5z" />
                    </svg>
                    <span>Events</span>
                </a>
                <a href="create-event.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                    </svg>
                    <span>Create</span>
                </a>
                <button onclick="openProfile()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    <span>Profile</span>
                </button>
            </nav>

            <div style="margin-top: auto; padding: 0.75rem;">
                <button onclick="AuthService.logout()" class="btn btn-danger"
                    style="width: 100%; border-radius: 0.5rem; font-size: 0.85rem; padding: 0.5rem;">Logout</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="content-area">
            <header class="flex justify-between items-center mb-8" style="flex-wrap: wrap; gap: 1.5rem;">
                <div>
                    <h1 id="welcomeText"
                        style="font-size: 2.2rem; margin: 0; background: linear-gradient(90deg, #fff, #cbd5e1); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                        Welcome back!</h1>
                    <p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 1.1rem; opacity: 0.8;">Manage
                        your events and reports effectively.</p>
                </div>
                <div class="desktop-only">
                    <a href="create-event.html" class="btn btn-primary"
                        style="padding: 0.8rem 2rem; border-radius: 0.75rem; font-size: 1rem; box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);">New
                        Event</a>
                </div>
            </header>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
                <div class="stat-card animate-fade-in" style="border-bottom: 4px solid var(--primary-color);">
                    <div class="stat-icon" style="background: rgba(99, 102, 241, 0.1); color: var(--primary-color);">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Total Events</div>
                        <div id="statTotalEvents" class="stat-value">0</div>
                    </div>
                </div>
                <div class="stat-card animate-fade-in"
                    style="border-bottom: 4px solid var(--warning-color); animation-delay: 0.1s;">
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: var(--warning-color);">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Pending Reports</div>
                        <div id="statPendingReports" class="stat-value">0</div>
                    </div>
                </div>
                <div class="stat-card animate-fade-in"
                    style="border-bottom: 4px solid var(--success-color); animation-delay: 0.2s;">
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: var(--success-color);">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
                        </svg>
                    </div>
                    <div class="stat-content">
                        <div class="stat-label">Completed</div>
                        <div id="statCompleted" class="stat-value">0</div>
                    </div>
                </div>
            </div>

            <!-- Shortcut Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                <a href="create-event.html" class="shortcut-card animate-fade-in" style="animation-delay: 0.3s;">
                    <div class="icon-box" style="background: rgba(99, 102, 241, 0.1); color: var(--primary-color);">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                    </div>
                    <div class="shortcut-info">
                        <h3>Create New Event</h3>
                        <p>Launch a new event and notify coordinators.</p>
                    </div>
                    <span class="arrow">&rarr;</span>
                </a>

                <a href="events.html" class="shortcut-card animate-fade-in" style="animation-delay: 0.4s;">
                    <div class="icon-box" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M4 14h4v-10h-4v10zm6 0h4v-18h-4v18zm6 0h4v-6h-4v6zm-16 7h20v-2h-20v2z" />
                        </svg>
                    </div>
                    <div class="shortcut-info">
                        <h3>View All Events</h3>
                        <p>Track statuses and manage active reports.</p>
                    </div>
                    <span class="arrow">&rarr;</span>
                </a>

                <a href="#" onclick="openProfile(); return false;" class="shortcut-card animate-fade-in"
                    style="animation-delay: 0.5s;">
                    <div class="icon-box" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                    </div>
                    <div class="shortcut-info">
                        <h3>My Profile</h3>
                        <p>Manage your account and security settings.</p>
                    </div>
                    <span class="arrow">&rarr;</span>
                </a>

                <a href="#" onclick="openSupportForm(); return false;" class="shortcut-card animate-fade-in"
                    style="animation-delay: 0.6s;">
                    <div class="icon-box" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z" />
                        </svg>
                    </div>
                    <div class="shortcut-info">
                        <h3>Help & Support</h3>
                        <p>Get technical assistance for the portal.</p>
                    </div>
                    <span class="arrow">&rarr;</span>
                </a>
            </div>

            <style>
                .shortcut-card {
                    display: flex;
                    align-items: center;
                    background: var(--card-bg);
                    border: 1px solid var(--border-color);
                    border-radius: 1rem;
                    padding: 1.5rem;
                    text-decoration: none;
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;
                }

                .shortcut-card:hover {
                    border-color: var(--primary-color);
                    transform: translateY(-4px);
                    background: rgba(108, 93, 211, 0.05);
                }

                .icon-box {
                    width: 56px;
                    height: 56px;
                    border-radius: 0.75rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 1.5rem;
                    flex-shrink: 0;
                }

                .icon-box svg {
                    width: 28px;
                    height: 28px;
                }

                .shortcut-info h3 {
                    margin: 0 0 0.25rem 0;
                    color: var(--text-primary);
                    font-size: 1.1rem;
                }

                .shortcut-info p {
                    margin: 0;
                    color: var(--text-secondary);
                    font-size: 0.85rem;
                    line-height: 1.4;
                }

                .shortcut-card .arrow {
                    margin-left: auto;
                    font-size: 1.5rem;
                    color: var(--text-secondary);
                    transition: transform 0.3s ease;
                }

                .shortcut-card:hover .arrow {
                    transform: translateX(5px);
                    color: var(--primary-color);
                }

                .grid {
                    display: grid;
                }

                .grid-cols-1 {
                    grid-template-columns: repeat(1, minmax(0, 1fr));
                }

                @media (min-width: 768px) {
                    .md\:grid-cols-2 {
                        grid-template-columns: repeat(2, minmax(0, 1fr));
                    }

                    .md\:grid-cols-3 {
                        grid-template-columns: repeat(3, minmax(0, 1fr));
                    }
                }

                .gap-6 {
                    gap: 1.5rem;
                }

                .stat-card {
                    background: var(--card-bg);
                    backdrop-filter: var(--glass-blur);
                    border: 1px solid var(--border-color);
                    border-radius: 1.25rem;
                    padding: 1.5rem;
                    display: flex;
                    align-items: center;
                    gap: 1.5rem;
                    transition: all 0.3s ease;
                }

                .stat-card:hover {
                    transform: translateY(-5px);
                    background: rgba(255, 255, 255, 0.03);
                }

                .stat-icon {
                    width: 60px;
                    height: 60px;
                    border-radius: 1rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-shrink: 0;
                }

                .stat-icon svg {
                    width: 30px;
                    height: 30px;
                }

                .stat-content {
                    display: flex;
                    flex-direction: column;
                }

                .stat-label {
                    font-size: 0.9rem;
                    color: var(--text-secondary);
                    margin-bottom: 0.25rem;
                    font-weight: 500;
                }

                .stat-value {
                    font-size: 2rem;
                    font-weight: 700;
                    color: var(--text-primary);
                    line-height: 1;
                }

                @media (max-width: 768px) {
                    .stat-card {
                        padding: 1.25rem;
                        gap: 1rem;
                    }

                    .stat-icon {
                        width: 48px;
                        height: 48px;
                    }

                    .stat-icon svg {
                        width: 24px;
                        height: 24px;
                    }

                    .stat-value {
                        font-size: 1.5rem;
                    }

                    .content-area header {
                        text-align: center;
                        justify-content: center;
                    }

                    .shortcut-card {
                        padding: 1.25rem;
                    }

                    .shortcut-info h3 {
                        font-size: 1rem;
                    }
                }
            </style>
        </main>
    </div>

    <!-- Support Modal -->
    <div class="modal-overlay" id="supportModal">
        <div class="modal-content">
            <h3>Technical Support</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Please describe the issue you are facing in
                detail.
            </p>

            <form id="supportForm">
                <div class="form-group">
                    <label class="form-label">Subject</label>
                    <input type="text" id="supportSubject" class="form-control" placeholder="Brief summary of the issue"
                        required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="supportDescription" class="form-control" rows="5"
                        placeholder="Please provide steps to reproduce or clear details of the problem..."
                        required></textarea>
                </div>

                <div class="flex justify-between" style="margin-top: 1.5rem;">
                    <button type="button" onclick="document.getElementById('supportModal').classList.remove('active')"
                        class="btn btn-danger"
                        style="border: 1px solid var(--border-color); color: var(--text-secondary);">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="modern-spinner">
                <div class="spinner-arc outer"></div>
                <div class="spinner-arc inner"></div>
            </div>
            <div class="loading-text">Syncing with cloud...</div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <h3>User Profile</h3>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="profileEmail" class="form-control" disabled>
                <div id="verificationSection" style="margin-top: 0.5rem;">
                    <!-- Populated by JS -->
                </div>
            </div>

            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid var(--border-color);">

            <h4>Change Password</h4>
            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
            </div>
            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password">
            </div>

            <div class="flex justify-between" style="margin-top: 1.5rem;">
                <button onclick="document.getElementById('profileModal').classList.remove('active')"
                    class="btn btn-danger"
                    style="border: 1px solid var(--border-color); color: var(--text-secondary);">Close</button>
                <button onclick="updateProfile()" class="btn btn-primary">Save Changes</button>
            </div>

            <div class="mobile-only"
                style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <button onclick="AuthService.logout()" class="btn btn-danger" style="width: 100%;">Logout</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="customAlert" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 id="alertTitle">Alert</h3>
            <p id="alertMessage" style="margin-bottom: 1rem; color: var(--text-secondary);"></p>
            <button onclick="document.getElementById('customAlert').classList.remove('active')"
                class="btn btn-primary">OK</button>
        </div>
    </div>

    <footer class="footer">
        powered by <a href="https://www.gridify.in" target="_blank">GRIDIFY</a>
    </footer>

    <script type="module">
        import { formatDate, EmailService } from '../assets/js/utils.js';

        // Expose to window for inline calls
        window.formatDate = formatDate;

        AuthService.requireRole('user');

        let rawEvents = [];

        // Global Loading Functions
        window.showLoading = (text = "Processing Request...") => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.querySelector('.loading-text').textContent = text;
                overlay.classList.add('active');
            }
        };

        window.hideLoading = () => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.remove('active');
        };

        // Support Functions
        window.openSupportForm = () => {
            window.showAlert("Help & Support", "If you are unable to send emails, you may have reached your daily limit. Please try again tomorrow. The daily email limit is 95");
            document.getElementById('supportModal').classList.add('active');
        };

        document.getElementById('supportForm').onsubmit = async (e) => {
            e.preventDefault();
            const subject = document.getElementById('supportSubject').value;
            const description = document.getElementById('supportDescription').value;
            const user = firebase.auth().currentUser;

            window.showLoading("Sending Support Request...");

            try {
                const scriptUrl = await DBService.getScriptUrl();
                const emailService = new EmailService(scriptUrl);

                const emailData = {
                    to: 'help@gridify.in',
                    subject: `[Support Request] ${subject}`,
                    heading: 'Technical Support Request',
                    message: `
                        <p><strong>From:</strong> ${user ? user.email : 'Unknown User'}</p>
                        <p><strong>Subject:</strong> ${subject}</p>
                        <p><strong>Description:</strong></p>
                        <div style="padding: 1rem; background: #f4f7fe; border-radius: 8px; margin-top: 10px;">
                            ${description.replace(/\n/g, '<br>')}
                        </div>
                    `,
                    buttonText: 'Solve Issue',
                    buttonLink: '#'
                };

                const res = await emailService.sendEmail(emailData);
                if (res.success) {
                    window.showAlert("Success", "Your support request has been sent. Our team will get back to you soon.");
                    document.getElementById('supportModal').classList.remove('active');
                    document.getElementById('supportForm').reset();
                } else {
                    window.showAlert("Error", "Failed to send request: " + res.message);
                }
            } catch (error) {
                window.showAlert("Error", "An unexpected error occurred: " + error.message);
            } finally {
                window.hideLoading();
            }
        };

        function updateStats(events) {
            const total = events.length;
            const completed = events.filter(e => e.status === 'Completed').length;
            const pending = total - completed;

            document.getElementById('statTotalEvents').textContent = total;
            document.getElementById('statPendingReports').textContent = pending;
            document.getElementById('statCompleted').textContent = completed;

            // Update welcome text if user is logged in
            const user = firebase.auth().currentUser;
            if (user) {
                document.getElementById('welcomeText').textContent = `Welcome back, ${user.email.split('@')[0]}!`;
            }
        }

        function subscribeEvents() {
            window.showLoading("Syncing Dashboard...");
            return DBService.subscribeToEvents((events) => {
                rawEvents = events;
                updateStats(events);
                window.hideLoading();
            }, (error) => {
                console.error("Subscription error:", error);
                window.hideLoading();
            });
        }

        window.showAlert = (title, msg) => {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('customAlert').classList.add('active');
        };

        // Profile Functions
        window.openProfile = () => {
            const user = firebase.auth().currentUser;
            if (!user) return;

            document.getElementById('profileEmail').value = user.email;

            const verifyDiv = document.getElementById('verificationSection');
            if (user.emailVerified) {
                verifyDiv.innerHTML = '<span class="status-badge status-received">Email Verified</span>';
            } else {
                verifyDiv.innerHTML = `
                    <span class="status-badge status-urgent">Not Verified</span>
                    <button onclick="sendVerification()" class="btn btn-primary" style="margin-top:0.5rem; font-size:0.8rem; padding: 0.3rem 0.6rem;">Send Verification Email</button>
                `;
            }

            document.getElementById('profileModal').classList.add('active');
        };

        window.sendVerification = async () => {
            const user = firebase.auth().currentUser;
            if (user) {
                try {
                    await user.sendEmailVerification();
                    window.showAlert("Success", "Verification email sent! Please check your inbox.");
                } catch (error) {
                    window.showAlert("Error", error.message);
                }
            }
        };

        window.updateProfile = async () => {
            const user = firebase.auth().currentUser;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmNewPassword').value;

            if (newPass || confirmPass) {
                if (newPass !== confirmPass) {
                    return window.showAlert("Error", "Passwords do not match.");
                }
                if (newPass.length < 6) {
                    return window.showAlert("Error", "Password must be at least 6 characters.");
                }

                try {
                    await user.updatePassword(newPass);
                    window.showAlert("Success", "Password updated successfully.");
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } catch (error) {
                    window.showAlert("Error", "Failed to update password: " + error.message);
                }
            } else {
                window.showAlert("Info", "No changes made (password field empty).");
            }
        };

        const unsubscribe = subscribeEvents();
        window.addEventListener('beforeunload', () => {
            if (unsubscribe && typeof unsubscribe === 'function') unsubscribe();
        });

        // Check for hash to open profile
        if (window.location.hash === '#profile') {
            setTimeout(openProfile, 500);
            history.replaceState(null, null, ' ');
        }
    </script>
</body>

</html>