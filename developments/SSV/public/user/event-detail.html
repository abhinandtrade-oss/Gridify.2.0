<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - Event Tracker By Gridify</title>
    <link rel="icon" href="../assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="../assets/css/style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/db.js"></script>
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div style="text-align: center; margin-bottom: 1rem;">
                <img src="../assets/images/logo.png" alt="SSV" style="height: 150px;">
            </div>
            <h2 style="color: var(--primary-color); margin-bottom: 0.2rem; text-align: center;">Event Tracker</h2>
            <div class="sidebar-brand-sub"
                style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">by
                Gridify</div>
            <p style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-bottom: 2rem;">
                dedicated portal for Jobins KJ</p>

            <nav>
                <a href="dashboard.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="events.html" class="active">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="width: 20px; height: 20px; margin-right: 12px; opacity: 0.8;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span>Events</span>
                </a>
                <a href="create-event.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z" />
                    </svg>
                    <span>Create</span>
                </a>
                <button onclick="window.location.href='dashboard.html#profile'">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    <span>Profile</span>
                </button>
            </nav>

            <div style="margin-top: auto;">
                <button onclick="AuthService.logout()" class="btn btn-danger" style="width: 100%;">Logout</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="content-area">
            <header class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-4">
                    <a href="events.html" class="btn btn-primary"
                        style="background:transparent; border:1px solid var(--border-color);">&larr; Back</a>
                    <h1>Event Details</h1>
                </div>
                <button onclick="openEditModal()" id="btnEditEvent" class="btn btn-primary">Edit Event</button>
            </header>

            <div id="loading" style="text-align:center; padding:2rem;">Loading...</div>

            <div id="content" style="display:none;">
                <div class="card mb-4 animate-fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="d_eventName">Event Name</h2>
                        <span id="d_status" class="status-badge status-pending">Status</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 2rem;">
                        <div>
                            <p class="form-label">Coordinators & Status</p>
                            <div id="coordinatorsList"
                                style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                                <!-- Populated by JS -->
                            </div>

                            <p class="form-label">Department</p>
                            <p id="d_dept" class="mb-4"></p>

                            <p class="form-label">Created By</p>
                            <p id="d_createdBy" class="mb-4" style="color: var(--text-secondary);"></p>
                        </div>
                        <div>
                            <p class="form-label">Event Date</p>
                            <p id="d_date" class="mb-4"></p>

                            <p class="form-label">Details</p>
                            <p id="d_details" class="mb-4" style="color: var(--text-secondary);"></p>

                            <p class="form-label">Global Reminders Sent</p>
                            <p id="d_reminders" class="mb-4 font-bold text-xl"></p>
                        </div>
                    </div>
                </div>

                <div class="card animate-fade-in">
                    <h3>Actions</h3>
                    <div class="flex gap-4">
                        <button id="btnMarkReview" onclick="markUnderReview()" class="btn btn-primary"
                            style="background: var(--info-color); display:none;">Mark Under Review</button>

                        <button id="btnRequestChanges" onclick="openChangesModal()" class="btn btn-primary"
                            style="background: var(--warning-color); display:none;">Request Changes</button>

                        <button id="btnReopen" onclick="reopenEvent()" class="btn btn-primary"
                            style="background: var(--warning-color); display:none;">Re-open Event</button>

                        <button id="btnMarkCompleted" onclick="markCompleted()" class="btn btn-primary"
                            style="background: var(--success-color); display:none;">Mark Completed</button>

                        <button id="btnSendReminder" onclick="initiateReminder()" class="btn btn-primary"
                            style="background: var(--warning-color);">Send Reminder</button>
                    </div>

                    <div style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                        <button id="btnDeleteEvent" onclick="deleteEvent()" class="btn btn-danger"
                            style="display:none;">Delete Event</button>
                    </div>

                    <p id="actionMsg" style="margin-top:1rem; color: var(--text-secondary);"></p>
                </div>
            </div>
        </main>
    </div>

    <!-- Changes Requested Modal -->
    <div class="modal-overlay" id="changesModal">
        <div class="modal-content">
            <h3>Request Changes</h3>
            <p style="color:var(--text-secondary); margin-bottom:1rem;">Notify the coordinator that the report format is
                incorrect.</p>

            <div class="form-group">
                <label class="form-label">Required Changes</label>
                <textarea id="changesMsg" class="form-control" rows="4"
                    placeholder="Describe the format issues or missing information..."></textarea>
            </div>

            <div class="form-group flex items-center gap-2" style="margin-bottom:1rem;">
                <input type="checkbox" id="changesEscalate" onchange="toggleChangesHodInput()">
                <label for="changesEscalate" style="margin:0; cursor:pointer;">Escalate to HOD (CC)</label>
            </div>

            <div class="form-group" id="changesHodInputGroup" style="display:none;">
                <label class="form-label">HOD Email Address</label>
                <input type="email" id="changesHodEmail" class="form-control" readonly placeholder="Auto-fetched"
                    style="background-color: rgba(255,255,255,0.05); cursor: not-allowed;">
            </div>

            <div class="flex justify-between">
                <button type="button" onclick="closeChangesModal()" class="btn btn-danger">Cancel</button>
                <button type="button" id="confirmChangesBtn" onclick="sendChangesEmail()" class="btn btn-primary">Send
                    Email</button>
                <input type="hidden" id="targetCoordEmail">
            </div>
        </div>
    </div>

    <!-- Reminder Modal -->
    <div class="modal-overlay" id="reminderModal">
        <div class="modal-content">
            <h3>Send Reminder</h3>

            <div class="form-group">
                <label class="form-label">Custom Message (Optional)</label>
                <textarea id="remCustomMsg" class="form-control" rows="3"
                    placeholder="Add a note to the email..."></textarea>
            </div>

            <div class="form-group flex items-center gap-2" style="margin-bottom:1rem;">
                <input type="checkbox" id="remEscalate" onchange="toggleHodInput()">
                <label for="remEscalate" style="margin:0; cursor:pointer;">Escalate to HOD (CC)</label>
            </div>

            <div class="form-group" id="hodInputGroup" style="display:none;">
                <label class="form-label">HOD Email Address</label>
                <input type="email" id="hodEmail" class="form-control" readonly placeholder="Auto-fetched"
                    style="background-color: rgba(255,255,255,0.05); cursor: not-allowed;">
            </div>

            <div class="flex justify-between">
                <button type="button" onclick="closeReminderModal()" class="btn btn-danger">Cancel</button>
                <button type="button" onclick="sendReminder()" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <h3>Edit Event Details</h3>
            <form id="editEventForm">
                <div class="form-group">
                    <label class="form-label">Event Name</label>
                    <input type="text" id="editEventName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Coordinator Name</label>
                    <input type="text" id="editCoordName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Coordinator Email</label>
                    <input type="email" id="editCoordEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Department</label>
                    <input type="text" id="editDept" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Event Date</label>
                    <input type="date" id="editDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Details</label>
                    <textarea id="editDetails" class="form-control" rows="3"></textarea>
                </div>
                <div class="flex justify-between">
                    <button type="button" onclick="closeEditModal()" class="btn btn-danger">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="modern-spinner">
                <div class="spinner-arc outer"></div>
                <div class="spinner-arc inner"></div>
            </div>
            <div class="loading-text">Syncing with cloud...</div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="customAlert" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 id="alertTitle">Alert</h3>
            <p id="alertMessage" style="margin-bottom: 1rem; color: var(--text-secondary);"></p>
            <button onclick="document.getElementById('customAlert').classList.remove('active')"
                class="btn btn-primary">OK</button>
        </div>
    </div>

    <footer class="footer">
        powered by <a href="https://www.gridify.in" target="_blank">GRIDIFY</a>
    </footer>

    <script type="module">
        import { EmailService, formatDate } from '../assets/js/utils.js';

        AuthService.requireRole('user');

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        let currentEvent = null;
        let remTarget = null; // null for global, {email, name} for individual

        async function loadEvent() {
            if (!eventId) {
                window.location.href = 'events.html';
                return;
            }

            const event = await DBService.getEventById(eventId);
            if (!event) {
                document.getElementById('loading').innerText = 'Event not found.';
                return;
            }

            currentEvent = event;
            renderEvent();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        // Toggle Changes HOD Input
        window.toggleChangesHodInput = () => {
            const checked = document.getElementById('changesEscalate').checked;
            document.getElementById('changesHodInputGroup').style.display = checked ? 'block' : 'none';
        }

        function renderEvent() {
            document.getElementById('d_eventName').innerText = currentEvent.eventName;
            renderCoordinators();
            document.getElementById('d_dept').innerText = currentEvent.departmentName;
            document.getElementById('d_createdBy').innerText = currentEvent.createdBy || 'Unknown';
            document.getElementById('d_date').innerText = formatDate(currentEvent.eventDate);
            document.getElementById('d_details').innerText = currentEvent.eventDetails;
            document.getElementById('d_reminders').innerText = currentEvent.reminderCount;

            const badge = document.getElementById('d_status');
            badge.innerText = currentEvent.status;

            if (currentEvent.status === 'Completed') {
                badge.className = 'status-badge status-received';
                badge.innerText = "Completed";
                hideAllActions();
                document.getElementById('btnReopen').style.display = 'inline-block';
                document.getElementById('btnEditEvent').style.display = 'none';
            } else {
                const emails = (currentEvent.coordinatorEmail || "").split(', ').filter(e => e);
                const statuses = currentEvent.coordinatorStatuses || {};
                const allDone = emails.every(e => statuses[e] === 'Received' || statuses[e] === 'Ignored');
                const hasActive = emails.some(e => statuses[e] !== 'Ignored');

                if (allDone && hasActive) {
                    badge.className = 'status-badge status-info';
                    badge.innerText = "All Reports Received";
                    document.getElementById('btnMarkCompleted').style.display = 'inline-block';
                    document.getElementById('btnMarkReview').style.display = 'none';
                } else if (!hasActive && emails.length > 0) {
                    badge.className = 'status-badge status-secondary';
                    badge.innerText = "No Reports Required";
                    document.getElementById('btnMarkCompleted').style.display = 'inline-block';
                } else if (Object.values(statuses).includes('Under Review')) {
                    badge.className = 'status-badge status-info';
                    badge.innerText = "Under Review";
                    document.getElementById('btnMarkCompleted').style.display = 'none';
                } else {
                    badge.className = 'status-badge status-pending';
                    badge.innerText = currentEvent.status || "Pending";
                    document.getElementById('btnMarkCompleted').style.display = 'none';
                }
                document.getElementById('btnEditEvent').style.display = 'block';
            }

            checkDeletePermission();
        }

        function renderCoordinators() {
            const names = (currentEvent.coordinatorName || "").split(', ');
            const emails = (currentEvent.coordinatorEmail || "").split(', ');
            const statuses = currentEvent.coordinatorStatuses || {};

            let html = '';
            emails.forEach((email, idx) => {
                if (!email) return;
                const name = names[idx] || email;
                const status = statuses[email] || 'Pending';

                let statusClass = 'status-pending';
                if (status === 'Received') statusClass = 'status-received';
                if (status === 'Under Review') statusClass = 'status-info';
                if (status === 'Changes Requested') statusClass = 'status-urgent';
                if (status === 'Ignored') statusClass = 'status-secondary';

                html += `
                    <div class="coordinator-card p-3" style="background: rgba(255,255,255,0.03); border: 1px solid var(--border-color); border-radius: 0.75rem; margin-bottom: 0.5rem;">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 style="margin:0; font-size: 1rem;">${name}</h4>
                                <p style="margin:0; font-size: 0.8rem; color: var(--text-secondary);">${email}</p>
                            </div>
                            <span class="status-badge ${statusClass}" style="font-size: 0.65rem;">
                                ${status.toUpperCase()}
                            </span>
                        </div>
                        <div class="flex gap-2 flex-wrap">
                            ${status === 'Pending' || status === 'Changes Requested' ? `
                                <button onclick="initiateReminder('${email}', '${name}')" class="btn btn-primary" style="font-size: 0.7rem; padding: 0.3rem 0.6rem; height: auto; background: var(--warning-color);">Remind</button>
                                <button onclick="updateIndividualStatus('${email}', 'Under Review')" class="btn btn-primary" style="font-size: 0.7rem; padding: 0.3rem 0.6rem; height: auto; background: var(--info-color);">Mark Review</button>
                                <button onclick="updateIndividualStatus('${email}', 'Ignored')" class="btn btn-danger" style="font-size: 0.7rem; padding: 0.3rem 0.6rem; height: auto; border: 1px solid var(--border-color); background:transparent;">Ignore</button>
                            ` : ''}
                            ${status === 'Under Review' ? `
                                <button onclick="openIndividualChangesModal('${email}', '${name}')" class="btn btn-primary" style="font-size: 0.7rem; padding: 0.3rem 0.6rem; height: auto; background: var(--secondary-color);">Request Changes</button>
                                <button onclick="markCoordinatorReceived('${email}', '${name}')" class="btn btn-primary" style="font-size: 0.7rem; padding: 0.3rem 0.6rem; height: auto; background: var(--success-color);">Mark Received</button>
                            ` : ''}
                            ${status === 'Received' ? `
                                <button onclick="updateIndividualStatus('${email}', 'Under Review')" class="btn btn-danger" style="font-size: 0.7rem; padding: 0.3rem 0.6rem; height: auto; border: 1px solid var(--danger-color); background:transparent;">Unmark Received</button>
                            ` : ''}
                            ${status === 'Ignored' ? `
                                <button onclick="updateIndividualStatus('${email}', 'Pending')" class="btn btn-primary" style="font-size: 0.7rem; padding: 0.3rem 0.6rem; height: auto; background: var(--info-color);">Activate</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            document.getElementById('coordinatorsList').innerHTML = html || '<p>No coordinators</p>';
        }

        window.updateIndividualStatus = async (email, status) => {
            document.getElementById('loadingOverlay').classList.add('active');
            let statuses = currentEvent.coordinatorStatuses || {};
            statuses[email] = status;
            await DBService.updateEvent(currentEvent.id, { coordinatorStatuses: statuses });
            await loadEvent();
            document.getElementById('loadingOverlay').classList.remove('active');
        };

        window.openIndividualChangesModal = (email, name) => {
            document.getElementById('targetCoordEmail').value = email;
            document.getElementById('confirmChangesBtn').onclick = () => sendIndividualChangesEmail(email, name);
            openChangesModal();
        };

        window.sendIndividualChangesEmail = async (email, name) => {
            const msg = document.getElementById('changesMsg').value;
            if (!msg) return showAlert("Error", "Please enter a message.");

            document.getElementById('loadingOverlay').classList.add('active');
            closeChangesModal();

            const isEscalation = document.getElementById('changesEscalate').checked;
            let cc = "";
            let subject = `Action Required: Report Issue - ${currentEvent.eventName}`;

            if (isEscalation) {
                cc = document.getElementById('changesHodEmail').value;
                subject = `[URGENT] ESCALATION: Report Issue - ${currentEvent.eventName}`;
            }

            const scriptUrl = await DBService.getScriptUrl();
            const emailService = new EmailService(scriptUrl);

            const res = await emailService.sendEmail({
                emailType: 'CHANGES_REQUESTED',
                to: email,
                cc: cc,
                subject: subject,
                body: `
                    <p>Dear ${name} ,</p>
                    <p>We reviewed your report for the event (<b>${currentEvent.eventName}</b>) conducted on <b>${formatDate(currentEvent.eventDate)}</b> and some changes are required.</p>
                    <div style="background:#fee2e2; padding:15px; border-radius:4px; margin:15px 0;">
                        <strong>Feedback:</strong><br>${msg.replace(/\n/g, '<br>')}
                    </div>
                    <p>Please update the report and re-submit in EMBASE.</p>
                    <p>Thank you for your cooperation.</p>
                    <p>Warm regards,<br>IQAC</p>
                `,
                priority: 'HIGH'
            });

            if (res.success || res.status === 'success') {
                let statuses = currentEvent.coordinatorStatuses || {};
                statuses[email] = 'Changes Requested';
                await DBService.updateEvent(currentEvent.id, { coordinatorStatuses: statuses });
                await loadEvent();
                showAlert("Success", "Individual changes requested.");
            } else {
                showAlert("Error", "Email failed.");
            }
            document.getElementById('loadingOverlay').classList.remove('active');
        };

        window.sendIndividualReminder = async (email, name) => {
            // Deprecated: now handled by initiateReminder + sendReminder modal
        };

        window.markCoordinatorReceived = async (email, name) => {
            if (!confirm(`Mark report as received from ${name}?`)) return;

            document.getElementById('loadingOverlay').classList.add('active');

            const scriptUrl = await DBService.getScriptUrl();
            const emailService = new EmailService(scriptUrl);
            await emailService.sendEmail({
                emailType: 'REPORT_RECEIVED',
                to: email,
                subject: `Report Received: ${currentEvent.eventName}`,
                body: `
                    <p>Dear ${name} ,</p>
                    <p>We have received your report for the event (<b>${currentEvent.eventName}</b>) conducted on <b>${formatDate(currentEvent.eventDate)}</b>. Thank you!</p>
                    <p>Warm regards,<br>IQAC</p>
                `,
                priority: 'NORMAL'
            });

            let statuses = currentEvent.coordinatorStatuses || {};
            statuses[email] = 'Received';

            await DBService.updateEvent(currentEvent.id, { coordinatorStatuses: statuses });
            await loadEvent();
            document.getElementById('loadingOverlay').classList.remove('active');
        };

        function hideAllActions() {
            document.getElementById('btnMarkReview').style.display = 'none';
            document.getElementById('btnSendReminder').style.display = 'none';
            document.getElementById('btnRequestChanges').style.display = 'none';
            document.getElementById('btnMarkCompleted').style.display = 'none';
            document.getElementById('btnReopen').style.display = 'none';
        }

        function checkDeletePermission() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const profile = await AuthService.getUserProfile(user.uid);
                    const isCreator = currentEvent.createdBy === user.email;
                    const isAdmin = profile && profile.role === 'admin';

                    if (isCreator || isAdmin) {
                        document.getElementById('btnDeleteEvent').style.display = 'inline-block';
                    }
                }
            });
        }

        window.deleteEvent = async () => {
            if (!confirm("Are you sure you want to permanently delete this event? This action cannot be undone.")) return;

            document.getElementById('loadingOverlay').classList.add('active');
            const res = await DBService.deleteEvent(currentEvent.id);
            document.getElementById('loadingOverlay').classList.remove('active');

            if (res.success) {
                alert("Event deleted.");
                window.location.href = 'events.html';
            } else {
                showAlert("Error", "Failed to delete: " + res.message);
            }
        };

        window.initiateReminder = async (email = null, name = null) => {
            remTarget = email ? { email, name } : null;
            document.getElementById('reminderModal').classList.add('active');

            const title = document.getElementById('reminderModal').querySelector('h3');
            title.innerText = remTarget ? `Send Reminder: ${name}` : 'Send Global Reminder';

            // Auto check if > 2 rems, but allow user to change
            if (currentEvent.reminderCount >= 2) {
                document.getElementById('remEscalate').checked = true;
                toggleHodInput();
            } else {
                document.getElementById('remEscalate').checked = false;
                toggleHodInput();
            }
            document.getElementById('remCustomMsg').value = '';

            // Automatically fetch HOD email
            let hodEmail = currentEvent.hodEmail || '';
            if (!hodEmail && currentEvent.departmentName) {
                // Fallback: try to fetch manually from staff if not in event doc
                const depts = currentEvent.departmentName.split(', ');
                const staff = await DBService.getStaff();
                const hodEmails = [];
                depts.forEach(d => {
                    const hod = staff.find(s => s.department === d && s.designation === 'HOD');
                    if (hod) hodEmails.push(hod.email);
                });
                hodEmail = Array.from(new Set(hodEmails)).join(', ');
            }

            if (hodEmail) {
                document.getElementById('hodEmail').value = hodEmail;
            } else {
                // Load saved HOD Email if exists (last resort)
                const savedHod = localStorage.getItem('hodEmail_pref');
                if (savedHod) {
                    document.getElementById('hodEmail').value = savedHod;
                }
            }
        };

        window.closeReminderModal = () => {
            document.getElementById('reminderModal').classList.remove('active');
        };

        window.toggleHodInput = () => {
            const checked = document.getElementById('remEscalate').checked;
            document.getElementById('hodInputGroup').style.display = checked ? 'block' : 'none';
        }

        window.sendReminder = async () => {
            document.getElementById('loadingOverlay').classList.add('active');
            closeReminderModal();

            const isEscalation = document.getElementById('remEscalate').checked;
            const customMsg = document.getElementById('remCustomMsg').value;

            let hodEmail = "";
            if (isEscalation) {
                hodEmail = document.getElementById('hodEmail').value;
                if (!hodEmail) {
                    showAlert("Error", "HOD Email is required for escalation.");
                    document.getElementById('loadingOverlay').classList.remove('active');
                    return;
                }
                // Save preference
                localStorage.setItem('hodEmail_pref', hodEmail);
            }

            const scriptUrl = await DBService.getScriptUrl();
            const emailService = new EmailService(scriptUrl);
            const nextCount = currentEvent.reminderCount + 1;
            const formattedDate = formatDate(currentEvent.eventDate);

            let targetEmail = remTarget ? remTarget.email : currentEvent.coordinatorEmail;
            let targetName = remTarget ? remTarget.name : currentEvent.coordinatorName;

            let subject = `Reminder -${nextCount} : Submission of Event Report & Photos (${currentEvent.eventName}) conducted on (${formattedDate})`;
            let priority = 'NORMAL';
            let cc = "";

            let baseBody = `
                <p>Dear ${targetName} ,</p>
                <p>This is a gentle reminder regarding the submission of the report and photos for the event (<b>${currentEvent.eventName}</b>) conducted on <b>${formattedDate}</b>.</p>
                <p>We kindly request you to share the detailed event report is updated in the prescribed format under the Events menu in EMBASE.</p>
            `;

            if (isEscalation) {
                priority = 'HIGH';
                cc = hodEmail;
                subject = ` ESCALATION: Submission of Event Report & Photos (${currentEvent.eventName})`;
                baseBody = `
                    <h3 style="color:red;">Escalation Notice</h3>
                    <p>Dear ${targetName} ,</p>
                    <p>We still have not received the report or photos for the event (<b>${currentEvent.eventName}</b>) conducted on <b>${formattedDate}</b>.</p>
                    <p>This matter has been escalated to your HOD (${hodEmail}).</p>
                 `;
            }

            if (customMsg && customMsg.trim() !== '') {
                baseBody += `<div style="background:#fef3c7; padding:15px; border-left:4px solid #f59e0b; margin:15px 0;">
                    ${customMsg.replace(/\n/g, '<br>')}
                </div>`;
            }

            baseBody += `
                <p>Thank you for your cooperation.</p>
                <p>Warm regards,<br>IQAC</p>
            `;

            const res = await emailService.sendEmail({
                emailType: 'REMINDER',
                to: targetEmail,
                cc: cc,
                subject: subject,
                body: baseBody,
                priority: priority
            });

            if (res.success || res.status === 'success') {
                // Update DB
                let statusText = isEscalation ? `Reminder ${nextCount} Sent (Escalated)` : `Reminder ${nextCount} Sent`;
                if (remTarget) statusText = `Reminder Sent to ${targetName}`;

                await DBService.updateEvent(currentEvent.id, {
                    reminderCount: nextCount,
                    status: statusText
                });
                // Reload
                await loadEvent();
                showAlert("Success", "Reminder sent successfully.");
            } else {
                showAlert("Error", "Failed to send email. Check configs.");
            }

            document.getElementById('loadingOverlay').classList.remove('active');
        };

        // Edit Modal Functions
        window.openEditModal = () => {
            document.getElementById('editEventName').value = currentEvent.eventName;
            document.getElementById('editCoordName').value = currentEvent.coordinatorName;
            document.getElementById('editCoordEmail').value = currentEvent.coordinatorEmail;
            document.getElementById('editDept').value = currentEvent.departmentName;
            // Date format YYYY-MM-DD
            const d = new Date(currentEvent.eventDate);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            document.getElementById('editDate').value = `${yyyy}-${mm}-${dd}`;

            document.getElementById('editDetails').value = currentEvent.eventDetails || '';

            document.getElementById('editModal').classList.add('active');
        };

        window.closeEditModal = () => {
            document.getElementById('editModal').classList.remove('active');
        };

        document.getElementById('editEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loadingOverlay').classList.add('active');

            const updates = {
                eventName: document.getElementById('editEventName').value,
                coordinatorName: document.getElementById('editCoordName').value,
                coordinatorEmail: document.getElementById('editCoordEmail').value,
                departmentName: document.getElementById('editDept').value,
                eventDate: new Date(document.getElementById('editDate').value).toISOString(),
                eventDetails: document.getElementById('editDetails').value
            };

            const res = await DBService.updateEvent(currentEvent.id, updates);
            document.getElementById('loadingOverlay').classList.remove('active');

            if (res.success) {
                closeEditModal();
                showAlert("Success", "Event updated.");
                loadEvent();
            } else {
                showAlert("Error", res.message);
            }
        });

        window.markUnderReview = async () => {
            if (!confirm("Confirm report received? This will mark status as 'Under Review'.")) return;

            document.getElementById('loadingOverlay').classList.add('active');
            await handleStatusUpdate('Under Review', { success: true });
        };

        window.openChangesModal = () => {
            document.getElementById('changesModal').classList.add('active');
            // Reset modal
            document.getElementById('changesMsg').value = '';
            document.getElementById('changesEscalate').checked = false;
            document.getElementById('changesHodInputGroup').style.display = 'none';

            // Load saved HOD Email if exists (user convenience)
            const savedHod = localStorage.getItem('hodEmail_pref');
            if (savedHod) {
                document.getElementById('changesHodEmail').value = savedHod;
            }
        };

        window.closeChangesModal = () => {
            document.getElementById('changesModal').classList.remove('active');
            // Reset modal listeners
            document.getElementById('confirmChangesBtn').onclick = sendChangesEmail;
        };

        window.sendChangesEmail = async () => {
            const msg = document.getElementById('changesMsg').value;
            if (!msg) return showAlert("Error", "Please enter a message.");

            document.getElementById('loadingOverlay').classList.add('active');
            closeChangesModal();

            const isEscalation = document.getElementById('changesEscalate').checked;
            let hodEmail = "";
            if (isEscalation) {
                hodEmail = document.getElementById('changesHodEmail').value;
                if (!hodEmail) {
                    showAlert("Error", "HOD Email is required for escalation.");
                    document.getElementById('loadingOverlay').classList.remove('active');
                    return;
                }
                localStorage.setItem('hodEmail_pref', hodEmail);
            }

            const scriptUrl = await DBService.getScriptUrl();
            const emailService = new EmailService(scriptUrl);

            let subject = `Action Required: Report Format Issue - ${currentEvent.eventName}`;
            let cc = "";
            let priority = 'HIGH';

            let body = `
                <p>Dear ${currentEvent.coordinatorName} ,</p>
                <p>We reviewed your report for the event (<b>${currentEvent.eventName}</b>) conducted on <b>${formatDate(currentEvent.eventDate)}</b>.</p>
            `;

            if (isEscalation) {
                cc = hodEmail;
                subject = `[URGENT/ESCALATION] Action Required: Report Issue - ${currentEvent.eventName}`;
                body += `<p style="color:red; font-weight:bold;">This matter has been escalated to your HOD (${hodEmail}).</p>`;
            }

            body += `
                <div style="background:#fee2e2; color:#b91c1c; padding:15px; border-radius:4px; margin:15px 0;">
                    <strong>Action Required:</strong><br>
                    ${msg.replace(/\n/g, '<br>')}
                </div>
                <p>Please update the report and re-submit in EMBASE.</p>
                <p>Thank you for your cooperation.</p>
                <p>Warm regards,<br>IQAC</p>
            `;

            const res = await emailService.sendEmail({
                emailType: 'CHANGES_REQUESTED',
                to: currentEvent.coordinatorEmail,
                cc: cc,
                subject: subject,
                body: body,
                priority: priority
            });

            await handleStatusUpdate('Changes Requested', res);
        };

        window.reopenEvent = async () => {
            if (!confirm("Re-open this event? Status will be set to 'Under Review', allowing you to Request Changes again.")) return;

            document.getElementById('loadingOverlay').classList.add('active');
            // Simply update status back to Under Review so admins can act on it
            const res = { success: true }; // No email needed necessarily, or maybe notify user? Assuming silent re-open for admin work.
            await handleStatusUpdate('Under Review', res);
        };

        window.markCompleted = async () => {
            if (!confirm("Mark this event as fully Completed? This will close the event.")) return;

            document.getElementById('loadingOverlay').classList.add('active');
            const scriptUrl = await DBService.getScriptUrl();
            const emailService = new EmailService(scriptUrl);

            const res = await emailService.sendEmail({
                emailType: 'COMPLETED',
                to: currentEvent.coordinatorEmail,
                subject: `Event Completed: ${currentEvent.eventName}`,
                body: `
                    <p>Dear ${currentEvent.coordinatorName} ,</p>
                    <p>The report for the event (<b>${currentEvent.eventName}</b>) conducted on <b>${formatDate(currentEvent.eventDate)}</b> has been accepted.</p>
                    <p>The event is now marked as <b>Completed</b>. Thank you!</p>
                    <p>Warm regards,<br>IQAC</p>
                `,
                priority: 'NORMAL'
            });

            await handleStatusUpdate('Completed', res);
        };

        async function handleStatusUpdate(status, emailRes) {
            let updateData = { status: status };
            if (status === 'Under Review') updateData.reportReceivedDate = new Date().toISOString();
            if (status === 'Completed') updateData.completedDate = new Date().toISOString();

            if (emailRes.success || emailRes.status === 'success') {
                await DBService.updateEvent(currentEvent.id, updateData);
                await loadEvent();
                showAlert("Success", `Status updated to ${status}.`);
            } else {
                showAlert("Warning", `Local update done, but email failed.`);
                await DBService.updateEvent(currentEvent.id, updateData);
                await loadEvent();
            }
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        window.showAlert = (title, msg) => {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('customAlert').classList.add('active');
        };

        loadEvent();
    </script>
</body>

</html>