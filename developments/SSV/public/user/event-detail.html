<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - Event Tracker By Gridify</title>
    <link rel="icon" href="../assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="../assets/css/style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/db.js"></script>
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div style="text-align: center; margin-bottom: 1rem;">
                <img src="../assets/images/logo.png" alt="SSV" style="height: 150px;">
            </div>
            <h2 style="color: var(--primary-color); margin-bottom: 0.2rem; text-align: center;">Event Tracker</h2>
            <div class="sidebar-brand-sub"
                style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">by
                Gridify</div>
            <p style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-bottom: 2rem;">
                dedicated portal for Jobins KJ</p>

            <nav>
                <a href="dashboard.html" class="active">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="create-event.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8 8-3.59 8-8 8z" />
                    </svg>
                    <span>Create</span>
                </a>
                <button onclick="window.location.href='dashboard.html#profile'">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    <span>Profile</span>
                </button>
            </nav>

            <div style="margin-top: auto;">
                <button onclick="AuthService.logout()" class="btn btn-danger" style="width: 100%;">Logout</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="content-area">
            <header class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-4">
                    <a href="dashboard.html" class="btn btn-primary"
                        style="background:transparent; border:1px solid var(--border-color);">&larr; Back</a>
                    <h1>Event Details</h1>
                </div>
                <button onclick="openEditModal()" class="btn btn-primary">Edit Event</button>
            </header>

            <div id="loading" style="text-align:center; padding:2rem;">Loading...</div>

            <div id="content" style="display:none;">
                <div class="card mb-4 animate-fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="d_eventName">Event Name</h2>
                        <span id="d_status" class="status-badge status-pending">Status</span>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <p class="form-label">Coordinator</p>
                            <p id="d_coordName" class="mb-4 text-lg font-semibold"></p>

                            <p class="form-label">Email</p>
                            <p id="d_coordEmail" class="mb-4"></p>

                            <p class="form-label">Department</p>
                            <p id="d_dept" class="mb-4"></p>

                            <p class="form-label">Created By</p>
                            <p id="d_createdBy" class="mb-4" style="color: var(--text-secondary);"></p>
                        </div>
                        <div>
                            <p class="form-label">Event Date</p>
                            <p id="d_date" class="mb-4"></p>

                            <p class="form-label">Details</p>
                            <p id="d_details" class="mb-4" style="color: var(--text-secondary);"></p>

                            <p class="form-label">Reminders Sent</p>
                            <p id="d_reminders" class="mb-4 font-bold text-xl"></p>
                        </div>
                    </div>
                </div>

                <div class="card animate-fade-in">
                    <h3>Actions</h3>
                    <div class="flex gap-4">
                        <button id="btnMarkReview" onclick="markUnderReview()" class="btn btn-primary"
                            style="background: var(--info-color); display:none;">Mark Under Review</button>

                        <button id="btnRequestChanges" onclick="openChangesModal()" class="btn btn-primary"
                            style="background: var(--warning-color); display:none;">Request Changes</button>

                        <button id="btnMarkCompleted" onclick="markCompleted()" class="btn btn-primary"
                            style="background: var(--success-color); display:none;">Mark Completed</button>

                        <button id="btnSendReminder" onclick="initiateReminder()" class="btn btn-primary"
                            style="background: var(--warning-color);">Send Reminder</button>
                    </div>

                    <div style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                        <button id="btnDeleteEvent" onclick="deleteEvent()" class="btn btn-danger"
                            style="display:none;">Delete Event</button>
                    </div>

                    <p id="actionMsg" style="margin-top:1rem; color: var(--text-secondary);"></p>
                </div>
            </div>
        </main>
    </div>

    <!-- Changes Requested Modal -->
    <div class="modal-overlay" id="changesModal">
        <div class="modal-content">
            <h3>Request Changes</h3>
            <p style="color:var(--text-secondary); margin-bottom:1rem;">Notify the coordinator that the report format is
                incorrect.</p>

            <div class="form-group">
                <label class="form-label">Required Changes</label>
                <textarea id="changesMsg" class="form-control" rows="4"
                    placeholder="Describe the format issues or missing information..."></textarea>
            </div>

            <div class="flex justify-between">
                <button type="button" onclick="closeChangesModal()" class="btn btn-danger">Cancel</button>
                <button type="button" onclick="sendChangesEmail()" class="btn btn-primary">Send Email</button>
            </div>
        </div>
    </div>

    <!-- HOD Email Modal for Reminder 3 -->
    <!-- Reminder Modal -->
    <div class="modal-overlay" id="reminderModal">
        <div class="modal-content">
            <h3>Send Reminder</h3>

            <div class="form-group">
                <label class="form-label">Custom Message (Optional)</label>
                <textarea id="remCustomMsg" class="form-control" rows="3"
                    placeholder="Add a note to the email..."></textarea>
            </div>

            <div class="form-group flex items-center gap-2" style="margin-bottom:1rem;">
                <input type="checkbox" id="remEscalate" onchange="toggleHodInput()">
                <label for="remEscalate" style="margin:0; cursor:pointer;">Escalate to HOD (CC)</label>
            </div>

            <div class="form-group" id="hodInputGroup" style="display:none;">
                <label class="form-label">HOD Email Address</label>
                <input type="email" id="hodEmail" class="form-control" placeholder="hod@example.com">
            </div>

            <div class="flex justify-between">
                <button type="button" onclick="closeReminderModal()" class="btn btn-danger">Cancel</button>
                <button type="button" onclick="sendReminder()" class="btn btn-primary">Send</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <h3>Edit Event Details</h3>
            <form id="editEventForm">
                <div class="form-group">
                    <label class="form-label">Event Name</label>
                    <input type="text" id="editEventName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Coordinator Name</label>
                    <input type="text" id="editCoordName" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Coordinator Email</label>
                    <input type="email" id="editCoordEmail" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Department</label>
                    <input type="text" id="editDept" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Event Date</label>
                    <input type="date" id="editDate" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Details</label>
                    <textarea id="editDetails" class="form-control" rows="3"></textarea>
                </div>
                <div class="flex justify-between">
                    <button type="button" onclick="closeEditModal()" class="btn btn-danger">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Processing Request...</div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="customAlert" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 id="alertTitle">Alert</h3>
            <p id="alertMessage" style="margin-bottom: 1rem; color: var(--text-secondary);"></p>
            <button onclick="document.getElementById('customAlert').classList.remove('active')"
                class="btn btn-primary">OK</button>
        </div>
    </div>

    <footer class="footer">
        powered by <a href="https://www.gridify.in" target="_blank">GRIDIFY</a>
    </footer>

    <script type="module">
        import { EmailService, formatDate } from '../assets/js/utils.js';

        AuthService.requireRole('user');

        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        let currentEvent = null;

        async function loadEvent() {
            if (!eventId) {
                window.location.href = 'dashboard.html';
                return;
            }

            const event = await DBService.getEventById(eventId);
            if (!event) {
                document.getElementById('loading').innerText = 'Event not found.';
                return;
            }

            currentEvent = event;
            renderEvent();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        function renderEvent() {
            document.getElementById('d_eventName').innerText = currentEvent.eventName;
            document.getElementById('d_coordName').innerText = currentEvent.coordinatorName;
            document.getElementById('d_coordEmail').innerText = currentEvent.coordinatorEmail;
            document.getElementById('d_dept').innerText = currentEvent.departmentName;
            document.getElementById('d_createdBy').innerText = currentEvent.createdBy || 'Unknown';
            document.getElementById('d_date').innerText = formatDate(currentEvent.eventDate);
            document.getElementById('d_details').innerText = currentEvent.eventDetails;
            document.getElementById('d_reminders').innerText = currentEvent.reminderCount;

            const badge = document.getElementById('d_status');
            badge.innerText = currentEvent.status;

            if (currentEvent.status === 'Completed') {
                badge.className = 'status-badge status-received'; // Green for completed
                badge.innerText = "Completed";
                hideAllActions();
                // Maybe show a "Re-open" button if needed? For now, nothing.
            } else if (currentEvent.status === 'Under Review' || currentEvent.status === 'Changes Requested') {
                badge.className = 'status-badge status-urgent'; // Orange/Yellow

                document.getElementById('btnMarkReview').style.display = 'none';
                document.getElementById('btnSendReminder').style.display = 'none';

                document.getElementById('btnRequestChanges').style.display = 'inline-block';
                document.getElementById('btnMarkCompleted').style.display = 'inline-block';
            } else {
                // Pending / Not Received
                badge.className = 'status-badge status-pending';
                document.getElementById('btnMarkReview').style.display = 'inline-block';
                document.getElementById('btnSendReminder').style.display = 'inline-block';
                document.getElementById('btnSendReminder').innerText = `Send Reminder ${currentEvent.reminderCount + 1}`;

                document.getElementById('btnRequestChanges').style.display = 'none';
                document.getElementById('btnMarkCompleted').style.display = 'none';
            }

            checkDeletePermission();
        }

        function hideAllActions() {
            document.getElementById('btnMarkReview').style.display = 'none';
            document.getElementById('btnSendReminder').style.display = 'none';
            document.getElementById('btnRequestChanges').style.display = 'none';
            document.getElementById('btnMarkCompleted').style.display = 'none';
        }

        function checkDeletePermission() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    const profile = await AuthService.getUserProfile(user.uid);
                    const isCreator = currentEvent.createdBy === user.email;
                    const isAdmin = profile && profile.role === 'admin';

                    if (isCreator || isAdmin) {
                        document.getElementById('btnDeleteEvent').style.display = 'inline-block';
                    }
                }
            });
        }

        window.deleteEvent = async () => {
            if (!confirm("Are you sure you want to permanently delete this event? This action cannot be undone.")) return;

            document.getElementById('loadingOverlay').classList.add('active');
            const res = await DBService.deleteEvent(currentEvent.id);
            document.getElementById('loadingOverlay').classList.remove('active');

            if (res.success) {
                alert("Event deleted.");
                window.location.href = 'dashboard.html';
            } else {
                showAlert("Error", "Failed to delete: " + res.message);
            }
        };

        window.initiateReminder = () => {
            document.getElementById('reminderModal').classList.add('active');

            // Auto check if > 2 rems, but allow user to change
            if (currentEvent.reminderCount >= 2) {
                document.getElementById('remEscalate').checked = true;
                toggleHodInput();
            } else {
                document.getElementById('remEscalate').checked = false;
                toggleHodInput();
            }
            document.getElementById('remCustomMsg').value = '';

            // Load saved HOD Email if exists
            const savedHod = localStorage.getItem('hodEmail_pref');
            if (savedHod) {
                document.getElementById('hodEmail').value = savedHod;
            }
        };

        window.closeReminderModal = () => {
            document.getElementById('reminderModal').classList.remove('active');
        };

        window.toggleHodInput = () => {
            const checked = document.getElementById('remEscalate').checked;
            document.getElementById('hodInputGroup').style.display = checked ? 'block' : 'none';
        }

        window.sendReminder = async () => {
            document.getElementById('loadingOverlay').classList.add('active');
            closeReminderModal();

            const isEscalation = document.getElementById('remEscalate').checked;
            const customMsg = document.getElementById('remCustomMsg').value;

            let hodEmail = "";
            if (isEscalation) {
                hodEmail = document.getElementById('hodEmail').value;
                if (!hodEmail) {
                    showAlert("Error", "HOD Email is required for escalation.");
                    document.getElementById('loadingOverlay').classList.remove('active');
                    return;
                }
                // Save preference
                localStorage.setItem('hodEmail_pref', hodEmail);
            }

            const scriptUrl = await DBService.getScriptUrl();
            const emailService = new EmailService(scriptUrl);
            const nextCount = currentEvent.reminderCount + 1;

            let subject = `Reminder ${nextCount}: Submit Report for ${currentEvent.eventName}`;
            let priority = 'NORMAL';
            let cc = "";

            let baseBody = `
                <p>Hello ${currentEvent.coordinatorName},</p>
                <p>This is reminder #${nextCount} to submit the report for event: <b>${currentEvent.eventName}</b>.</p>
            `;

            if (isEscalation) {
                priority = 'HIGH';
                cc = hodEmail;
                subject = `[URGENT] ESCALATION: Report Missing for ${currentEvent.eventName}`;
                baseBody = `
                    <h3 style="color:red;">Escalation Notice</h3>
                    <p>Dear ${currentEvent.coordinatorName},</p>
                    <p>We still have not received the report for <b>${currentEvent.eventName}</b>.</p>
                    <p>This matter has been escalated to your HOD (${hodEmail}).</p>
                 `;
            }

            if (customMsg && customMsg.trim() !== '') {
                baseBody += `<div style="background:#fef3c7; padding:10px; border-left:4px solid #f59e0b; margin:15px 0;">
                    <strong>Note from Admin:</strong><br>${customMsg.replace(/\n/g, '<br>')}
                </div>`;
            }

            baseBody += `<p>Please upload it to SSV Emberse immediately.</p>`;

            const res = await emailService.sendEmail({
                emailType: 'REMINDER',
                to: currentEvent.coordinatorEmail,
                cc: cc,
                subject: subject,
                body: baseBody,
                priority: priority
            });

            if (res.success || res.status === 'success') {
                // Update DB
                await DBService.updateEvent(currentEvent.id, {
                    reminderCount: nextCount,
                    status: isEscalation ? `Reminder ${nextCount} Sent (Escalated)` : `Reminder ${nextCount} Sent`
                });
                // Reload
                await loadEvent();
                showAlert("Success", "Reminder sent successfully.");
            } else {
                showAlert("Error", "Failed to send email. Check configs.");
            }

            document.getElementById('loadingOverlay').classList.remove('active');
        };

        // Edit Modal Functions
        window.openEditModal = () => {
            document.getElementById('editEventName').value = currentEvent.eventName;
            document.getElementById('editCoordName').value = currentEvent.coordinatorName;
            document.getElementById('editCoordEmail').value = currentEvent.coordinatorEmail;
            document.getElementById('editDept').value = currentEvent.departmentName;
            // Date format YYYY-MM-DD
            const d = new Date(currentEvent.eventDate);
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            document.getElementById('editDate').value = `${yyyy}-${mm}-${dd}`;

            document.getElementById('editDetails').value = currentEvent.eventDetails || '';

            document.getElementById('editModal').classList.add('active');
        };

        window.closeEditModal = () => {
            document.getElementById('editModal').classList.remove('active');
        };

        document.getElementById('editEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loadingOverlay').classList.add('active');

            const updates = {
                eventName: document.getElementById('editEventName').value,
                coordinatorName: document.getElementById('editCoordName').value,
                coordinatorEmail: document.getElementById('editCoordEmail').value,
                departmentName: document.getElementById('editDept').value,
                eventDate: new Date(document.getElementById('editDate').value).toISOString(),
                eventDetails: document.getElementById('editDetails').value
            };

            const res = await DBService.updateEvent(currentEvent.id, updates);
            document.getElementById('loadingOverlay').classList.remove('active');

            if (res.success) {
                closeEditModal();
                showAlert("Success", "Event updated.");
                loadEvent();
            } else {
                showAlert("Error", res.message);
            }
        });

        window.markUnderReview = async () => {
            if (!confirm("Confirm report received? This will mark status as 'Under Review' and notify coordinator.")) return;

            document.getElementById('loadingOverlay').classList.add('active');
            const scriptUrl = await DBService.getScriptUrl();
            const emailService = new EmailService(scriptUrl);

            const res = await emailService.sendEmail({
                emailType: 'REPORT_RECEIVED',
                to: currentEvent.coordinatorEmail,
                subject: `Report Received - Under Review: ${currentEvent.eventName}`,
                body: `
                    <p>Hello ${currentEvent.coordinatorName},</p>
                    <p>We have received your report for <b>${currentEvent.eventName}</b>.</p>
                    <p>It is currently <b>Under Review</b>. We will notify you if any changes are required.</p>
                 `,
                priority: 'NORMAL'
            });

            await handleStatusUpdate('Under Review', res);
        };

        window.openChangesModal = () => {
            document.getElementById('changesModal').classList.add('active');
        };

        window.closeChangesModal = () => {
            document.getElementById('changesModal').classList.remove('active');
        };

        window.sendChangesEmail = async () => {
            const msg = document.getElementById('changesMsg').value;
            if (!msg) return showAlert("Error", "Please enter a message.");

            document.getElementById('loadingOverlay').classList.add('active');
            closeChangesModal();

            const scriptUrl = await DBService.getScriptUrl();
            const emailService = new EmailService(scriptUrl);

            const res = await emailService.sendEmail({
                emailType: 'CHANGES_REQUESTED',
                to: currentEvent.coordinatorEmail,
                subject: `Action Required: Report Format Issue - ${currentEvent.eventName}`,
                body: `
                    <p>Hello ${currentEvent.coordinatorName},</p>
                    <p>We reviewed your report for <b>${currentEvent.eventName}</b>.</p>
                    <div style="background:#fee2e2; color:#b91c1c; padding:15px; border-radius:4px; margin:15px 0;">
                        <strong>Action Required:</strong><br>
                        ${msg.replace(/\n/g, '<br>')}
                    </div>
                    <p>Please update the report and re-submit/notify us.</p>
                `,
                priority: 'HIGH'
            });

            await handleStatusUpdate('Changes Requested', res);
        };

        window.markCompleted = async () => {
            if (!confirm("Mark this event as fully Completed? This will close the event.")) return;

            document.getElementById('loadingOverlay').classList.add('active');
            const scriptUrl = await DBService.getScriptUrl();
            const emailService = new EmailService(scriptUrl);

            const res = await emailService.sendEmail({
                emailType: 'COMPLETED',
                to: currentEvent.coordinatorEmail,
                subject: `Event Completed: ${currentEvent.eventName}`,
                body: `
                    <p>Hello ${currentEvent.coordinatorName},</p>
                    <p>The report for <b>${currentEvent.eventName}</b> has been accepted.</p>
                    <p>The event is now marked as <b>Completed</b>. Thank you!</p>
                `,
                priority: 'NORMAL'
            });

            await handleStatusUpdate('Completed', res);
        };

        async function handleStatusUpdate(status, emailRes) {
            let updateData = { status: status };
            if (status === 'Under Review') updateData.reportReceivedDate = new Date().toISOString();
            if (status === 'Completed') updateData.completedDate = new Date().toISOString();

            if (emailRes.success || emailRes.status === 'success') {
                await DBService.updateEvent(currentEvent.id, updateData);
                await loadEvent();
                showAlert("Success", `Status updated to ${status}.`);
            } else {
                showAlert("Warning", `Local update done, but email failed.`);
                await DBService.updateEvent(currentEvent.id, updateData);
                await loadEvent();
            }
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        window.showAlert = (title, msg) => {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('customAlert').classList.add('active');
        };

        loadEvent();
    </script>
</body>

</html>