<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Event - Event Tracker By Gridify</title>
    <link rel="icon" href="../assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="../assets/css/style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/db.js"></script>
    <style>
        .custom-dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #ffffff;
            min-width: 100%;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.1);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-top: 4px;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            color: var(--text-primary);
            padding: 8px 12px;
            text-decoration: none;
            display: flex;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dropdown-item:hover {
            background-color: #f8fafc;
        }

        .dropdown-item input[type="checkbox"] {
            margin-right: 10px;
            pointer-events: none;
            /* Let the row click handle it */
            width: 16px;
            height: 16px;
            accent-color: var(--primary-color);
        }

        .selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .tag {
            background-color: rgba(108, 93, 211, 0.2);
            color: var(--primary-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            border: 1px solid var(--primary-color);
        }

        .tag .remove-tag {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Search input inside dropdown if needed, or just use the main input */
    </style>
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div style="text-align: left; padding-left: 0.75rem; margin-bottom: 2rem;">
                <img src="../assets/images/logo.png" alt="SSV" style="height: 32px;">
            </div>
            <h2
                style="color: var(--text-primary); margin: 0; font-size: 1.2rem; letter-spacing: 0.05em; text-transform: uppercase; font-weight: 700;">
                Event Tracker</h2>
            <div class="sidebar-brand-sub" style="color: var(--text-secondary); font-size: 0.8rem; opacity: 0.7;">
                dedicated portal for <span style="color: var(--primary-color);">Jobins KJ</span></div>

            <nav>
                <a href="dashboard.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="events.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="width: 20px; height: 20px; margin-right: 12px; opacity: 0.8;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span>Events</span>
                </a>
                <a href="reports.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                    </svg>
                    <span>Reports</span>
                </a>
                <a href="create-event.html" class="active">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                    </svg>
                    <span>Create</span>
                </a>
                <button onclick="window.location.href='dashboard.html#profile'">
                    <!-- Simple redirect to dash with profile hash or just dash -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    <span>Profile</span>
                </button>
            </nav>

            <div style="margin-top: auto; padding: 0.75rem;">
                <button onclick="AuthService.logout()" class="btn btn-danger" style="width: 100%;">Logout</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="content-area">
            <header class="mb-4">
                <h1>Create New Event</h1>
            </header>

            <div class="card p-large animate-fade-in" style="max-width: 800px; overflow: visible;">
                <form id="createEventForm">
                    <div class="form-group">
                        <label class="form-label">Event Name</label>
                        <input type="text" id="eventName" class="form-control" required
                            placeholder="e.g. Annual Meeting">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Event Details</label>
                        <textarea id="eventDetails" class="form-control" rows="3" required
                            placeholder="Description..."></textarea>
                    </div>

                    <div class="flex gap-4">
                        <div class="form-group" style="flex:1">
                            <label class="form-label">Event Date</label>
                            <input type="date" id="eventDate" class="form-control" required>
                        </div>
                        <div class="form-group" id="deptGroup" style="flex:1">
                            <label class="form-label">Department Name</label>
                            <div class="custom-dropdown" id="deptDropdownContainer">
                                <input type="text" class="form-control search-input"
                                    placeholder="Search / Select Departments..."
                                    onfocus="toggleDropdown('deptList', true); filterDropdown('deptList', this.value)"
                                    oninput="filterDropdown('deptList', this.value)">
                                <div id="deptList" class="dropdown-content">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                            <div id="selectedDepts" class="selected-tags"></div>
                        </div>

                        <div class="form-group" id="clubGroup" style="flex:1;">
                            <label class="form-label">Club Name</label>
                            <div class="custom-dropdown" id="clubDropdownContainer">
                                <input type="text" class="form-control search-input"
                                    placeholder="Search / Select Clubs..."
                                    onfocus="toggleDropdown('clubList', true); filterDropdown('clubList', this.value)"
                                    oninput="filterDropdown('clubList', this.value)">
                                <div id="clubList" class="dropdown-content">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                            <div id="selectedClubs" class="selected-tags"></div>
                            <input type="hidden" id="clubNames">
                        </div>
                    </div>
                    <input type="hidden" id="departmentName">



                    <div class="flex gap-4">
                        <div class="form-group" style="flex:1">
                            <label class="form-label">Coordinator Name</label>
                            <div class="custom-dropdown" id="coordDropdownContainer">
                                <input type="text" class="form-control search-input"
                                    placeholder="Search / Select Coordinators..."
                                    onfocus="toggleDropdown('coordList', true); filterDropdown('coordList', this.value)"
                                    oninput="filterDropdown('coordList', this.value)">
                                <div id="coordList" class="dropdown-content">
                                    <!-- Populated by JS -->
                                </div>
                            </div>
                            <div id="selectedCoords" class="selected-tags"></div>
                            <input type="hidden" id="coordinatorName" required>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label class="form-label">Coordinator Email</label>
                            <input type="text" id="coordinatorEmail" class="form-control" readonly
                                placeholder="Auto-filled based on selection"
                                style="background-color: #f8fafc; cursor: not-allowed;">
                        </div>
                    </div>

                    <div class="flex justify-between mt-8" style="gap: 1rem;">
                        <a href="events.html" class="btn btn-outline mobile-full-width" style="flex:1;">Cancel</a>
                        <button type="submit" class="btn btn-primary mobile-full-width" style="flex:2;">Create
                            Event</button>
                    </div>

                    <style>
                        @media (max-width: 768px) {
                            #createEventForm .flex.justify-between {
                                flex-direction: column-reverse;
                                /* Put submit on top or keep standard? Stacked: Cancel bottom. */
                            }

                            .mobile-full-width {
                                width: 100%;
                            }
                        }
                    </style>
                </form>
            </div>
            <footer class="footer">
                powered by <a href="https://www.gridify.in" target="_blank">GRIDIFY</a>
            </footer>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="modern-spinner">
                <div class="spinner-arc outer"></div>
                <div class="spinner-arc inner"></div>
            </div>
            <div class="loading-text">Syncing with cloud...</div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="customAlert" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 id="alertTitle">Alert</h3>
            <p id="alertMessage" style="margin-bottom: 1rem; color: var(--text-secondary);"></p>
            <button class="btn btn-primary">OK</button>
        </div>
    </div>

    <script type="module">
        import { EmailService, formatDate } from '../assets/js/utils.js';

        AuthService.requireRole('user');

        let isSubmitting = false;

        document.getElementById('createEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (isSubmitting) return;
            isSubmitting = true;

            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');

            const eventData = {
                eventName: document.getElementById('eventName').value.trim(),
                eventDetails: document.getElementById('eventDetails').value.trim(),
                eventDate: document.getElementById('eventDate').value,
            };
            const deptNameVal = document.getElementById('departmentName').value;
            const clubNameVal = document.getElementById('clubNames').value;

            // Effective Department Name logic: Combine both if present
            let finalDeptName = deptNameVal;
            if (clubNameVal) {
                if (finalDeptName) finalDeptName += ', ' + clubNameVal;
                else finalDeptName = clubNameVal;
            }

            eventData.departmentName = finalDeptName;
            eventData.coordinatorName = document.getElementById('coordinatorName').value;
            eventData.coordinatorEmail = document.getElementById('coordinatorEmail').value;
            eventData.hodEmail = (function () {
                // Start with empty
                let hodEmails = [];

                // Dept Mode: fetch HOD of selected departments
                if (deptNameVal) {
                    const depts = deptNameVal.split(', ');
                    depts.forEach(d => {
                        const hod = allStaff.find(s => s.department === d && s.designation === 'HOD');
                        if (hod && hod.email) hodEmails.push(hod.email);
                    });
                }

                // Club Mode: logic remains empty for now as per previous assumption

                return Array.from(new Set(hodEmails)).join(', ');
            })();
            eventData.clubIds = Array.from(selectedClubs).map(c => c.id); // Store Club IDs
            eventData.createdBy = auth.currentUser ? auth.currentUser.email : 'unknown';

            // Validation
            if (!eventData.eventName || !eventData.eventDetails || !eventData.eventDate || !eventData.departmentName || !eventData.coordinatorName || !eventData.coordinatorEmail) {
                loading.classList.remove('active');
                const missing = [];
                if (!eventData.eventName) missing.push("Event Name");
                if (!eventData.departmentName) missing.push("Department or Club Name");
                if (!eventData.coordinatorName) missing.push("Coordinator");

                showAlert("Warning", "Please fill in all required fields: " + missing.join(', '), false);
                isSubmitting = false;
                return;
            }

            // 1. Create Event in DB
            const dbRes = await DBService.createEvent(eventData);

            loading.classList.remove('active');
            isSubmitting = false;

            if (dbRes.success) {
                showAlert("Success", "Event created successfully!");
            } else {
                showAlert("Error", dbRes.message);
            }
        });

        window.showAlert = (title, msg, shouldRedirect = true) => {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg;
            const alertBtn = document.querySelector('#customAlert .btn');
            if (shouldRedirect) {
                alertBtn.onclick = () => window.location.href = 'events.html';
            } else {
                alertBtn.onclick = () => document.getElementById('customAlert').classList.remove('active');
            }
            document.getElementById('customAlert').classList.add('active');
        };

        // Removed global redirectDashboard as it's now handled inside showAlert dynamically

        // --- Custom Dropdown Logic ---
        let allStaff = [];
        let allClubs = [];
        let selectedDepts = new Set();
        let selectedClubs = new Set(); // Stores objects {id, name, staffIds}
        let selectedCoords = new Set(); // Stores objects {name, email}

        async function initDropdowns() {
            try {
                const [staffRes, clubsRes] = await Promise.all([
                    DBService.getStaff(),
                    DBService.getClubs(true) // Only active clubs
                ]);
                allStaff = staffRes;
                allClubs = clubsRes;
                populateDeptDropdown();
                populateClubDropdown();
                populateCoordDropdown();
            } catch (error) {
                console.error("Failed to load data:", error);
            }
        }

        function populateClubDropdown() {
            const list = document.getElementById('clubList');
            list.innerHTML = '';

            if (allClubs.length === 0) {
                list.innerHTML = '<div class="dropdown-item" style="color: var(--text-secondary); cursor: default;">No clubs found</div>';
                return;
            }

            allClubs.forEach(club => {
                const item = createDropdownItem(club, 'club');
                list.appendChild(item);
            });
        }

        function populateDeptDropdown() {
            const depts = new Set(allStaff.map(s => s.department).filter(d => d));
            const list = document.getElementById('deptList');
            list.innerHTML = '';
            Array.from(depts).sort().forEach(dept => {
                const item = createDropdownItem(dept, 'dept');
                list.appendChild(item);
            });
        }

        function populateCoordDropdown() {


            let staffToShow = [];

            // 1. Get staff from Departments
            if (selectedDepts.size > 0) {
                const depStaff = allStaff.filter(s => selectedDepts.has(s.department));
                staffToShow = [...staffToShow, ...depStaff];
            }

            // 2. Get staff from Clubs
            selectedClubs.forEach(club => {
                if (club.staffIds && club.staffIds.length > 0) {
                    const clubStaff = allStaff.filter(s => club.staffIds.includes(s.id));
                    staffToShow = [...staffToShow, ...clubStaff];
                }
            });

            // If nothing selected, show all? Or show none? 
            // Existing logic showed all if Dept selected? 
            // Original code: if (selectedDepts.size > 0) filter, else staffToShow = allStaff.
            // Let's maintain that behavior: if NO filters (dept or club), show ALL.
            if (selectedDepts.size === 0 && selectedClubs.size === 0) {
                staffToShow = allStaff;
            }

            const coords = staffToShow.map(s => ({ name: s.name, email: s.email, department: s.department })).filter(s => s.name);
            // Remove duplicates based on email
            const uniqueCoords = [];
            const map = new Map();
            for (const item of coords) {
                if (!map.has(item.email)) {
                    map.set(item.email, true);
                    uniqueCoords.push(item);
                }
            }

            const list = document.getElementById('coordList');
            list.innerHTML = '';

            // Handle empty state
            if (uniqueCoords.length === 0) {
                list.innerHTML = '<div class="dropdown-item" style="color: var(--text-secondary); cursor: default;">No staff found</div>';
            }

            uniqueCoords.sort((a, b) => a.name.localeCompare(b.name)).forEach(coord => {
                const item = createDropdownItem(coord, 'coord');
                list.appendChild(item);
            });

            // Update cross-reference for checkboxes since we cleared the list
            const values = Array.from(selectedCoords);
            document.querySelectorAll('#coordList .dropdown-item').forEach(item => {
                const nameNode = item.querySelector('span');
                if (!nameNode) return;
                const name = nameNode.innerText;
                const isChecked = values.some(c => c.name === name);
                const checkbox = item.querySelector('input');
                if (checkbox) checkbox.checked = isChecked;
            });
        }


        function createDropdownItem(data, type) {
            const div = document.createElement('div');
            div.className = 'dropdown-item';
            let val = '';
            if (type === 'dept') val = data;
            else if (type === 'club') val = data.name;
            else val = data.name;

            div.innerHTML = `<input type="checkbox"><span>${val}</span>`;
            div.onclick = (e) => {
                e.preventDefault(); // Prevent default checkbox behavior
                e.stopPropagation();
                toggleSelection(type, data, div);
            };
            return div;
        }

        function toggleSelection(type, data, element) {
            const checkbox = element.querySelector('input[type="checkbox"]');
            let isSelected = false;

            if (type === 'dept') {
                if (selectedDepts.has(data)) {
                    selectedDepts.delete(data);
                } else {
                    selectedDepts.add(data);
                    isSelected = true;
                }
            } else if (type === 'club') {
                if (selectedClubs.has(data)) {
                    selectedClubs.delete(data);
                } else {
                    selectedClubs.add(data);
                    isSelected = true;
                }
            } else {
                // For coords, data is obj {name, email}
                // Check existance by email
                let found = null;
                for (let item of selectedCoords) {
                    if (item.email === data.email) found = item;
                }
                if (found) {
                    selectedCoords.delete(found);
                } else {
                    selectedCoords.add(data);
                    isSelected = true;
                }
            }

            checkbox.checked = isSelected;
            updateUI(type);
        }

        function updateUI(type) {
            if (type === 'dept') {
                const container = document.getElementById('selectedDepts');
                container.innerHTML = '';
                const values = Array.from(selectedDepts);
                document.getElementById('departmentName').value = values.join(', ');

                values.forEach(dept => {
                    const tag = document.createElement('div');
                    tag.className = 'tag';
                    tag.innerHTML = `${dept} <span class="remove-tag" onclick="removeTag('dept', '${dept}')">&times;</span>`;
                    container.appendChild(tag);
                });

                // Update checkbox state in dropdown
                document.querySelectorAll('#deptList .dropdown-item').forEach(item => {
                    const span = item.querySelector('span').innerText;
                    item.querySelector('input').checked = selectedDepts.has(span);
                });

                // NEW: Trigger coord update based on selected departments
                populateCoordDropdown();
            } else if (type === 'club') {
                const container = document.getElementById('selectedClubs');
                container.innerHTML = '';
                const values = Array.from(selectedClubs);
                document.getElementById('clubNames').value = values.map(c => c.name).join(', ');

                values.forEach(club => {
                    const tag = document.createElement('div');
                    tag.className = 'tag';
                    tag.innerHTML = `${club.name} <span class="remove-tag" onclick="removeTag('club', '${club.id}')">&times;</span>`;
                    container.appendChild(tag);
                });

                document.querySelectorAll('#clubList .dropdown-item').forEach(item => {
                    const span = item.querySelector('span').innerText;
                    item.querySelector('input').checked = values.some(c => c.name === span);
                });

                populateCoordDropdown();
            } else {
                const container = document.getElementById('selectedCoords');
                container.innerHTML = '';
                const values = Array.from(selectedCoords);
                document.getElementById('coordinatorName').value = values.map(c => c.name).join(', ');
                document.getElementById('coordinatorEmail').value = values.map(c => c.email).join(', ');

                values.forEach(coord => {
                    const tag = document.createElement('div');
                    tag.className = 'tag';
                    tag.innerHTML = `${coord.name} <span class="remove-tag" onclick="removeTag('coord', '${coord.email}')">&times;</span>`;
                    container.appendChild(tag);
                });

                // Update checkbox state
                document.querySelectorAll('#coordList .dropdown-item').forEach(item => {
                    const name = item.querySelector('span').innerText;
                    const isChecked = values.some(c => c.name === name);
                    item.querySelector('input').checked = isChecked;
                });
            }
        }

        window.removeTag = (type, id) => {
            // id is Dept Name or Coord Email
            if (type === 'dept') {
                selectedDepts.delete(id);
            } else if (type === 'club') {
                const found = Array.from(selectedClubs).find(c => c.id === id);
                if (found) selectedClubs.delete(found);
            } else {
                const found = Array.from(selectedCoords).find(c => c.email === id);
                if (found) selectedCoords.delete(found);
            }
            updateUI(type);
        };

        window.toggleDropdown = (id, show) => {
            const el = document.getElementById(id);
            if (show) el.classList.add('show');
            else el.classList.remove('show');
        };

        window.filterDropdown = (id, query) => {
            const list = document.getElementById(id);
            const items = list.querySelectorAll('.dropdown-item');
            const lower = query.toLowerCase();
            items.forEach(item => {
                const text = item.innerText.toLowerCase();
                item.style.display = text.includes(lower) ? 'flex' : 'none';
            });
        };

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(el => el.classList.remove('show'));
            }
        });

        // Init
        initDropdowns();

    </script>
</body>


</html>
