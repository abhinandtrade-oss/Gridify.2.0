<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Event - Event Tracker By Gridify</title>
    <link rel="icon" href="../assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="../assets/css/style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/db.js"></script>
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div style="text-align: center; margin-bottom: 1rem;">
                <img src="../assets/images/logo.png" alt="SSV" style="height: 150px;">
            </div>
            <h2 style="color: var(--primary-color); margin-bottom: 0.2rem; text-align: center;">Event Tracker</h2>
            <div class="sidebar-brand-sub"
                style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.5rem;">by
                Gridify</div>
            <p style="font-size: 0.75rem; color: var(--text-secondary); text-align: center; margin-bottom: 2rem;">
                dedicated portal for Jobins KJ</p>

            <nav>
                <a href="dashboard.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="create-event.html" class="active">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                    </svg>
                    <span>Create</span>
                </a>
                <button onclick="window.location.href='dashboard.html#profile'">
                    <!-- Simple redirect to dash with profile hash or just dash -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    <span>Profile</span>
                </button>
            </nav>

            <div style="margin-top: auto;">
                <button onclick="AuthService.logout()" class="btn btn-danger" style="width: 100%;">Logout</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="content-area">
            <header class="mb-4">
                <h1>Create New Event</h1>
            </header>

            <div class="card animate-fade-in" style="max-width: 800px;">
                <form id="createEventForm">
                    <div class="form-group">
                        <label class="form-label">Event Name</label>
                        <input type="text" id="eventName" class="form-control" required
                            placeholder="e.g. Annual Meeting">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Event Details</label>
                        <textarea id="eventDetails" class="form-control" rows="3" required
                            placeholder="Description..."></textarea>
                    </div>

                    <div class="flex gap-4">
                        <div class="form-group" style="flex:1">
                            <label class="form-label">Event Date</label>
                            <input type="date" id="eventDate" class="form-control" required>
                        </div>
                        <div class="form-group" style="flex:1">
                            <label class="form-label">Department Name</label>
                            <input type="text" id="departmentName" class="form-control" required placeholder="e.g. IT">
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <div class="form-group" style="flex:1">
                            <label class="form-label">Coordinator Name</label>
                            <input type="text" id="coordinatorName" class="form-control" required
                                placeholder="John Doe">
                        </div>
                        <div class="form-group" style="flex:1">
                            <label class="form-label">Coordinator Email</label>
                            <input type="email" id="coordinatorEmail" class="form-control" required
                                placeholder="john@example.com">
                        </div>
                    </div>

                    <div class="flex justify-between mt-4" style="gap: 1rem;">
                        <a href="dashboard.html" class="btn btn-danger mobile-full-width"
                            style="justify-content:center;">Cancel</a>
                        <button type="submit" class="btn btn-primary mobile-full-width"
                            style="flex:1; justify-content:center;">Create & Send Email</button>
                    </div>

                    <style>
                        @media (max-width: 768px) {
                            #createEventForm .flex.justify-between {
                                flex-direction: column-reverse;
                                /* Put submit on top or keep standard? Stacked: Cancel bottom. */
                            }

                            .mobile-full-width {
                                width: 100%;
                            }
                        }
                    </style>
                </form>
            </div>
            <div id="loadingOverlay">
                <div class="loading-content">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Processing Request...</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Alert Modal -->
    <div id="customAlert" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 id="alertTitle">Alert</h3>
            <p id="alertMessage" style="margin-bottom: 1rem; color: var(--text-secondary);"></p>
            <button onclick="redirectDashboard()" class="btn btn-primary">OK</button>
        </div>
    </div>

    <footer class="footer">
        powered by <a href="https://www.gridify.in" target="_blank">GRIDIFY</a>
    </footer>

    <script type="module">
        import { EmailService } from '../assets/js/utils.js';

        AuthService.requireRole('user');

        document.getElementById('createEventForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const loading = document.getElementById('loadingOverlay');
            loading.classList.add('active');

            const eventData = {
                eventName: document.getElementById('eventName').value,
                eventDetails: document.getElementById('eventDetails').value,
                eventDate: document.getElementById('eventDate').value,
                departmentName: document.getElementById('departmentName').value,
                coordinatorName: document.getElementById('coordinatorName').value,
                coordinatorEmail: document.getElementById('coordinatorEmail').value,
                createdBy: auth.currentUser ? auth.currentUser.email : 'unknown'
            };

            // 1. Create Event in DB
            const dbRes = await DBService.createEvent(eventData);

            if (dbRes.success) {
                // 2. Send Email
                const scriptUrl = await DBService.getScriptUrl();
                const emailService = new EmailService(scriptUrl);

                const emailRes = await emailService.sendEmail({
                    emailType: 'EVENT_CREATION',
                    to: eventData.coordinatorEmail,
                    subject: `New Event: ${eventData.eventName} - Report Required`,
                    body: `
                        <h3>Hello ${eventData.coordinatorName},</h3>
                        <p>Detailed greetings from SSV.</p>
                        <p>You have successfully created the event <b>${eventData.eventName}</b> scheduled on ${eventData.eventDate}.</p>
                        <p>Please remember to update the event report in <b>SSV Emberse</b> once the event is concluded.</p>
                        <br>
                        <p>Department: ${eventData.departmentName}</p>
                    `,
                    priority: 'NORMAL'
                });

                loading.classList.remove('active');

                if (emailRes.success || emailRes.status === 'success') {
                    showAlert("Success", "Event created and email sent successfully!");
                } else {
                    showAlert("Warning", "Event created but email sending failed. Check script URL.");
                }

            } else {
                loading.classList.remove('active');
                showAlert("Error", dbRes.message);
            }
        });

        window.showAlert = (title, msg) => {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('customAlert').classList.add('active');
        };

        window.redirectDashboard = () => {
            window.location.href = 'dashboard.html';
        };
    </script>
</body>

</html>