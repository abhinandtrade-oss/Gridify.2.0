<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - Event Tracker By Gridify</title>
    <link rel="icon" href="../assets/images/favicon.png" type="image/png">
    <link rel="stylesheet" href="../assets/css/style.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../assets/js/firebase-config.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/db.js"></script>
    <script type="module">
        import { CSVExport, formatDate } from '../assets/js/utils.js';
        window.CSVExport = CSVExport;
        window.formatDate = formatDate;
    </script>
    <style>
        .sort-icon {
            display: inline-block;
            font-size: 0.8rem;
            margin-left: 4px;
            color: var(--primary-color);
            min-width: 12px;
        }

        input[type="checkbox"] {
            accent-color: var(--primary-color);
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        .toolbar-card label {
            color: var(--text-secondary);
        }

        /* Filter Styles */
        .filter-icon {
            display: inline-flex;
            width: 16px;
            height: 16px;
            margin-left: 4px;
            cursor: pointer;
            opacity: 0.5;
            vertical-align: middle;
            color: var(--primary-color);
        }

        .filter-icon:hover,
        .filter-icon.active {
            opacity: 1;
        }

        .filter-popover {
            position: absolute;
            background: #ffffff;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            width: 200px;
            z-index: 100;
            padding: 0.5rem;
            display: none;
        }

        .filter-popover.visible {
            display: block;
        }

        .filter-search {
            width: 100%;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.5rem;
            background: #ffffff;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 0.25rem;
            font-size: 0.85rem;
        }

        .filter-options {
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            padding: 0.2rem;
            cursor: pointer;
        }

        .filter-option:hover {
            background: #f8fafc;
        }

        .filter-actions {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }
    </style>
</head>

<body>

    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div style="text-align: left; padding-left: 0.75rem; margin-bottom: 2rem;">
                <img src="../assets/images/logo.png" alt="SSV" style="height: 32px;">
            </div>
            <h2
                style="color: var(--text-primary); margin: 0; font-size: 1.2rem; letter-spacing: 0.05em; text-transform: uppercase; font-weight: 700;">
                Event Tracker</h2>
            <div class="sidebar-brand-sub" style="color: var(--text-secondary); font-size: 0.8rem; opacity: 0.7;">
                dedicated portal for <span style="color: var(--primary-color);">Jobins KJ</span></div>

            <nav>
                <a href="dashboard.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="events.html" class="active">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        style="width: 20px; height: 20px; margin-right: 12px; opacity: 0.8;">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <span>Events</span>
                </a>
                <a href="reports.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z" />
                    </svg>
                    <span>Reports</span>
                </a>
                <a href="create-event.html">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z" />
                    </svg>
                    <span>Create</span>
                </a>
                <button onclick="openProfile()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path
                            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                    </svg>
                    <span>Profile</span>
                </button>
            </nav>

            <div style="margin-top: auto; padding: 0.75rem;">
                <button onclick="AuthService.logout()" class="btn btn-danger"
                    style="width: 100%; border-radius: 0.5rem; font-size: 0.85rem; padding: 0.5rem;">Logout</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="content-area">
            <header class="flex justify-between items-center mb-4">
                <h1>Event Management</h1>
                <div class="flex gap-4">
                    <button onclick="exportCSV()" class="btn btn-outline">Export
                        All</button>
                    <a href="create-event.html" class="btn btn-primary desktop-only">New Event</a>
                    <button onclick="AuthService.logout()" class="btn btn-danger mobile-only">Logout</button>
                </div>
            </header>

            <div class="card animate-fade-in">
                <!-- Mobile List View -->
                <div id="mobileEventList" class="mobile-event-list"></div>

                <!-- Toolbar -->
                <div class="card toolbar-card mb-4"
                    style="margin-bottom: 1rem; padding: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between;">
                    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                        <div class="form-group"
                            style="margin-bottom: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <label style="margin: 0; font-size: 0.9rem;">From:</label>
                            <input type="date" id="dateRangeStart" class="form-control"
                                style="width: auto; padding: 0.25rem 0.5rem;">
                        </div>
                        <div class="form-group"
                            style="margin-bottom: 0; display: flex; align-items: center; gap: 0.5rem;">
                            <label style="margin: 0; font-size: 0.9rem;">To:</label>
                            <input type="date" id="dateRangeEnd" class="form-control"
                                style="width: auto; padding: 0.25rem 0.5rem;">
                        </div>
                        <button onclick="processData()" class="btn btn-primary btn-sm"
                            style="font-size: 0.85rem;">Apply</button>
                        <button onclick="clearDateRange()" id="btnClearDates" class="btn btn-danger btn-sm"
                            style="display: none; margin-left: 0.5rem;">Clear
                            Dates</button>
                    </div>
                    <div>
                        <button onclick="clearAllFilters()" id="btnClearFilters" class="btn btn-danger btn-sm"
                            style="margin-right: 0.5rem; display:none;">Reset
                            Filters</button>
                        <button onclick="downloadSelected()" id="btnDownloadSelected" class="btn btn-outline btn-sm"
                            disabled>Download
                            Selected (0)</button>
                    </div>
                </div>

                <!-- Desktop Table View -->
                <div class="desktop-table">
                    <table style="width: 100%; border-collapse: collapse; text-align: left;">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" id="selectAllCheckbox"
                                        onchange="toggleSelectAll(this.checked)">
                                </th>
                                <th style="cursor: pointer; user-select: none;">
                                    <div style="display:flex; align-items:center; justify-content: space-between;"
                                        onclick="handleSort('eventName')">
                                        <span>Event Name <span id="sort-eventName" class="sort-icon"></span></span>
                                        <svg class="filter-icon"
                                            onclick="event.stopPropagation(); toggleFilter(event, 'eventName')"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
                                        </svg>
                                    </div>
                                </th>
                                <th style="cursor: pointer; user-select: none;">
                                    <div style="display:flex; align-items:center; justify-content: space-between;"
                                        onclick="handleSort('eventDate')">
                                        <span>Date <span id="sort-eventDate" class="sort-icon"></span></span>
                                        <svg class="filter-icon"
                                            onclick="event.stopPropagation(); toggleFilter(event, 'eventDate')"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
                                        </svg>
                                    </div>
                                </th>
                                <th style="cursor: pointer; user-select: none;">
                                    <div style="display:flex; align-items:center; justify-content: space-between;"
                                        onclick="handleSort('coordinatorName')">
                                        <span>Coordinator <span id="sort-coordinatorName"
                                                class="sort-icon"></span></span>
                                        <svg class="filter-icon"
                                            onclick="event.stopPropagation(); toggleFilter(event, 'coordinatorName')"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
                                        </svg>
                                    </div>
                                </th>
                                <th style="cursor: pointer; user-select: none;">
                                    <div style="display:flex; align-items:center; justify-content: space-between;"
                                        onclick="handleSort('status')">
                                        <span>Status <span id="sort-status" class="sort-icon"></span></span>
                                        <svg class="filter-icon"
                                            onclick="event.stopPropagation(); toggleFilter(event, 'status')"
                                            viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z" />
                                        </svg>
                                    </div>
                                </th>
                                <th>Reminders</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="eventTableBody">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Filter Popover (Dynamic Content) -->
            <div id="filterPopover" class="filter-popover">
                <input type="text" id="filterSearch" class="filter-search" placeholder="Search..."
                    oninput="filterOptions(this.value)">
                <div id="filterOptions" class="filter-options"></div>
                <div class="filter-actions">
                    <button class="btn btn-primary btn-sm" onclick="applyColumnFilter()">Apply</button>
                    <button class="btn btn-outline btn-sm" onclick="closeFilter()">Close</button>
                </div>
            </div>

            <footer class="footer">
                powered by <a href="https://www.gridify.in" target="_blank">GRIDIFY</a>
            </footer>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="modern-spinner">
                <div class="spinner-arc outer"></div>
                <div class="spinner-arc inner"></div>
            </div>
            <div class="loading-text">Syncing with cloud...</div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal-content">
            <h3>User Profile</h3>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="profileEmail" class="form-control" disabled>
                <div id="verificationSection" style="margin-top: 0.5rem;">
                    <!-- Populated by JS -->
                </div>
            </div>

            <hr style="margin: 1.5rem 0; border: 0; border-top: 1px solid var(--border-color);">

            <h4>Change Password</h4>
            <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" id="newPassword" class="form-control" placeholder="Enter new password">
            </div>
            <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" id="confirmNewPassword" class="form-control" placeholder="Confirm new password">
            </div>

            <div class="flex justify-between" style="margin-top: 1.5rem;">
                <button onclick="document.getElementById('profileModal').classList.remove('active')"
                    class="btn btn-danger"
                    style="border: 1px solid var(--border-color); color: var(--text-secondary);">Close</button>
                <button onclick="updateProfile()" class="btn btn-primary">Save Changes</button>
            </div>

            <div class="mobile-only"
                style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                <button onclick="AuthService.logout()" class="btn btn-danger" style="width: 100%;">Logout</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="customAlert" class="modal-overlay">
        <div class="modal-content" style="text-align:center;">
            <h3 id="alertTitle">Alert</h3>
            <p id="alertMessage" style="margin-bottom: 1rem; color: var(--text-secondary);"></p>
            <button onclick="document.getElementById('customAlert').classList.remove('active')"
                class="btn btn-primary">OK</button>
        </div>
    </div>

    <script type="module">
        import { CSVExport, formatDate, EmailService } from '../assets/js/utils.js';

        // Expose to window for inline calls
        window.formatDate = formatDate;

        AuthService.requireRole('user');

        let rawEvents = []; // Unfiltered data from DB
        let displayedEvents = []; // Filtered and selected data
        let selectedEvents = new Set();
        let sortConfig = { key: null, direction: 'asc' };
        let activeFilters = {}; // { 'eventName': Set(['Name1', 'Name2']), ... }
        let currentFilterColumn = null;

        // Global Loading Functions
        window.showLoading = (text = "Processing Request...") => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.querySelector('.loading-text').textContent = text;
                overlay.classList.add('active');
            }
        };

        window.hideLoading = () => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.remove('active');
        };

        // --- Filter Logic ---
        window.toggleFilter = (event, column) => {
            // event.stopPropagation(); is handled inline
            const popover = document.getElementById('filterPopover');

            if (currentFilterColumn === column && popover.classList.contains('visible')) {
                closeFilter();
                return;
            }

            currentFilterColumn = column;
            // Position popover
            const iconRect = event.target.getBoundingClientRect();
            // Simplify positioning: align to icon, keep onscreen
            let left = iconRect.left; // Adjust if needed
            let top = iconRect.bottom + window.scrollY + 5;

            // Adjust if too far right
            if (left + 220 > window.innerWidth) { // 220 approx width
                left = window.innerWidth - 230;
            }

            popover.style.left = `${left}px`;
            popover.style.top = `${top}px`;
            popover.classList.add('visible');

            renderFilterOptions(column);
        };

        window.closeFilter = () => {
            document.getElementById('filterPopover').classList.remove('visible');
            currentFilterColumn = null;
        };

        function renderFilterOptions(column) {
            const container = document.getElementById('filterOptions');
            const searchInput = document.getElementById('filterSearch');
            searchInput.value = ''; // Reset search
            container.innerHTML = '';

            // Get unique values from RAW events
            const uniqueValues = new Set(rawEvents.map(e => {
                if (column === 'eventDate') return formatDate(e[column]);
                return e[column] || '(Empty)';
            }));
            const sortedValues = Array.from(uniqueValues).sort();

            // Select All Checkbox
            const isAllSelected = !activeFilters[column] || activeFilters[column].size === sortedValues.length;

            const divAll = document.createElement('label');
            divAll.className = 'filter-option';
            divAll.innerHTML = `
                <input type="checkbox" onchange="toggleFilterSelectAll(this.checked)" ${isAllSelected ? 'checked' : ''}>
                (Select All)
            `;
            container.appendChild(divAll);

            // Individual Options
            sortedValues.forEach(val => {
                const isChecked = !activeFilters[column] || activeFilters[column].has(val);
                const div = document.createElement('label');
                div.className = 'filter-option option-item';
                div.innerHTML = `
                    <input type="checkbox" value="${val}" onchange="checkFilterState()" ${isChecked ? 'checked' : ''}>
                    ${val}
                `;
                container.appendChild(div);
            });
            checkFilterState(); // Initialize indeterminate state
        }

        window.toggleFilterSelectAll = (checked) => {
            const checkboxes = document.querySelectorAll('.option-item input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
        };

        window.checkFilterState = () => {
            // Just ensures checkboxes update visual state if needed, mostly for future "Select All" auto-check logic
            const checkboxes = Array.from(document.querySelectorAll('.option-item input[type="checkbox"]'));
            const allChecked = checkboxes.every(cb => cb.checked);
            const someChecked = checkboxes.some(cb => cb.checked);
            const selectAllCb = document.querySelector('.filter-option input[type="checkbox"]'); // First one
            if (selectAllCb) {
                selectAllCb.checked = allChecked;
                selectAllCb.indeterminate = !allChecked && someChecked;
            }
        };

        window.filterOptions = (query) => {
            const items = document.querySelectorAll('.option-item');
            const lowerQuery = query.toLowerCase();
            let hasMatch = false;
            items.forEach(item => {
                const text = item.textContent.trim().toLowerCase();
                if (text.includes(lowerQuery)) {
                    item.style.display = 'flex';
                    hasMatch = true;
                } else {
                    item.style.display = 'none';
                }
            });

            // Handle No Matches
            let noMatchMsg = document.getElementById('filterNoMatch');
            if (!noMatchMsg) {
                const container = document.getElementById('filterOptions');
                noMatchMsg = document.createElement('div');
                noMatchMsg.id = 'filterNoMatch';
                noMatchMsg.style.padding = '0.5rem';
                noMatchMsg.style.color = '#64748b';
                noMatchMsg.style.fontSize = '0.85rem';
                noMatchMsg.style.textAlign = 'center';
                noMatchMsg.textContent = 'No Matches';
                container.appendChild(noMatchMsg);
            }
            noMatchMsg.style.display = hasMatch ? 'none' : 'block';
        };

        window.applyColumnFilter = () => {
            if (!currentFilterColumn) return;

            const checkboxes = Array.from(document.querySelectorAll('.option-item input[type="checkbox"]'));
            const selectedValues = checkboxes.filter(cb => cb.checked).map(cb => cb.value);

            // Get all possible values for the column from rawEvents to compare against
            const allColumnValues = new Set(rawEvents.map(e => {
                if (currentFilterColumn === 'eventDate') return formatDate(e[currentFilterColumn]);
                return e[currentFilterColumn] || '(Empty)';
            }));

            if (selectedValues.length === allColumnValues.size) {
                // All selected -> Clear filter for this column
                delete activeFilters[currentFilterColumn];
            } else {
                activeFilters[currentFilterColumn] = new Set(selectedValues);
            }

            closeFilter();
            processData(); // Filter -> Sort -> Render
        };

        window.processData = () => {
            // 1. Filter
            displayedEvents = rawEvents.filter(event => {
                // 1. Column Filters
                const matchesValidFilters = Object.keys(activeFilters).every(key => {
                    let val = event[key] || '(Empty)';
                    if (key === 'eventDate') val = formatDate(val);
                    return activeFilters[key].has(val);
                });

                if (!matchesValidFilters) return false;

                // 2. Date Range Filter
                const startStr = document.getElementById('dateRangeStart').value;
                const endStr = document.getElementById('dateRangeEnd').value;

                if (startStr && endStr) {
                    const eventDate = new Date(event.eventDate);
                    const startDate = new Date(startStr);
                    const endDate = new Date(endStr);
                    endDate.setHours(23, 59, 59, 999); // End of day

                    if (eventDate < startDate || eventDate > endDate) {
                        return false;
                    }
                }

                return true;
            });

            // Toggle Clear Dates button
            const startStr = document.getElementById('dateRangeStart').value;
            const endStr = document.getElementById('dateRangeEnd').value;
            const btnClearDates = document.getElementById('btnClearDates');
            if (btnClearDates) {
                btnClearDates.style.display = (startStr && endStr) ? 'inline-block' : 'none';
            }

            // 2. Sort
            applySort();

            // 3. Render
            renderEvents(displayedEvents);
            updateFilterIcons();
        }

        function updateFilterIcons() {
            // Reset all to default opacity
            document.querySelectorAll('.filter-icon').forEach(icon => {
                icon.style.opacity = '0.5';
                icon.style.color = 'currentColor'; // Reset to default color
            });

            // Highlight active
            const keys = ['eventName', 'eventDate', 'coordinatorName', 'status'];
            const icons = document.querySelectorAll('.filter-icon'); // Should be 4 in order
            if (icons.length === keys.length) {
                let hasActiveFilters = false;
                keys.forEach((key, index) => {
                    if (activeFilters[key] && activeFilters[key].size > 0) {
                        icons[index].style.opacity = '1';
                        icons[index].style.color = 'var(--primary-color)'; // Highlight
                        hasActiveFilters = true;
                    }
                });

                const btnReset = document.getElementById('btnClearFilters');
                if (btnReset) btnReset.style.display = hasActiveFilters ? 'inline-block' : 'none';
            }
        }

        window.clearAllFilters = () => {
            activeFilters = {};
            currentFilterColumn = null;
            clearDateRange(); // Reuse logic
            closeFilter();
            processData();
        };

        window.clearDateRange = () => {
            document.getElementById('dateRangeStart').value = '';
            document.getElementById('dateRangeEnd').value = '';
            processData();
        };

        // --- Sorting Logic ---
        window.handleSort = (key) => {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = 'asc';
            }
            processData(); // Filter -> Sort -> Render
        };

        function applySort() {
            if (!sortConfig.key) return;

            displayedEvents.sort((a, b) => {
                let valA = a[sortConfig.key] || '';
                let valB = b[sortConfig.key] || '';

                if (sortConfig.key === 'eventDate') {
                    // Handle dates
                    valA = new Date(valA).getTime() || 0;
                    valB = new Date(valB).getTime() || 0;
                } else {
                    // String comparison
                    valA = String(valA).toLowerCase();
                    valB = String(valB).toLowerCase();
                }

                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function updateSortIcons() {
            // Reset all icons
            ['eventName', 'eventDate', 'coordinatorName', 'status'].forEach(key => {
                const icon = document.getElementById(`sort-${key}`);
                if (icon) icon.textContent = '';
            });

            // Set active icon
            if (sortConfig.key) {
                const icon = document.getElementById(`sort-${sortConfig.key}`);
                if (icon) {
                    icon.textContent = sortConfig.direction === 'asc' ? ' ▲' : ' ▼';
                }
            }
        }

        // --- Selection Logic ---
        window.toggleSelectAll = (checked) => {
            if (checked) {
                displayedEvents.forEach(e => selectedEvents.add(e.id));
            } else {
                selectedEvents.clear();
            }
            // Use renderEvents directly on displayed to avoid re-sorting/filtering loop
            renderEvents(displayedEvents);
        };

        window.toggleEventSelection = (id, checked) => {
            if (checked) {
                selectedEvents.add(id);
            } else {
                selectedEvents.delete(id);
            }
            updateSelectionUI();
        };

        function updateSelectionUI() {
            const btn = document.getElementById('btnDownloadSelected');
            if (btn) {
                btn.innerText = `Download Selected (${selectedEvents.size})`;
                btn.disabled = selectedEvents.size === 0;
            }

            const selectAll = document.getElementById('selectAllCheckbox');
            if (selectAll) {
                const allSelected = displayedEvents.length > 0 && selectedEvents.size === displayedEvents.length;
                selectAll.checked = allSelected;
                selectAll.indeterminate = selectedEvents.size > 0 && selectedEvents.size < displayedEvents.length;
            }
        }

        function renderEvents(events) {
            const tbody = document.getElementById('eventTableBody');
            const mobileList = document.getElementById('mobileEventList');

            if (!tbody || !mobileList) return;

            tbody.innerHTML = '';
            mobileList.innerHTML = '';

            updateSortIcons();
            updateSelectionUI();

            if (events.length === 0) {
                const emptyHTML = `
                    <div class="empty-state" onclick="window.location.href='create-event.html'" style="cursor:pointer;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                        <p>No events found.</p>
                        <span style="color: var(--primary-color); margin-top: 0.5rem; display: inline-block;">Try adjusting filters or create a new event</span>
                    </div>
                `;
                tbody.innerHTML = '<tr><td colspan="7">' + emptyHTML + '</td></tr>';
                mobileList.innerHTML = emptyHTML;
                return;
            }

            events.forEach(event => {
                let statusClass = 'status-pending';
                if (event.status === 'Report Received') statusClass = 'status-received';
                if (event.status === 'Completed') statusClass = 'status-received';
                if (event.status === 'Under Review') statusClass = 'status-info';
                if (event.status === 'Changes Requested') statusClass = 'status-urgent';

                if (String(event.status).includes('Reminder 3')) statusClass = 'status-urgent';

                const isSelected = selectedEvents.has(event.id);

                // Desktop Row
                const tr = document.createElement('tr');
                tr.onclick = (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.closest('button')) return;
                    window.location.href = `event-detail.html?id=${event.id}`;
                };
                tr.style.cursor = 'pointer';

                tr.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" onchange="toggleEventSelection('${event.id}', this.checked)" ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${event.eventName}</td>
                    <td>${formatDate(event.eventDate)}</td>
                    <td>${event.coordinatorName}</td>
                    <td><span class="status-badge ${statusClass}">${event.status}</span></td>
                    <td>${event.reminderCount}</td>
                    <td>
                        <button onclick="window.location.href='event-detail.html?id=${event.id}'" class="btn btn-primary">View</button>
                        ${!event.creationEmailSent && event.status !== 'Completed' ? `
                            <button onclick="sendCreationEmail('${event.id}')" class="btn btn-primary" style="background: var(--primary-color); padding: 0.5rem 0.8rem;">Send Creation Email</button>
                        ` : ''}
                    </td>
                `;
                tbody.appendChild(tr);

                // Mobile Card
                const card = document.createElement('div');
                card.className = 'event-card-mobile';
                card.onclick = () => window.location.href = `event-detail.html?id=${event.id}`;

                card.innerHTML = `
                    <div class="event-card-header">
                        <span class="event-name">${event.eventName}</span>
                        <span class="status-badge ${statusClass}" style="font-size: 0.7rem;">${event.status}</span>
                    </div>
                    <div class="event-coordinator">
                        By ${event.coordinatorName}
                    </div>
                    <div class="event-date">
                        <svg style="width:14px;height:14px;fill:currentColor;opacity:0.7" viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
                        ${formatDate(event.eventDate)}
                    </div>
                `;
                mobileList.appendChild(card);
            });
        }

        function subscribeEvents() {
            window.showLoading("Loading Events...");
            // Returns unsubscribe function
            DBService.subscribeToEvents((events) => {
                rawEvents = events;
                // Preserve selection validity
                const currentIds = new Set(events.map(e => e.id));
                for (let id of selectedEvents) {
                    if (!currentIds.has(id)) selectedEvents.delete(id);
                }

                processData(); // Initialize displayedEvents and Render
                window.hideLoading();
            }, (error) => {
                console.error("Subscription error:", error);
                window.hideLoading();
            });
        }

        window.sendCreationEmail = async (eventId) => {
            const event = rawEvents.find(e => e.id === eventId);
            if (!event) return;

            window.showLoading("Sending Creation Email...");

            const scriptUrl = await DBService.getScriptUrl();
            const emailService = new EmailService(scriptUrl);

            const res = await emailService.sendEmail({
                emailType: 'EVENT_CREATION',
                to: event.coordinatorEmail,
                subject: `Report & Photos Submission: ${event.eventName}`,
                body: `
                    <p>Dear ${event.coordinatorName}</p>
                    <p>Thank you for successfully conducting the event (<b>${formatDate(event.eventDate)}</b>) : <b>${event.eventName}</b>. It was a valuable initiative for the College as well as the IQAC.</p>
                    <p>To facilitate immediate documentation and promotion, we kindly request you to share a short summary and a few high-quality photos of the event today itself, if possible. Please send these by replying to this email or via WhatsApp to Mr. Jobins. (9562066053) </p>
                    <p>Additionally, please ensure that a detailed report is updated in the prescribed format under the Events menu in EMBASE.</p>
                    <p>Thank you for your cooperation.</p>
                    <br>
                    <p>Warm regards,<br>IQAC</p>
                `,
                priority: 'NORMAL'
            });

            if (res.success || res.status === 'success') {
                await DBService.updateEvent(event.id, { creationEmailSent: true });
                window.showAlert("Success", "Creation email sent successfully.");
            } else {
                window.showAlert("Error", "Failed to send creation email. Check script URL.");
            }

            window.hideLoading();
        };

        // --- Download Logic ---
        function formatForExport(eventsToExport) {
            return eventsToExport.map(e => ({
                'Event Name': e.eventName,
                'Date': formatDate(e.eventDate),
                'Coordinator': e.coordinatorName,
                'Department': e.department || '',
                'Status': e.status,
                'Reminders Sent': e.reminderCount,
                'Description': e.description || ''
            }));
        }

        window.downloadSelected = () => {
            if (selectedEvents.size === 0) return;
            // Download from DISPLAYED events that are selected approx, 
            // but simpler: find from RAW events filter by ID.
            const eventsToExport = rawEvents.filter(e => selectedEvents.has(e.id));
            const data = formatForExport(eventsToExport);
            CSVExport.downloadCSV(data, 'SSV_Selected_Events.csv');
        };

        window.downloadDateRange = () => {
            const startStr = document.getElementById('dateRangeStart').value;
            const endStr = document.getElementById('dateRangeEnd').value;

            if (!startStr || !endStr) {
                window.showAlert("Input Error", "Please select both Start and End dates.");
                return;
            }

            const startDate = new Date(startStr);
            const endDate = new Date(endStr);
            endDate.setHours(23, 59, 59, 999);

            // Export based on Date Range irrespective of current filters? 
            // Usually date range export implies "Get me everything in this range".
            // So we use rawEvents.
            const eventsToExport = rawEvents.filter(e => {
                const eventDate = new Date(e.eventDate);
                return eventDate >= startDate && eventDate <= endDate;
            });

            if (eventsToExport.length === 0) {
                window.showAlert("No Data", "No events found in the selected date range.");
                return;
            }

            const data = formatForExport(eventsToExport);
            CSVExport.downloadCSV(data, `SSV_Events_${startStr}_to_${endStr}.csv`);
        };

        window.exportCSV = () => {
            // Export All visible or All raw? Usually "Export CSV" on a filtered table implies "Export what I see".
            // But original request "download the data customized" might imply what is filtered.
            // Let's standard "Export All" = Raw, and maybe add "Export Filtered View"?
            // Instructions said "rename Export CSV to Export All". So it should export ALL.
            const data = formatForExport(rawEvents);
            CSVExport.downloadCSV(data, 'SSV_All_Events.csv');
        };

        window.showAlert = (title, msg) => {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMessage').innerText = msg;
            document.getElementById('customAlert').classList.add('active');
        };

        // Profile Functions
        window.openProfile = () => {
            const user = firebase.auth().currentUser;
            if (!user) return;

            document.getElementById('profileEmail').value = user.email;

            const verifyDiv = document.getElementById('verificationSection');
            if (user.emailVerified) {
                verifyDiv.innerHTML = '<span class="status-badge status-received">Email Verified</span>';
            } else {
                verifyDiv.innerHTML = `
                    <span class="status-badge status-urgent">Not Verified</span>
                    <button onclick="sendVerification()" class="btn btn-primary" style="margin-top:0.5rem; font-size:0.8rem; padding: 0.3rem 0.6rem;">Send Verification Email</button>
                `;
            }

            document.getElementById('profileModal').classList.add('active');
        };

        window.sendVerification = async () => {
            const user = firebase.auth().currentUser;
            if (user) {
                try {
                    await user.sendEmailVerification();
                    window.showAlert("Success", "Verification email sent! Please check your inbox.");
                } catch (error) {
                    window.showAlert("Error", error.message);
                }
            }
        };

        window.updateProfile = async () => {
            const user = firebase.auth().currentUser;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmNewPassword').value;

            if (newPass || confirmPass) {
                if (newPass !== confirmPass) {
                    return window.showAlert("Error", "Passwords do not match.");
                }
                if (newPass.length < 6) {
                    return window.showAlert("Error", "Password must be at least 6 characters.");
                }

                try {
                    await user.updatePassword(newPass);
                    window.showAlert("Success", "Password updated successfully.");
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } catch (error) {
                    window.showAlert("Error", "Failed to update password: " + error.message);
                    // Often requires re-login if sensitive
                }
            } else {
                window.showAlert("Info", "No changes made (password field empty).");
            }
        };

        const unsubscribe = subscribeEvents();
        window.addEventListener('beforeunload', () => {
            if (unsubscribe && typeof unsubscribe === 'function') unsubscribe();
        });

        // Check for hash to open profile
        if (window.location.hash === '#profile') {
            setTimeout(openProfile, 500); // Small delay to ensuring loading
            // Clear hash to avoid reopening on refresh
            history.replaceState(null, null, ' ');
        }
    </script>
</body>

</html>