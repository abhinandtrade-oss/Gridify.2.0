<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Verification - EduPortal Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/main.css">
</head>

<body style="background-color: #f3f4f6;">

    <header style="background: #1F2937; color: white;">
        <div class="container navbar">
            <div class="logo" style="color: white; cursor: pointer;" onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </div>
            <div class="nav-cta" style="display: flex; gap: 1rem; align-items: center;">
                <span id="admin-name">loading...</span>
                <button id="logout-btn" class="btn btn-sm btn-secondary"
                    style="background: transparent; color: white; border-color: rgba(255,255,255,0.3);">Logout</button>
            </div>
        </div>
    </header>

    <div class="container" style="padding: var(--spacing-lg) var(--spacing-sm);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h1 style="margin: 0; font-size: 1.8rem;">Payment Verification</h1>
                <p style="color: var(--text-muted);">Approve enrollment requests for premium courses.</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button id="view-report-btn" class="btn btn-sm btn-primary"
                    style="display: none; background: #10B981; border-color: #10B981;"
                    onclick="window.location.href='payment_report.html'"><i class="fas fa-file-invoice-dollar"></i> View
                    History</button>
                <button class="btn btn-sm btn-secondary" onclick="loadPayments()"><i class="fas fa-sync"></i>
                    Refresh</button>
            </div>
        </div>

        <div class="card" style="padding: 1.5rem;">
            <div class="table-responsive">
                <table class="table" style="width: 100%; border-collapse: collapse; min-width: 600px;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 2px solid #eee;">
                            <th style="padding: 1rem;">Student</th>
                            <th style="padding: 1rem;">Course</th>
                            <th style="padding: 1rem;">Amount</th>
                            <th style="padding: 1rem;">Date</th>
                            <th style="padding: 1rem; text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="payments-list">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 3rem;">
                                <i class="fas fa-spinner fa-spin fa-2x"></i>
                                <p>Loading pending payments...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div id="approve-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <h2 style="margin-bottom: 1.5rem;">Approve Payment</h2>
            <form id="approve-form">
                <input type="hidden" id="app-payment-id">

                <div
                    style="background: #f9fafb; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #eee;">
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Student:</p>
                    <p id="app-student-name" style="font-weight: 700; margin: 0 0 0.5rem 0;"></p>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Course:</p>
                    <p id="app-course-title" style="font-weight: 700; margin: 0 0 0.5rem 0;"></p>
                    <div
                        style="display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 0.5rem; margin-top: 0.5rem;">
                        <div>
                            <p style="margin: 0; font-size: 0.9rem; color: #666;">Course Fee:</p>
                            <p id="app-amount" style="font-weight: 700; margin: 0; color: #666;"></p>
                        </div>
                        <div style="text-align: right;">
                            <p style="margin: 0; font-size: 0.9rem; color: #666;">Final Payable:</p>
                            <p id="app-final-amount-display"
                                style="font-weight: 800; margin: 0; color: #10B981; font-size: 1.25rem;"></p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Payment Mode</label>
                    <select id="app-mode" class="form-control" required onchange="toggleDiscountField()">
                        <option value="">Select mode...</option>
                        <option value="Cash">Cash</option>
                        <option value="UPI">UPI (PhonePe/GooglePay)</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Credit/Debit Card">Credit/Debit Card</option>
                        <option value="Scholarship/Offer">Scholarship/Offer</option>
                    </select>
                </div>

                <div id="discount-container"
                    style="display: none; background: #FFF7ED; padding: 1rem; border-radius: 8px; border: 1px solid #FED7AA; margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Discount Amount (₹)</label>
                        <input type="number" id="app-discount" class="form-control" placeholder="e.g. 100" min="0">
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Discount Reason / Coupon</label>
                        <input type="text" id="app-discount-reason" class="form-control"
                            placeholder="e.g. Merit Scholarship">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Collected By (Staff)</label>
                    <input type="text" id="app-staff" class="form-control" readonly>
                    <small style="color: #666;">Auto-filled with your name.</small>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('approve-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #10B981; border-color: #10B981;">
                        <i class="fas fa-check-circle"></i> Approve & Enroll
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rejection Modal -->
    <div id="reject-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 1000;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <h2 style="margin-bottom: 1.5rem; color: #EF4444;">Reject Payment Request</h2>
            <form id="reject-form">
                <input type="hidden" id="rej-payment-id">

                <div
                    style="background: #FEF2F2; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #FCA5A5;">
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Student:</p>
                    <p id="rej-student-name" style="font-weight: 700; margin: 0 0 0.5rem 0;"></p>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Course:</p>
                    <p id="rej-course-title" style="font-weight: 700; margin: 0 0 0.5rem 0;"></p>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">Amount:</p>
                    <p id="rej-amount" style="font-weight: 700; margin: 0; color: #EF4444; font-size: 1.1rem;"></p>
                </div>

                <div class="form-group">
                    <label class="form-label">Rejection Reason <span style="color: #EF4444;">*</span></label>
                    <textarea id="rej-reason" class="form-control" rows="4" required
                        placeholder="Please provide a clear reason for rejection..."></textarea>
                    <small style="color: #666;">This will be sent to the student as a notification.</small>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('reject-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background: #EF4444; border-color: #EF4444;">
                        <i class="fas fa-times-circle"></i> Reject Request
                    </button>
                </div>
            </form>
        </div>
    </div>

    <footer style="text-align: center; padding: 2rem; color: #6b7280; font-size: 0.85rem; margin-top: auto;">
        powered by <a href="https://www.gridify.in" target="_blank"
            style="color: inherit; text-decoration: underline;">Gridify</a>
    </footer>

    <script type="module" src="../scripts/firebase-config.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/db.js"></script>

    <script>
        let pendingPayments = [];
        let paymentsUnsubscribe = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const isAuth = await Auth.checkProtection('admin');
            if (!isAuth) return;

            document.getElementById('admin-name').innerText = Auth.userProfile.name || 'Admin';
            document.getElementById('app-staff').value = Auth.userProfile.name || 'Admin';

            if (Auth.userProfile && Auth.userProfile.role !== 'staff') {
                const reportBtn = document.getElementById('view-report-btn');
                if (reportBtn) reportBtn.style.display = 'block';
            }

            setupRealtimePayments();
        });

        function setupRealtimePayments() {
            // Remove old listener if exists
            if (paymentsUnsubscribe) paymentsUnsubscribe();

            // Setup real-time listener
            paymentsUnsubscribe = DB.listenToPendingPayments((payments) => {
                pendingPayments = payments;
                renderPayments();
            });
        }

        async function loadPayments() {
            // This function now triggers the real-time listener setup
            setupRealtimePayments();
        }

        function renderPayments() {
            const list = document.getElementById('payments-list');
            if (pendingPayments.length === 0) {
                list.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 3rem; color: #666;">No pending payment requests found.</td></tr>';
                return;
            }

            list.innerHTML = pendingPayments.map(p => `
                <tr style="border-bottom: 1px solid #f9fafb;">
                    <td style="padding: 1rem;">
                        <div style="font-weight: 600;">${p.userName}</div>
                        <div style="font-size: 0.8rem; color: #666;">${p.userEmail}</div>
                    </td>
                    <td style="padding: 1rem;">${p.courseTitle}</td>
                    <td style="padding: 1rem; font-weight: 700; color: var(--primary-color);">₹${p.price}</td>
                    <td style="padding: 1rem; font-size: 0.85rem; color: #666;">
                        ${p.createdAt ? new Date(p.createdAt.seconds * 1000).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) : 'N/A'}
                    </td>
                    <td style="padding: 1rem; text-align: right;">
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button class="btn btn-sm btn-primary" style="background: #10B981; border-color: #10B981;" 
                                onclick="openApproveModal('${p.id}')">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-sm btn-secondary" style="background: #EF4444; border-color: #EF4444; color: white;" 
                                onclick="openRejectModal('${p.id}')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        window.openApproveModal = (id) => {
            const payment = pendingPayments.find(p => p.id === id);
            if (!payment) return;

            document.getElementById('app-payment-id').value = id;
            document.getElementById('app-student-name').innerText = payment.userName;
            document.getElementById('app-course-title').innerText = payment.courseTitle;
            document.getElementById('app-amount').innerText = '₹' + payment.price;
            document.getElementById('app-amount').dataset.price = payment.price;

            // Reset and show modal
            document.getElementById('app-discount').value = '';
            document.getElementById('app-discount-reason').value = '';
            updateFinalAmount();
            document.getElementById('approve-modal').style.display = 'flex';
        };

        window.closeModal = (id) => {
            document.getElementById(id).style.display = 'none';
        };

        window.toggleDiscountField = () => {
            const mode = document.getElementById('app-mode').value;
            const container = document.getElementById('discount-container');
            if (mode === 'Scholarship/Offer') {
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
                // Optional: clear discount if not in scholarship mode? 
                // Better to keep it if they accidental switched and switched back, 
                // but we must ensure it's handled in submit.
            }
            updateFinalAmount();
        };

        // Add event listener for discount input to update final amount live
        document.getElementById('app-discount').addEventListener('input', () => {
            updateFinalAmount();
        });

        function updateFinalAmount() {
            const originalPrice = parseFloat(document.getElementById('app-amount').dataset.price) || 0;
            const mode = document.getElementById('app-mode').value;
            const discount = mode === 'Scholarship/Offer' ? (parseFloat(document.getElementById('app-discount').value) || 0) : 0;
            const finalPrice = Math.max(0, originalPrice - discount);

            // We'll update a new element if it exists, or just update the UI
            const finalEl = document.getElementById('app-final-amount-display');
            if (finalEl) {
                finalEl.innerText = '₹' + finalPrice;
            }
        }

        window.openRejectModal = (id) => {
            const payment = pendingPayments.find(p => p.id === id);
            if (!payment) return;

            document.getElementById('rej-payment-id').value = id;
            document.getElementById('rej-student-name').innerText = payment.userName;
            document.getElementById('rej-course-title').innerText = payment.courseTitle;
            document.getElementById('rej-amount').innerText = '₹' + payment.price;

            document.getElementById('reject-modal').style.display = 'flex';
        };

        document.getElementById('approve-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('app-payment-id').value;
            const mode = document.getElementById('app-mode').value;
            const staff = document.getElementById('app-staff').value;

            // Only apply discount if mode is Scholarship/Offer
            const discount = mode === 'Scholarship/Offer' ? (parseFloat(document.getElementById('app-discount').value) || 0) : 0;
            const reason = document.getElementById('app-discount-reason').value;
            const originalPrice = parseFloat(document.getElementById('app-amount').dataset.price) || 0;
            const finalPrice = Math.max(0, originalPrice - discount);

            try {
                await DB.approvePayment(id, {
                    paymentMode: mode,
                    collectedBy: staff,
                    adminUid: Auth.currentUser.uid,
                    adminName: Auth.userProfile.name,
                    discountAmount: discount,
                    discountReason: reason,
                    finalPrice: finalPrice
                });

                Auth.showToast('Payment Approved & Student Enrolled!', 'success');
                closeModal('approve-modal');
            } catch (error) {
                Auth.showToast('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('reject-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('rej-payment-id').value;
            const reason = document.getElementById('rej-reason').value;

            if (!reason.trim()) {
                Auth.showToast('Please provide a rejection reason', 'error');
                return;
            }

            try {
                await DB.rejectPayment(id, {
                    reason: reason,
                    rejectedBy: Auth.userProfile.name || 'Admin',
                    adminUid: Auth.currentUser.uid,
                    adminName: Auth.userProfile.name
                });

                Auth.showToast('Payment Request Rejected', 'success');
                closeModal('reject-modal');
                document.getElementById('rej-reason').value = '';
            } catch (error) {
                Auth.showToast('Error: ' + error.message, 'error');
            }
        });
    </script>
</body>

</html>