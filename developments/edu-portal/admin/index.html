<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - EduPortal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/main.css">
</head>

<body style="background-color: #f3f4f6;">

    <header style="background: #1F2937; color: white;">
        <div class="container navbar">
            <div class="logo" style="color: white;"><i class="fas fa-user-shield"></i> EduPortal Admin</div>
            <div class="nav-cta" style="display: flex; gap: 1rem; align-items: center;">
                <span id="admin-name">Admin</span>
                <button onclick="openModal('change-pass-modal')" class="btn btn-sm"
                    style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);">Change
                    Password</button>
                <button id="logout-btn" class="btn btn-sm btn-secondary"
                    style="background: transparent; color: white; border-color: rgba(255,255,255,0.3);">Logout</button>
            </div>
        </div>
    </header>

    <!-- ... Content ... -->

    <!-- Change Password Modal -->
    <div id="change-pass-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10001;">
        <div class="card" style="width: 90%; max-width: 400px; padding: 2rem;">
            <h3 style="margin-bottom: 1rem;">Change Password</h3>
            <form id="change-pass-form">
                <div class="form-group">
                    <label class="form-label">Current Password</label>
                    <input type="password" id="current-pass" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">New Password</label>
                    <input type="password" id="new-pass" class="form-control" required minlength="4"
                        placeholder="Min 4 characters">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" id="confirm-pass" class="form-control" required minlength="4">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('change-pass-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>

    <div class="container" style="padding: var(--spacing-lg) var(--spacing-sm);">

        <!-- Stats -->
        <div class="card-grid"
            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: var(--spacing-lg);">
            <style>
                @media (max-width: 1024px) {
                    .card-grid {
                        grid-template-columns: repeat(2, 1fr) !important;
                    }
                }

                @media (max-width: 600px) {
                    .card-grid {
                        grid-template-columns: 1fr !important;
                    }
                }
            </style>
            <div class="card" style="padding: 1.5rem; text-align: center;" id="sys-status-card">
                <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="sys-status-text">Online
                </div>
                <div style="color: var(--text-muted);">System Status</div>
                <div id="sys-toggle-container" style="margin-top: 10px;"></div>
            </div>
            <div class="card"
                style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s; border: 1px dashed #F59E0B; display:none;"
                id="stat-firebase-card" onclick="promptFirebaseAccess()"
                onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #F59E0B;"><i class="fas fa-fire"></i></div>
                <div style="color: var(--text-muted);">Firebase Config</div>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s;"
                onclick="openModal('sub-status-modal')" onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #4F46E5;"><i class="fas fa-crown"></i></div>
                <div style="color: var(--text-muted);">Subscription Status</div>
                <div style="font-size: 0.75rem; color: #6366F1; margin-top: 5px;">Platform Portal <i
                        class="fas fa-external-link-alt"></i></div>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s;"
                onclick="window.location.href='users.html'" onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700;" id="stat-users">-</div>
                <div style="color: var(--text-muted);">Total Users</div>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s;"
                onclick="window.location.href='courses.html'" onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: var(--success-color);" id="stat-courses">-</div>
                <div style="color: var(--text-muted);">Total Courses</div>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s;"
                onclick="window.location.href='payments.html'" onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #F59E0B;" id="stat-payments">-</div>
                <div style="color: var(--text-muted);">Pending Payments</div>
            </div>

            <!-- Site Settings Card (Super Admin Only) -->
            <div class="card"
                style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s; display: none;"
                id="stat-settings-card" onclick="openSettingsModal()" onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);"><i class="fas fa-cogs"></i>
                </div>
                <div style="color: var(--text-muted);">Site Settings</div>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s;"
                onclick="window.location.href='reviews.html'" onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #8B5CF6;" id="stat-reviews">-</div>
                <div style="color: var(--text-muted);">Pending Reviews</div>
            </div>
            <div class="card"
                style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s; display:none;"
                id="stat-cats-card" onclick="openCategoriesModal()" onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #10B981;" id="stat-categories">-</div>
                <div style="color: var(--text-muted);">Total Categories</div>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s;"
                onclick="openModal('verify-cert-modal')" onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #EC4899;"><i class="fas fa-certificate"></i></div>
                <div style="color: var(--text-muted);">Verify Certificate</div>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s;"
                onclick="openModal('contacts-modal')" onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #10B981;" id="stat-contacts">-</div>
                <div style="color: var(--text-muted);">Contact Messages</div>
            </div>
            <div class="card" style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s;"
                onclick="openProvidedCertsModal()" onmouseover="this.style.transform='scale(1.02)'"
                onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #6366F1;" id="stat-certificates">-</div>
                <div style="color: var(--text-muted);">Provided Certificates</div>
            </div>
            <div class="card"
                style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s; display:none;"
                id="stat-pricing-card" onclick="window.location.href='pricing.html'"
                onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #EC4899;"><i class="fas fa-tags"></i></div>
                <div style="color: var(--text-muted);">Course Pricing</div>
            </div>
            <div class="card"
                style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s; display:none;"
                id="stat-reports-card" onclick="window.location.href='payment_report.html'"
                onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #10B981;"><i class="fas fa-chart-line"></i></div>
                <div style="color: var(--text-muted);">Payment Report</div>
            </div>

            <div class="card"
                style="padding: 1.5rem; text-align: center; cursor: pointer; transition: transform 0.2s; border: 1px solid #fee2e2;"
                id="stat-duplicates-card" onclick="openDuplicatesModal()"
                onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                <div style="font-size: 2rem; font-weight: 700; color: #EF4444;" id="stat-duplicates">0</div>
                <div style="color: var(--text-muted);">Duplicate Certs</div>
                <small id="dup-alert" style="display:none; color: #EF4444; font-weight: 600;">(Action Required)</small>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: var(--spacing-lg);">

            <!-- Sidebar Controls -->
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div class="card" style="padding: 1rem;">
                    <h3 style="margin-bottom: 1rem;">Quick Actions</h3>
                    <button class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;"
                        onclick="openModal('live-modal')"><i class="fas fa-video"></i> Start Live Class</button>
                    <a href="reviews.html" class="btn btn-primary"
                        style="width: 100%; margin-bottom: 0.5rem; text-align: center; display:block; background: #8B5CF6; border-color: #8B5CF6;"><i
                            class="fas fa-clipboard-check"></i> Exam Reviews</a>
                    <a href="payment_report.html" class="btn btn-primary" id="side-report-btn"
                        style="width: 100%; margin-bottom: 0.5rem; text-align: center; display:none; background: #10B981; border-color: #10B981;"><i
                            class="fas fa-file-invoice-dollar"></i> Payment Report</a>
                    <button class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;"
                        onclick="openModal('course-modal')"><i class="fas fa-plus"></i> Add New Course</button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="openModal('user-modal')"><i
                            class="fas fa-user-plus"></i> Add
                        User</button>
                    <a href="users.html" class="btn btn-secondary"
                        style="width: 100%; margin-top: 0.5rem; text-align: center; display:block;"><i
                            class="fas fa-users"></i> Manage Users</a>
                </div>
            </div>

            <!-- Main Panel: Activity & Notifications -->
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                <!-- Recent Activities -->

                <div class="card" style="padding: var(--spacing-lg); flex: 1;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0;">Recent Activities & Alerts</h3>
                        <button class="btn btn-sm btn-secondary" onclick="loadActivities()"><i class="fas fa-sync"></i>
                            Refresh</button>
                    </div>

                    <div id="activity-feed" style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p>Fetching latest updates...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Live Class Modal -->
    <div id="live-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <h2 style="margin-bottom: 1rem;">Start Live Session</h2>
            <form onsubmit="event.preventDefault(); alert('Feature coming soon'); closeModal('live-modal');">
                <div class="form-group">
                    <label class="form-label">Session Title</label>
                    <input type="text" class="form-control" required>
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('live-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Go Live</button>
                </div>
            </form>
        </div>
    </div>

    <div id="course-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <h2 style="margin-bottom: 1rem;">Add New Course</h2>
            <form id="add-course-form">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" id="c-title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="c-desc" class="form-control" require></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="c-cat" class="form-control">
                        <option value="">Loading categories...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="c-premium"> Is Premium?
                    </label>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('course-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Course</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="user-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <h2 style="margin-bottom: 1rem;">Add New User</h2>
            <form id="add-user-form">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="u-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="u-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="u-pass" class="form-control" required minlength="4">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="u-role" class="form-control">
                        <option value="student">Student</option>
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                        <option value="head_admin">Head Admin</option>
                    </select>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('user-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- System Offline Reason Modal -->
    <div id="offline-reason-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 9999;">
        <div class="card" style="width: 90%; max-width: 400px; padding: 2rem;">
            <h3 style="margin-bottom: 1rem;">Set System Offline</h3>
            <p style="margin-bottom: 1rem; color: #666;">Please select a reason for taking the system offline:</p>

            <div style="margin-bottom: 1rem;">
                <div style="margin-bottom: 0.5rem;">
                    <input type="radio" name="offline-reason" id="reason-dev" value="Under Maintenance" checked
                        onchange="toggleCustomReason(false)">
                    <label for="reason-dev">Under Maintenance</label>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <input type="radio" name="offline-reason" id="reason-sub" value="Platform Subscription Expired"
                        onchange="toggleCustomReason(false)">
                    <label for="reason-sub">Platform Subscription Expired</label>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <input type="radio" name="offline-reason" id="reason-custom" value="custom"
                        onchange="toggleCustomReason(true)">
                    <label for="reason-custom">Custom Input</label>
                </div>
                <div id="custom-reason-input" style="display: none; margin-top: 0.5rem;">
                    <input type="text" id="reason-text" class="form-control" placeholder="Enter reason here...">
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn btn-secondary" onclick="closeModal('offline-reason-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmOffline()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Contact Messages Modal -->
    <div id="contacts-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10007;">
        <div class="card"
            style="width: 95%; max-width: 900px; padding: 2rem; max-height: 90vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Contact Messages</h2>
                <button class="btn btn-sm btn-secondary" onclick="closeModal('contacts-modal')">&times;</button>
            </div>

            <div style="overflow-y: auto; flex: 1;">
                <table class="table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 2px solid #eee;">
                            <th style="padding: 1rem;">From</th>
                            <th style="padding: 1rem;">WhatsApp</th>
                            <th style="padding: 1rem;">Message</th>
                            <th style="padding: 1rem;">Date</th>
                            <th style="padding: 1rem;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="contacts-list">
                        <!-- Loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Verify Certificate Modal -->
    <div id="verify-cert-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10003;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Verify Certificate</h2>
                <button class="btn btn-sm btn-secondary" onclick="closeModal('verify-cert-modal')">&times;</button>
            </div>

            <form id="verify-cert-form" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                <input type="text" id="verify-cert-id" class="form-control"
                    placeholder="Enter Certificate ID (e.g. GRD-CERT-...)" required>
                <button type="submit" class="btn btn-primary">Check</button>
            </form>

            <div id="verify-result"
                style="display: none; padding: 1rem; border-radius: 8px; border: 1px solid #eee; background: #f9fafb;">
                <!-- Results injected here -->
            </div>
        </div>
    </div>
    <!-- Provided Certificates Modal -->
    <div id="provided-certs-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10004;">
        <div class="card" style="width: 95%; max-width: 800px; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Provided Certificates</h2>
                <button class="btn btn-sm btn-secondary" onclick="closeModal('provided-certs-modal')">&times;</button>
            </div>

            <div style="margin-bottom: 1rem;">
                <input type="text" id="cert-search-input" class="form-control"
                    placeholder="Search by student name, course or cert ID..." onkeyup="filterProvidedCerts()">
            </div>

            <div style="overflow-x: auto;">
                <table class="table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 2px solid #eee;">
                            <th style="padding: 1rem;">Student</th>
                            <th style="padding: 1rem;">Course</th>
                            <th style="padding: 1rem;">ID</th>
                            <th style="padding: 1rem;">Date</th>
                            <th style="padding: 1rem;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="provided-certs-list">
                        <!-- Loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="categories-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10002;">
        <div class="card" style="width: 90%; max-width: 450px; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Manage Categories</h2>
                <button class="btn btn-sm btn-secondary" onclick="closeModal('categories-modal')">&times;</button>
            </div>

            <form id="add-category-form" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
                <input type="text" id="new-cat-name" class="form-control" placeholder="New category name..." required>
                <button type="submit" class="btn btn-primary">Add</button>
            </form>

            <div id="categories-list"
                style="max-height: 350px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem;">
                <!-- Categories will be loaded here -->
            </div>
        </div>
    </div>
    <!-- Duplicate Certificates Modal -->
    <div id="duplicates-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10005;">
        <div class="card"
            style="width: 95%; max-width: 900px; padding: 2rem; max-height: 90vh; display: flex; flex-direction: column;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Duplicate Certificates Detected</h2>
                <button class="btn btn-sm btn-secondary" onclick="closeModal('duplicates-modal')">&times;</button>
            </div>

            <p style="color: var(--text-muted); margin-bottom: 1rem;">Users listed below have multiple certificates for
                the same course. Please review and revoke unnecessary ones.</p>

            <div style="overflow-y: auto; flex: 1;" id="duplicates-list-container">
                <table class="table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 2px solid #eee;">
                            <th style="padding: 1rem;">Student & Course</th>
                            <th style="padding: 1rem;">Certificate History (Select to Revoke)</th>
                        </tr>
                    </thead>
                    <tbody id="duplicates-list">
                        <!-- Loaded dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Platform Subscription Status Modal (Popup) -->
    <div id="sub-status-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10006;">
        <div class="card"
            style="width: 95%; height: 90vh; max-width: 1200px; padding: 0; overflow: hidden; display: flex; flex-direction: column; position: relative;">
            <div
                style="padding: 1rem 1.5rem; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 1.25rem;"><i class="fas fa-crown" style="color: #4F46E5;"></i> Platform
                    Subscription</h2>
                <button class="btn btn-sm btn-secondary" onclick="closeModal('sub-status-modal')"
                    style="border-radius: 50%; width: 32px; height: 32px; padding: 0;">&times;</button>
            </div>
            <iframe src="https://gridify.in/sub/check" style="flex: 1; width: 100%; border: none;"></iframe>
        </div>
    </div>

    <!-- Firebase Config Modal -->
    <div id="firebase-config-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10008;">
        <div class="card" style="width: 95%; max-width: 600px; padding: 2rem; max-height: 90vh; overflow-y:auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">Firebase Configuration</h2>
                <button class="btn btn-sm btn-secondary" onclick="closeModal('firebase-config-modal')">&times;</button>
            </div>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                Update your Firebase connection settings. Changes will be saved to your browser session.
            </p>
            <form id="firebase-config-form">
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="text" id="fb-apiKey" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Auth Domain</label>
                    <input type="text" id="fb-authDomain" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Project ID</label>
                    <input type="text" id="fb-projectId" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Storage Bucket</label>
                    <input type="text" id="fb-storageBucket" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Messaging Sender ID</label>
                    <input type="text" id="fb-messagingSenderId" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">App ID</label>
                    <input type="text" id="fb-appId" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Measurement ID</label>
                    <input type="text" id="fb-measurementId" class="form-control">
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="downloadConfigFile()"
                        title="Download as firebase-config.js">
                        <i class="fas fa-download"></i> Download File
                    </button>
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('firebase-config-modal')">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Re-Auth Modal -->
    <div id="firebase-reauth-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10009;">
        <div class="card" style="width: 90%; max-width: 400px; padding: 2rem;">
            <h3 style="margin-bottom: 1rem;">Security Check</h3>
            <p style="margin-bottom: 1rem; color: #666;">Please confirm your password to access sensitive configuration.
            </p>
            <form id="firebase-reauth-form">
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="reauth-pass" class="form-control" required
                        autocomplet="current-password">
                </div>
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('firebase-reauth-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Verify</button>
                </div>
            </form>
        </div>
    </div>

    <footer style="text-align: center; padding: 2rem; color: #6b7280; font-size: 0.85rem; margin-top: auto;">
        powered by <a href="https://www.gridify.in" target="_blank"
            style="color: inherit; text-decoration: underline;">Gridify</a>
    </footer>

    <!-- Site Settings Modal -->
    <div id="settings-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 10009;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <h2 style="margin-bottom: 1.5rem;">Edit Site Settings</h2>

            <div id="settings-loading" style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
            </div>

            <form id="settings-form" onsubmit="saveSettings(event)" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Site Name</label>
                    <input type="text" id="set-name" class="form-control" placeholder="e.g. EduPortal">
                </div>
                <div class="form-group">
                    <label class="form-label">Logo URL</label>
                    <input type="text" id="set-logo" class="form-control" placeholder="https://example.com/logo.png">
                    <small style="color: #666;">Leave empty to use default icon.</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Logo Size (Height)</label>
                    <input type="text" id="set-logo-size" class="form-control" placeholder="e.g. 30px or 2rem">
                    <small style="color: #666;">Default is 30px.</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Primary Color Theme</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="color" id="set-color" class="form-control"
                            style="width: 60px; padding: 2px; height: 40px;" value="#4F46E5">
                        <span style="font-size: 0.9rem; color: #666;">Choose the main brand color.</span>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('settings-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module" src="../scripts/firebase-config.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/db.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuth = await Auth.checkProtection('admin');
            if (!isAuth) return;

            // Show Site Settings for Super Admin
            if (Auth.userProfile.role === 'super_admin') {
                const settingsCard = document.getElementById('stat-settings-card');
                if (settingsCard) settingsCard.style.display = 'block';
            }

            // Load Data
            const stats = await DB.getStats();
            document.getElementById('stat-users').innerText = stats.users;
            document.getElementById('stat-courses').innerText = stats.courses;
            document.getElementById('stat-payments').innerText = stats.pendingPayments;
            document.getElementById('stat-reviews').innerText = stats.pendingReviews;
            document.getElementById('stat-categories').innerText = stats.categories;
            document.getElementById('stat-certificates').innerText = stats.certificates;
            document.getElementById('stat-contacts').innerText = stats.contacts;

            // Load Categories for Course Modal
            loadCategoryOptions();

            // Role based UI
            if (Auth.userProfile && Auth.userProfile.role !== 'staff') {
                document.getElementById('stat-cats-card').style.display = 'block';
                const pricingCard = document.getElementById('stat-pricing-card');
                if (pricingCard) pricingCard.style.display = 'block';
                const reportCard = document.getElementById('stat-reports-card');
                if (reportCard) reportCard.style.display = 'block';
                const sideReportBtn = document.getElementById('side-report-btn');
                if (sideReportBtn) sideReportBtn.style.display = 'block';
            }

            // System Status Logic
            const sysStatus = await DB.getSystemStatus();
            const statusText = document.getElementById('sys-status-text');
            const statusCard = document.getElementById('sys-status-card'); // Not used effectively yet but good to have

            if (sysStatus === 'offline') {
                statusText.innerText = 'Offline';
                statusText.style.color = 'var(--danger-color)';
            } else {
                statusText.innerText = 'Online';
                statusText.style.color = 'var(--primary-color)';
            }

            // Super Admin Controls
            if (Auth.userProfile && Auth.userProfile.role === 'super_admin') {
                // Show Firebase Config Card
                document.getElementById('stat-firebase-card').style.display = 'block';

                const container = document.getElementById('sys-toggle-container');
                const btn = document.createElement('button');
                btn.className = sysStatus === 'offline' ? 'btn btn-sm btn-success' : 'btn btn-sm btn-danger';
                btn.innerHTML = sysStatus === 'offline' ? '<i class="fas fa-power-off"></i> Go Online' : '<i class="fas fa-power-off"></i> Go Offline';

                btn.onclick = async () => {
                    const newStatus = sysStatus === 'offline' ? 'online' : 'offline';

                    if (newStatus === 'offline') {
                        // Open Logic Modal
                        document.getElementById('offline-reason-modal').style.display = 'flex';
                    } else {
                        // Go Online
                        if (confirm(`Are you sure you want to take the system ONLINE?`)) {
                            await DB.setSystemStatus('online');
                            window.location.reload();
                        }
                    }
                };
                container.appendChild(btn);

                // Add Global Logic for Offline Modal
                window.toggleCustomReason = (show) => {
                    document.getElementById('custom-reason-input').style.display = show ? 'block' : 'none';
                };

                window.confirmOffline = async () => {
                    let reason = document.querySelector('input[name="offline-reason"]:checked').value;
                    if (reason === 'custom') {
                        reason = document.getElementById('reason-text').value;
                        if (!reason.trim()) { alert('Please enter a reason.'); return; }
                    }

                    await DB.setSystemStatus('offline', reason);
                    window.location.reload();
                };

                // Firebase Config Logic
                window.openFirebaseConfigModal = () => {
                    const currentConfig = window.firebaseConfig;
                    if (currentConfig) {
                        document.getElementById('fb-apiKey').value = currentConfig.apiKey || '';
                        document.getElementById('fb-authDomain').value = currentConfig.authDomain || '';
                        document.getElementById('fb-projectId').value = currentConfig.projectId || '';
                        document.getElementById('fb-storageBucket').value = currentConfig.storageBucket || '';
                        document.getElementById('fb-messagingSenderId').value = currentConfig.messagingSenderId || '';
                        document.getElementById('fb-appId').value = currentConfig.appId || '';
                        document.getElementById('fb-measurementId').value = currentConfig.measurementId || '';
                    }
                    openModal('firebase-config-modal');
                };

                window.promptFirebaseAccess = () => {
                    document.getElementById('reauth-pass').value = '';
                    openModal('firebase-reauth-modal');
                };

                document.getElementById('firebase-reauth-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    let password = document.getElementById('reauth-pass').value;
                    if (!password) return;

                    // Apply same padding logic as Auth.login/signup
                    if (password.length >= 4 && password.length < 6) {
                        password = password.padEnd(6, '0');
                    }

                    try {
                        const user = window.auth.currentUser;
                        const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                        await user.reauthenticateWithCredential(credential);

                        // Verification Success
                        closeModal('firebase-reauth-modal');
                        openFirebaseConfigModal();
                        Auth.showToast('Verified Access Granted', 'success');
                    } catch (error) {
                        console.error(error);
                        Auth.showToast('Incorrect Password', 'error');
                    }
                });

                window.downloadConfigFile = () => {
                    const newConfig = {
                        apiKey: document.getElementById('fb-apiKey').value.trim(),
                        authDomain: document.getElementById('fb-authDomain').value.trim(),
                        projectId: document.getElementById('fb-projectId').value.trim(),
                        storageBucket: document.getElementById('fb-storageBucket').value.trim(),
                        messagingSenderId: document.getElementById('fb-messagingSenderId').value.trim(),
                        appId: document.getElementById('fb-appId').value.trim(),
                        measurementId: document.getElementById('fb-measurementId').value.trim()
                    };

                    const fileContent = `// Firebase Configuration & Initialization
// using compat libraries via Global Namespace (CDN)
// UPDATED FROM ADMIN DASHBOARD

import "https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js";
import "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js";
import "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js";

const defaultFirebaseConfig = ${JSON.stringify(newConfig, null, 4)};

// Check for override
const savedConfig = localStorage.getItem('firebase_config_override');
const firebaseConfig = savedConfig ? JSON.parse(savedConfig) : defaultFirebaseConfig;

// Initialize Firebase
// Compat libraries pollute the global 'firebase' namespace
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Make them globally available for legacy scripts
window.firebaseConfig = firebaseConfig;
window.firebaseApp = app;
window.auth = auth;
window.db = db;

console.log("Firebase initialized (Global Namespace Mode)");

// Export for module usage
export { app, auth, db };
`;
                    const blob = new Blob([fileContent], { type: 'text/javascript' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'firebase-config.js';
                    a.click();
                    URL.revokeObjectURL(url);
                    Auth.showToast('File downloaded! Please replace scripts/firebase-config.js', 'info');
                };
            }

            initActivityListeners();
            checkDuplicateCertificates();
        });

        async function checkDuplicateCertificates() {
            try {
                const dups = await DB.getDuplicateCertificates();
                const statEl = document.getElementById('stat-duplicates');
                const alertEl = document.getElementById('dup-alert');

                if (dups.length > 0) {
                    statEl.innerText = dups.length;
                    alertEl.style.display = 'block';
                } else {
                    statEl.innerText = '0';
                    alertEl.style.display = 'none';
                }
            } catch (e) { console.error(e); }
        }

        async function openDuplicatesModal() {
            openModal('duplicates-modal');
            const list = document.getElementById('duplicates-list');
            list.innerHTML = '<tr><td colspan="2" style="text-align:center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Finding duplicates...</td></tr>';

            try {
                const dups = await DB.getDuplicateCertificates();
                if (dups.length === 0) {
                    list.innerHTML = '<tr><td colspan="2" style="text-align:center; padding: 2rem;">No duplicates found!</td></tr>';
                    return;
                }

                list.innerHTML = dups.map(group => `
                    <tr style="border-bottom: 1px solid #f3f4f6;">
                        <td style="padding: 1rem; vertical-align: top;">
                            <div style="font-weight: 700;">${group.userName}</div>
                            <div style="color: var(--primary-color); font-size: 0.9rem;">${group.courseTitle}</div>
                            <small style="color: #666;">UID: ${group.uid.substring(0, 8)}...</small>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                ${group.certs.map((c, index) => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; background: #f9fafb; padding: 0.75rem; border-radius: 6px; border: 1px solid #eee;">
                                        <div>
                                            <div style="font-size: 0.85rem; font-weight: 600;">ID: ${c.certificateId} ${index === 0 ? '<span style="color: #10B981; margin-left:5px;">(Latest)</span>' : ''}</div>
                                            <div style="font-size: 0.75rem; color: #666;">Issued: ${new Date(c.issuedAt.seconds * 1000).toLocaleString()}</div>
                                            <div style="font-size: 0.75rem; color: #666;">Score: ${c.score}/${c.totalPossible}</div>
                                        </div>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <a href="../certificate.html?id=${c.id}" target="_blank" class="btn btn-sm btn-secondary" title="View"><i class="fas fa-eye"></i></a>
                                            <button class="btn btn-sm btn-danger" style="background: #EF4444; border-color: #EF4444;" 
                                                onclick="revokeCert('${c.id}', '${group.uid}', '${group.courseTitle.replace(/'/g, "\\'")}')" title="Revoke & Delete">
                                                <i class="fas fa-trash-alt"></i> Revoke
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                list.innerHTML = '<tr><td colspan="2" style="text-align:center; color: red;">Error loading duplicates.</td></tr>';
            }
        }

        window.revokeCert = async (certId, uid, courseTitle) => {
            if (!confirm(`Are you sure you want to REVOKE and DELETE certificate ${certId}?\nThis action cannot be undone and the student will be notified.`)) return;

            try {
                await DB.revokeCertificate(certId, uid, courseTitle);
                Auth.showToast('Certificate Revoked Successfully!', 'success');
                // Refresh list
                openDuplicatesModal();
                checkDuplicateCertificates();
            } catch (e) {
                Auth.showToast('Error revoking: ' + e.message, 'error');
            }
        }

        let recentUsers = [];
        let pendingSubs = [];
        let recentPayments = [];
        let recentCertificates = [];

        function initActivityListeners() {
            DB.listenToRecentUsers(users => {
                recentUsers = users;
                renderActivityFeed();
            });
            DB.listenToPendingSubmissions(subs => {
                pendingSubs = subs;
                renderActivityFeed();
            });
            DB.listenToRecentPayments(payments => {
                recentPayments = payments;
                renderActivityFeed();
            });
            DB.listenToRecentCertificates(certs => {
                recentCertificates = certs;
                renderActivityFeed();
            });
            DB.listenToRecentContacts(contacts => {
                recentContacts = contacts;
                renderActivityFeed();
            });
        }

        let recentContacts = [];

        function renderActivityFeed() {
            const feed = document.getElementById('activity-feed');
            let activities = [];

            // Add Reviews
            pendingSubs.forEach(r => {
                activities.push({
                    type: 'exam',
                    title: `New Exam Submission: ${r.itemTitle || 'Exam'}`,
                    desc: `Submitted by ${r.userName} for ${r.courseTitle}`,
                    time: r.submittedAt,
                    icon: 'fa-file-signature',
                    color: '#8B5CF6'
                });
            });

            // Add Payments
            recentPayments.forEach(p => {
                const isApproved = p.status === 'approved';
                activities.push({
                    type: 'payment',
                    title: isApproved ? 'Payment Approved' : 'New Payment Request',
                    desc: `${p.userName}: ${p.finalPrice || p.price} for ${p.courseTitle}`,
                    time: isApproved ? p.approvedAt : p.createdAt,
                    icon: isApproved ? 'fa-check-double' : 'fa-wallet',
                    color: isApproved ? '#10B981' : '#F59E0B'
                });
            });

            // Add Certificates
            recentCertificates.forEach(c => {
                activities.push({
                    type: 'cert',
                    title: 'Certificate Issued ',
                    desc: `${c.userName} completed ${c.courseTitle}`,
                    time: c.issuedAt,
                    icon: 'fa-certificate',
                    color: '#6366F1'
                });
            });

            // Add User Registrations
            recentUsers.forEach(u => {
                activities.push({
                    type: 'user',
                    title: `New Student Joined: ${u.name}`,
                    desc: `Email: ${u.email}`,
                    time: u.createdAt,
                    icon: 'fa-user-plus',
                    color: '#10B981'
                });
            });

            // Add Contact Messages
            recentContacts.forEach(c => {
                activities.push({
                    type: 'contact',
                    title: `New Message from ${c.name}`,
                    desc: c.message.length > 50 ? c.message.substring(0, 50) + '...' : c.message,
                    time: c.createdAt,
                    icon: 'fa-envelope',
                    color: '#10B981'
                });
            });

            // Sort by time
            activities.sort((a, b) => (b.time?.seconds || 0) - (a.time?.seconds || 0));

            if (activities.length === 0) {
                feed.innerHTML = '<p style="text-align:center; padding: 2rem;">No recent activity.</p>';
                return;
            }

            feed.innerHTML = activities.slice(0, 15).map(act => `
                <div style="display: flex; gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 8px; border-left: 4px solid ${act.color};">
                    <div style="width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: ${act.color}; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                        <i class="fas ${act.icon}"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <strong style="font-size: 0.95rem;">${act.title}</strong>
                            <small style="color: var(--text-muted); font-size: 0.75rem;">${act.time ? new Date(act.time.seconds * 1000).toLocaleTimeString() : 'Recent'}</small>
                        </div>
                        <p style="margin: 2px 0 0 0; font-size: 0.85rem; color: var(--text-muted);">${act.desc}</p>
                    </div>
                </div>
            `).join('');
        }

        // Keep for manual refresh button
        async function loadActivities() {
            // Re-initialize or simply the listeners will handle it
            renderActivityFeed();
        }

        // Add Course Handler
        document.getElementById('add-course-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('c-title').value;
            const desc = document.getElementById('c-desc').value;
            const cat = document.getElementById('c-cat').value;
            const isPremium = document.getElementById('c-premium').checked;

            try {
                await DB.createCourse({
                    title,
                    description: desc,
                    category: cat,
                    isPremium,
                    createdAt: new Date()
                });
                Auth.showToast('Course Created!', 'success');
                closeModal('course-modal');
                // Reload or re-fetch recommended
                setTimeout(() => window.location.reload(), 1000);
            } catch (e) { Auth.showToast(e.message, 'error'); }
        });

        // Add User Handler
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('u-name').value;
            const email = document.getElementById('u-email').value;
            const password = document.getElementById('u-pass').value;
            const role = document.getElementById('u-role').value;

            // Validation for Staff
            if (Auth.userProfile.role === 'staff' && role !== 'student') {
                Auth.showToast('Staff members can only create Student accounts.', 'error');
                return;
            }

            try {
                const res = await Auth.createStaffUser(email, password, name, role);
                if (res.success) {
                    Auth.showToast('User Created Successfully!', 'success');
                    closeModal('user-modal');
                    window.location.reload();
                } else {
                    Auth.showToast('Error: ' + res.message, 'error');
                }
            } catch (e) {
                Auth.showToast('Error: ' + e.message, 'error');
            }
        });

        // Change Password Handler
        document.getElementById('change-pass-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const currPass = document.getElementById('current-pass').value;
            const p1 = document.getElementById('new-pass').value;
            const p2 = document.getElementById('confirm-pass').value;

            if (p1 !== p2) {
                Auth.showToast('Passwords do not match', 'error');
                return;
            }

            const res = await Auth.changePassword(currPass, p1);
            if (res.success) {
                Auth.showToast('Password Updated Successfully', 'success');
                closeModal('change-pass-modal');
                document.getElementById('change-pass-form').reset();
            } else {
                Auth.showToast(res.message, 'error');
            }
        });



        async function loadContacts() {
            const list = document.getElementById('contacts-list');
            list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading messages...</td></tr>';

            try {
                const contacts = await DB.getContacts();
                if (contacts.length === 0) {
                    list.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 2rem;">No messages found.</td></tr>';
                    return;
                }

                list.innerHTML = contacts.map(c => `
                    <tr style="border-bottom: 1px solid #f3f4f6; ${c.status === 'unread' ? 'background: #fffbeb;' : ''}">
                        <td style="padding: 1rem;">
                            <div style="font-weight: 700;">${c.name}</div>
                            <div style="font-size: 0.85rem; color: #666;">${c.email}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="font-size: 0.9rem; color: #10B981; font-weight: 600;"><i class="fab fa-whatsapp"></i> ${c.whatsapp || 'N/A'}</div>
                        </td>
                        <td style="padding: 1rem;">
                            <div style="max-width: 400px; white-space: pre-wrap; font-size: 0.9rem;">${c.message}</div>
                        </td>
                        <td style="padding: 1rem; font-size: 0.85rem; color: #666;">
                            ${new Date(c.createdAt.seconds * 1000).toLocaleString()}
                        </td>
                        <td style="padding: 1rem;">
                            <div style="display: flex; gap: 0.5rem;">
                                ${c.status === 'unread' ? `
                                    <button class="btn btn-sm btn-primary" onclick="markMessageRead('${c.id}')">
                                        <i class="fas fa-check"></i> Read
                                    </button>
                                ` : ''}
                                <button class="btn btn-sm btn-danger" onclick="deleteMessage('${c.id}')" style="background: #EF4444; border-color: #EF4444;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                list.innerHTML = '<tr><td colspan="4" style="text-align:center; color: red;">Error loading messages.</td></tr>';
            }
        }

        window.markMessageRead = async (id) => {
            await DB.markContactAsRead(id);
            loadContacts();
            // Also update stat count
            const stats = await DB.getStats();
            document.getElementById('stat-contacts').innerText = stats.contacts;
        };

        window.deleteMessage = async (id) => {
            if (!confirm('Are you sure you want to delete this message?')) return;
            await DB.deleteContact(id);
            loadContacts();
            const stats = await DB.getStats();
            document.getElementById('stat-contacts').innerText = stats.contacts;
        };

        async function loadCategoryOptions() {
            const select = document.getElementById('c-cat');
            try {
                const cats = await DB.getCategories();
                // Filter only active categories for new courses
                const activeCats = cats.filter(c => c.status !== 'paused');
                if (activeCats.length === 0) {
                    select.innerHTML = '<option value="">No active categories</option>';
                    return;
                }
                select.innerHTML = activeCats.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            } catch (e) {
                select.innerHTML = '<option value="">Error loading</option>';
            }
        }

        async function openCategoriesModal() {
            openModal('categories-modal');
            loadCategoriesList();
        }

        async function loadCategoriesList() {
            const list = document.getElementById('categories-list');
            list.innerHTML = '<div style="text-align:center; padding: 1rem;"><i class="fas fa-spinner fa-spin"></i></div>';
            try {
                const cats = await DB.getCategories();
                if (cats.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color: #666; padding: 1rem;">No categories yet.</p>';
                    return;
                }
                list.innerHTML = cats.map(c => {
                    const isPaused = c.status === 'paused';
                    return `
                    <div style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #eee; display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="${isPaused ? 'text-decoration: line-through; color: #999;' : ''}">${c.name}</strong>
                            <div style="display: flex; gap: 0.25rem;">
                                <button class="btn btn-sm btn-secondary" onclick="editCategoryName('${c.id}', '${c.name}')" title="Edit Name">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm ${isPaused ? 'btn-success' : 'btn-secondary'}" onclick="toggleCategoryStatus('${c.id}', '${c.status || 'active'}')" title="${isPaused ? 'Resume' : 'Pause'}">
                                    <i class="fas ${isPaused ? 'fa-play' : 'fa-pause'}"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="deleteCategory('${c.id}')" style="color: var(--danger-color);" title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        ${isPaused ? '<small style="color: var(--danger-color); font-weight: 600;">Currently Paused</small>' : ''}
                    </div>
                `;
                }).join('');
            } catch (e) {
                list.innerHTML = '<p style="text-align:center; color: var(--danger-color);">Error loading categories.</p>';
            }
        }

        window.editCategoryName = async (id, oldName) => {
            const newName = prompt('Enter new name for category:', oldName);
            if (newName && newName.trim() !== oldName) {
                try {
                    await DB.updateCategory(id, { name: newName.trim(), updatedAt: new Date() });
                    Auth.showToast('Category name updated', 'success');
                    loadCategoriesList();
                    loadCategoryOptions();
                } catch (e) {
                    Auth.showToast(e.message, 'error');
                }
            }
        };

        window.toggleCategoryStatus = async (id, currentStatus) => {
            const newStatus = currentStatus === 'paused' ? 'active' : 'paused';
            try {
                await DB.updateCategory(id, { status: newStatus, updatedAt: new Date() });
                Auth.showToast(`Category ${newStatus === 'active' ? 'Resumed' : 'Paused'}`, 'success');
                loadCategoriesList();
                loadCategoryOptions();
            } catch (e) {
                Auth.showToast(e.message, 'error');
            }
        };

        document.getElementById('add-category-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('new-cat-name').value.trim();
            if (!name) return;
            try {
                await DB.createCategory(name);
                document.getElementById('new-cat-name').value = '';
                Auth.showToast('Category Added', 'success');
                loadCategoriesList();
                loadCategoryOptions(); // Sync course modal
            } catch (e) {
                Auth.showToast(e.message, 'error');
            }
        });

        window.deleteCategory = async (id) => {
            if (!confirm('Are you sure? This won\'t delete courses in this category but will remove the option.')) return;
            try {
                await DB.deleteCategory(id);
                Auth.showToast('Category Deleted', 'success');
                loadCategoriesList();
                loadCategoryOptions();
            } catch (e) {
                Auth.showToast(e.message, 'error');
            }
        };

        async function openProvidedCertsModal() {
            openModal('provided-certs-modal');
            loadProvidedCerts();
        }

        let allCertificates = [];

        async function loadProvidedCerts() {
            const list = document.getElementById('provided-certs-list');
            list.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            try {
                allCertificates = await DB.getAllCertificates();
                renderCertificateTable(allCertificates);
            } catch (e) {
                list.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem; color:red;">Error loading certificates.</td></tr>';
            }
        }

        function renderCertificateTable(certs) {
            const list = document.getElementById('provided-certs-list');
            if (certs.length === 0) {
                list.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:2rem; color:#666;">No certificates matching search.</td></tr>';
                return;
            }
            list.innerHTML = certs.map(c => `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 1rem;">
                        <div style="font-weight:600;">${c.userName}</div>
                        <small style="color:#666;">UID: ${c.uid.substring(0, 8)}...</small>
                    </td>
                    <td style="padding: 1rem;">${c.courseTitle}</td>
                    <td style="padding: 1rem;"><small>${c.certificateId}</small></td>
                    <td style="padding: 1rem;">${new Date(c.issuedAt.seconds * 1000).toLocaleDateString()}</td>
                    <td style="padding: 1rem;">
                        <a href="../certificate.html?id=${c.id}" target="_blank" class="btn btn-sm btn-secondary">View</a>
                    </td>
                </tr>
            `).join('');
        }

        function filterProvidedCerts() {
            const query = document.getElementById('cert-search-input').value.toLowerCase();
            const filtered = allCertificates.filter(c =>
                c.userName.toLowerCase().includes(query) ||
                c.courseTitle.toLowerCase().includes(query) ||
                c.certificateId.toLowerCase().includes(query)
            );
            renderCertificateTable(filtered);
        }
        document.getElementById('verify-cert-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const certId = document.getElementById('verify-cert-id').value.trim();
            const resultDiv = document.getElementById('verify-result');

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Verifying...</div>';

            try {
                const cert = await DB.getCertificateById(certId);
                if (cert) {
                    resultDiv.innerHTML = `
                        <div style="color: var(--success-color); font-weight: 700; margin-bottom: 0.5rem;">
                            <i class="fas fa-check-circle"></i> Valid Certificate
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-main);">
                            <p><strong>Student:</strong> ${cert.userName}</p>
                            <p><strong>Course:</strong> ${cert.courseTitle}</p>
                            <p><strong>Issued On:</strong> ${new Date(cert.issuedAt.seconds * 1000).toLocaleDateString()}</p>
                            <p><strong>Score:</strong> ${cert.score}/${cert.totalPossible}</p>
                        </div>
                        <a href="../certificate.html?id=${cert.id}" target="_blank" class="btn btn-sm btn-primary" style="width: 100%; margin-top: 1rem;">View Certificate</a>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="color: var(--danger-color); font-weight: 700; text-align: center;">
                            <i class="fas fa-times-circle"></i> Invalid Certificate ID
                        </div>
                    `;
                }
            } catch (e) {
                resultDiv.innerHTML = '<p style="color: var(--danger-color);">Error verifying certificate.</p>';
            }
        });

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
            // Logic to disable admin/staff options if current user is staff
            if (id === 'user-modal' && Auth.userProfile && Auth.userProfile.role === 'staff') {
                const select = document.getElementById('u-role');
                Array.from(select.options).forEach(opt => {
                    if (opt.value !== 'student') opt.disabled = true;
                });
                select.value = 'student';
            }
            if (id === 'contacts-modal') loadContacts();
        }
        window.openSettingsModal = async () => {
            const modal = document.getElementById('settings-modal');
            modal.style.display = 'flex';
            document.getElementById('settings-loading').style.display = 'block';
            document.getElementById('settings-form').style.display = 'none';

            // Load values
            const settings = await DB.getSiteSettings() || {};
            document.getElementById('set-name').value = settings.siteName || '';
            document.getElementById('set-logo').value = settings.logoUrl || '';
            document.getElementById('set-logo-size').value = settings.logoSize || '30px';
            document.getElementById('set-color').value = settings.primaryColor || '#4F46E5';

            document.getElementById('settings-loading').style.display = 'none';
            document.getElementById('settings-form').style.display = 'block';
        };

        window.saveSettings = async (e) => {
            e.preventDefault();
            const settings = {
                siteName: document.getElementById('set-name').value,
                logoUrl: document.getElementById('set-logo').value,
                logoSize: document.getElementById('set-logo-size').value || '30px',
                primaryColor: document.getElementById('set-color').value
            };

            try {
                await DB.saveSiteSettings(settings);
                Auth.showToast('Settings saved!', 'success');
                // Apply immediately
                if (window.applySettingsToDOM) window.applySettingsToDOM(settings);
                else {
                    document.documentElement.style.setProperty('--primary-color', settings.primaryColor);
                }
                setTimeout(() => window.location.reload(), 1000);
            } catch (err) {
                Auth.showToast('Error saving settings', 'error');
            }
        };

        // Auto-apply settings on load (Admin specific implementation)
        async function loadAndApplyAdminSettings() {
            // 1. Try Local Storage
            const cached = localStorage.getItem('siteSettings');
            if (cached) {
                applyAdminSettings(JSON.parse(cached));
            }

            // 2. DB Sync
            try {
                const settings = await DB.getSiteSettings();
                if (settings) {
                    localStorage.setItem('siteSettings', JSON.stringify(settings));
                    applyAdminSettings(settings);
                }
            } catch (e) { console.error(e); }
        }

        function applyAdminSettings(settings) {
            if (!settings) return;
            if (settings.siteName) {
                if (!document.title.includes(' - ')) {
                    const parts = document.title.split(' - ');
                    if (parts.length > 0) document.title = `${parts[0]} - ${settings.siteName}`;
                } else {
                    const parts = document.title.split(' - ');
                    document.title = `${parts[0]} - ${settings.siteName}`;
                }
            }
            if (settings.primaryColor) {
                document.documentElement.style.setProperty('--primary-color', settings.primaryColor);
            }
            // Logic for Admin Logo (if structurally different or just class .logo)
            const logoEls = document.querySelectorAll('.logo');
            logoEls.forEach(el => {
                if (settings.logoUrl) {
                    const size = settings.logoSize || '30px';
                    el.style.display = 'flex';
                    el.style.alignItems = 'center';
                    el.style.gap = '12px';
                    el.innerHTML = `<img src="${settings.logoUrl}" alt="${settings.siteName || 'Logo'}" style="height: ${size}; width: auto; object-fit: contain;"> <span style="font-size: 1.25rem;">${settings.siteName || ''}</span>`;
                } else if (settings.siteName) {
                    const icon = el.querySelector('i');
                    const iconHtml = icon ? icon.outerHTML : '<i class="fas fa-graduation-cap"></i>';
                    el.innerHTML = `${iconHtml} ${settings.siteName}`;
                }
            });
        }

        // Call it
        document.addEventListener('DOMContentLoaded', loadAndApplyAdminSettings);

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
    </script>
</body>

</html>