<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users - EduPortal Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/main.css">
</head>

<body style="background-color: #f3f4f6;">

    <header style="background: #1F2937; color: white;">
        <div class="container navbar">
            <div class="logo" style="color: white; cursor: pointer;" onclick="window.location.href='index.html'">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </div>
            <div class="nav-cta" style="display: flex; gap: 1rem; align-items: center;">
                <span id="admin-name">loading...</span>
                <button id="logout-btn" class="btn btn-sm btn-secondary"
                    style="background: transparent; color: white; border-color: rgba(255,255,255,0.3);">Logout</button>
            </div>
        </div>
    </header>

    <div class="container" style="padding: var(--spacing-lg) var(--spacing-sm);">

        <div class="card" style="padding: var(--spacing-lg);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="margin: 0;">User Management</h2>
                <button class="btn btn-primary" onclick="openModal('user-modal')" id="add-user-btn">
                    <i class="fas fa-plus"></i> Add User
                </button>
            </div>

            <!-- Filters -->
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <input type="text" id="filter-search" class="form-control" placeholder="Search by name or email..."
                    style="max-width: 300px;">
                <select id="filter-role" class="form-control" style="max-width: 150px;">
                    <option value="">All Roles</option>
                    <option value="student">Student</option>
                    <option value="staff">Staff</option>
                    <option value="admin">Admin</option>
                    <option value="head_admin">Head Admin</option>
                </select>
            </div>

            <div class="table-responsive">
                <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
                    <thead>
                        <tr style="text-align: left; border-bottom: 1px solid #eee;">
                            <th style="padding: 1rem 0.5rem;">Name</th>
                            <th style="padding: 1rem 0.5rem;">Email</th>
                            <th style="padding: 1rem 0.5rem;">Role</th>
                            <th style="padding: 1rem 0.5rem;">Status</th>
                            <th style="padding: 1rem 0.5rem; text-align: right;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 2rem;">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Add User Modal -->
    <div id="user-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <h2 style="margin-bottom: 1rem;">Add New User</h2>
            <form id="add-user-form">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="u-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="u-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="u-pass" class="form-control" required minlength="4">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="u-role" class="form-control">
                        <option value="student">Student</option>
                        <option value="staff" class="role-restricted-option">Staff</option>
                        <option value="admin" class="role-restricted-option">Admin</option>
                        <option value="head_admin" class="role-restricted-option">Head Admin</option>
                    </select>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('user-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center;">
        <div class="card" style="width: 90%; max-width: 500px; padding: 2rem;">
            <h2 style="margin-bottom: 1rem;">Edit User</h2>
            <form id="edit-user-form">
                <input type="hidden" id="edit-u-id">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" id="edit-u-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="edit-u-email" class="form-control" readonly
                        style="background-color: #f3f4f6; cursor: not-allowed;"
                        title="Email cannot be changed directly">
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="edit-u-role" class="form-control">
                        <option value="student">Student</option>
                        <option value="staff" class="role-restricted-option-edit">Staff</option>
                        <option value="admin" class="role-restricted-option-edit">Admin</option>
                        <option value="head_admin" class="role-restricted-option-edit">Head Admin</option>
                    </select>
                </div>

                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary"
                        onclick="closeModal('edit-user-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update User</button>
                </div>
            </form>
        </div>
    </div>

    <footer style="text-align: center; padding: 2rem; color: #6b7280; font-size: 0.85rem; margin-top: auto;">
        powered by <a href="https://www.gridify.in" target="_blank"
            style="color: inherit; text-decoration: underline;">Gridify</a>
    </footer>

    <script type="module" src="../scripts/firebase-config.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/db.js"></script>

    <script>
        let allUsers = [];
        let currentUserRole = 'student';

        document.addEventListener('DOMContentLoaded', async () => {
            const isAuth = await Auth.checkProtection('admin');
            if (!isAuth) return;

            currentUserRole = Auth.userProfile.role;

            // Restrict UI based on Role
            if (currentUserRole === 'staff') {
                // Staff cannot create new users
                const addUserBtn = document.getElementById('add-user-btn');
                if (addUserBtn) addUserBtn.style.display = 'none';
            } else if (currentUserRole === 'admin') {
                // Admin cannot create Head Admin
                const haOption = document.querySelector('#u-role option[value="head_admin"]');
                if (haOption) haOption.disabled = true;
            }


            loadUsers();

            // Search Filter
            document.getElementById('filter-search').addEventListener('input', renderUsers);
            document.getElementById('filter-role').addEventListener('change', renderUsers);
        });

        async function loadUsers() {
            allUsers = await DB.getAllUsers();
            renderUsers();
        }

        function renderUsers() {
            const search = document.getElementById('filter-search').value.toLowerCase();
            const roleFilter = document.getElementById('filter-role').value;
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';

            const filtered = allUsers.filter(u => {
                const matchSearch = u.name.toLowerCase().includes(search) || u.email.toLowerCase().includes(search);
                const matchRole = roleFilter ? u.role === roleFilter : true;
                return matchSearch && matchRole;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 1rem;">No users found.</td></tr>';
                return;
            }

            filtered.forEach(u => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #f9f9f9';

                let roleBadge = `<span class="badge badge-secondary">${u.role}</span>`;
                if (u.role === 'admin') roleBadge = `<span class="badge" style="background:var(--primary-color); color:white;">${u.role}</span>`;
                if (u.role === 'head_admin') roleBadge = `<span class="badge" style="background:#7C3AED; color:white;">HEAD ADMIN</span>`;
                if (u.role === 'super_admin') roleBadge = `<span class="badge" style="background:#F59E0B; color:white;">SUPER ADMIN</span>`;
                if (u.role === 'staff') roleBadge = `<span class="badge" style="background:var(--accent-color); color:white;">${u.role}</span>`;

                // Status Badge
                let statusBadge = `<span class="badge badge-success">Active</span>`;
                if (u.status === 'suspended') statusBadge = `<span class="badge badge-danger">Suspended</span>`;

                // Actions Logic
                let actions = '';
                let canManage = false;

                if (currentUserRole === 'super_admin') canManage = true;
                else if (currentUserRole === 'head_admin' && (u.role === 'admin' || u.role === 'staff' || u.role === 'student')) canManage = true;
                else if (currentUserRole === 'admin' && (u.role === 'staff' || u.role === 'student')) canManage = true;
                else if (currentUserRole === 'staff' && u.role === 'student') canManage = true;

                // Protect Super Admin from everyone (including other super admins potentially, but mainly lower roles)
                if (u.role === 'super_admin') canManage = false;
                // Protect Head Admin from Admin
                if (u.role === 'head_admin' && currentUserRole !== 'super_admin') canManage = false;

                if (canManage) {
                    const statusBtn = u.status === 'suspended'
                        ? `<button class="btn btn-sm btn-success" onclick="toggleStatus('${u.id}', 'active')" title="Activate"><i class="fas fa-check"></i></button>`
                        : `<button class="btn btn-sm btn-danger" onclick="toggleStatus('${u.id}', 'suspended')" title="Suspend"><i class="fas fa-ban"></i></button>`;

                    const editBtn = `<button class="btn btn-sm btn-secondary" onclick="openEditModal('${u.id}')" title="Edit"><i class="fas fa-edit"></i></button>`;
                    const deleteBtn = `<button class="btn btn-sm btn-secondary" onclick="deleteUser('${u.id}')" title="Delete"><i class="fas fa-trash"></i></button>`;

                    actions = `<div style="display:flex; gap:0.5rem; justify-content:flex-end;">${editBtn} ${statusBtn} ${deleteBtn}</div>`;
                }

                tr.innerHTML = `
                    <td style="padding: 0.75rem 0.5rem;">${u.name}</td>
                    <td style="padding: 0.75rem 0.5rem;">${u.email}</td>
                    <td style="padding: 0.75rem 0.5rem;">${roleBadge}</td>
                    <td style="padding: 0.75rem 0.5rem;">${statusBadge}</td>
                    <td style="padding: 0.75rem 0.5rem; text-align: right;">${actions}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Action Handlers
        window.toggleStatus = async (uid, newStatus) => {
            if (!confirm(`Are you sure you want to change status to ${newStatus}?`)) return;
            try {
                await DB.updateUserStatus(uid, newStatus);
                Auth.showToast(`User status updated to ${newStatus}`, 'success');
                loadUsers();
            } catch (e) { Auth.showToast(e.message, 'error'); }
        };

        window.deleteUser = async (uid) => {
            if (!confirm('Are you sure? This removes the user listing but does not delete them from Authentication (requires backend).')) return;
            try {
                await DB.deleteUser(uid);
                Auth.showToast('User deleted successfully', 'success');
                loadUsers();
            } catch (e) { Auth.showToast(e.message, 'error'); }
        };

        // Edit User Handlers
        window.openEditModal = (uid) => {
            const user = allUsers.find(u => u.id === uid);
            if (!user) return;

            document.getElementById('edit-u-id').value = user.id;
            document.getElementById('edit-u-name').value = user.name;
            document.getElementById('edit-u-email').value = user.email;
            document.getElementById('edit-u-role').value = user.role;

            // Apply Staff restriction to Edit modal too
            if (currentUserRole === 'staff') {
                const restrictedOptions = document.querySelectorAll('.role-restricted-option-edit');
                restrictedOptions.forEach(opt => opt.disabled = true);
            }

            // Admin cannot promote to Head Admin
            if (currentUserRole === 'admin') {
                const haOption = document.querySelector('#edit-u-role option[value="head_admin"]');
                if (haOption) haOption.disabled = true;
            }


            openModal('edit-user-modal');
        };

        document.getElementById('edit-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const uid = document.getElementById('edit-u-id').value;
            const name = document.getElementById('edit-u-name').value;
            const role = document.getElementById('edit-u-role').value;

            // Staff Restriction Check
            if (currentUserRole === 'staff' && role !== 'student') {
                Auth.showToast('Staff can only set role to Student.', 'error');
                return;
            }

            // Admin Restriction Check
            if (currentUserRole === 'admin' && role === 'head_admin') {
                Auth.showToast('Admins cannot set role to Head Admin.', 'error');
                return;
            }


            try {
                await DB.updateUser(uid, { name, role });
                Auth.showToast('User Updated Successfully!', 'success');
                closeModal('edit-user-modal');
                loadUsers();
            } catch (e) {
                Auth.showToast('Error updating user: ' + e.message, 'error');
            }
        });

        // Add User Handler
        document.getElementById('add-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('u-name').value;
            const email = document.getElementById('u-email').value;
            const password = document.getElementById('u-pass').value;
            const role = document.getElementById('u-role').value;

            // Extra validation for Staff
            if (currentUserRole === 'staff') {
                Auth.showToast('Staff members are not allowed to create new users.', 'error');
                return;
            }

            // Extra validation for Admin
            if (currentUserRole === 'admin' && role === 'head_admin') {
                Auth.showToast('Admins cannot create Head Admin accounts.', 'error');
                return;
            }


            try {
                // Determine if we need to use createStaffUser (for staff/admin roles) or simple signup (for students)
                // Actually Auth.createStaffUser handles all, but let's be consistent.

                const res = await Auth.createStaffUser(email, password, name, role);

                if (res.success) {
                    Auth.showToast('User Created Successfully!', 'success');
                    closeModal('user-modal');
                    loadUsers(); // Refresh list without reload
                    document.getElementById('add-user-form').reset();
                    if (currentUserRole === 'staff') document.getElementById('u-role').value = 'student'; // Reset
                } else {
                    Auth.showToast('Error: ' + res.message, 'error');
                }
            } catch (e) {
                Auth.showToast('Error: ' + e.message, 'error');
            }
        });

        function openModal(id) {
            document.getElementById(id).style.display = 'flex';
        }
        window.closeModal = function (id) { // Make global for onclick
            document.getElementById(id).style.display = 'none';
        }
    </script>
</body>

</html>