<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Editor - EduPortal Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/main.css">
    <style>
        .editor-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
            align-items: start;
        }

        .syllabus-item {
            background: white;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .syllabus-item:hover {
            border-color: var(--primary-color);
            background: #fdfeff;
        }

        .syllabus-item.active {
            border-color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
        }

        .form-section {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .badge-chapter {
            background: #E0E7FF;
            color: #4338ca;
        }

        .badge-exam-mid {
            background: #FEF3C7;
            color: #D97706;
        }

        .badge-exam-end {
            background: #fae8ff;
            color: #86198f;
        }

        .question-box {
            border: 1px dashed #cbd5e1;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            position: relative;
        }

        .remove-q-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: var(--danger-color);
            cursor: pointer;
        }

        @media (max-width: 900px) {
            .editor-container {
                grid-template-columns: 1fr;
            }

            .editor-container>div:first-child {
                order: 2;
                /* Sidebar below on mobile? Or keep top? Sidebar is structure, maybe top is better.*/
            }

            /* Actually, structure list at top is better to navigate. */
        }
    </style>
</head>

<body style="background-color: #f3f4f6;">

    <header style="background: #1F2937; color: white;">
        <div class="container navbar">
            <div class="logo" style="color: white; cursor: pointer;" onclick="window.location.href='courses.html'">
                <i class="fas fa-arrow-left"></i> Back to Courses
            </div>
            <div class="nav-cta">
                <button class="btn btn-success" onclick="saveCourse()">
                    <i class="fas fa-save"></i> Save Course
                </button>
            </div>
        </div>
    </header>

    <div class="container" style="padding: var(--spacing-lg) var(--spacing-sm);">
        <h1 id="page-title" style="margin-bottom: 1rem;">Create New Course</h1>

        <div class="editor-container">
            <!-- Sidebar: Structure -->
            <div>
                <div class="card" style="padding: 1.5rem;">
                    <h3 style="margin-bottom: 1rem;">Course Structure</h3>
                    <div id="syllabus-list" style="margin-bottom: 1rem;">
                        <!-- Items will go here -->
                        <div class="text-center text-muted" id="empty-state">No content added yet</div>
                    </div>

                    <button type="button" class="btn btn-sm btn-secondary" onclick="addNewItem('chapter')">
                        + Chapter
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addNewItem('live_chapter')">
                        + Recorded Live
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="addNewItem('exam')">
                        + Exam
                    </button>
                </div>
            </div>

            <div class="card" style="padding: 1.5rem; margin-top: 1rem;">
                <h3 style="margin-bottom: 1rem;">Basic Details</h3>
                <div class="form-group">
                    <label class="form-label">Course Title</label>
                    <input type="text" id="c-title" class="form-control" oninput="updateCourseMeta()">
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select id="c-cat" class="form-control" onchange="updateCourseMeta()">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="c-desc" class="form-control" rows="3" oninput="updateCourseMeta()"></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="c-premium" onchange="updateCourseMeta()"> Premium Course
                    </label>
                </div>
                <div class="form-group" id="price-container" style="display:none;">
                    <label class="form-label">Price (â‚¹)</label>
                    <input type="number" id="c-price" class="form-control" oninput="updateCourseMeta()">
                </div>
            </div>
        </div>

        <!-- Main: Editor -->
        <div id="editor-area">
            <div class="card" style="padding: 3rem; text-align: center; color: var(--text-muted);">
                <i class="fas fa-layer-group fa-3x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                <h3>Select an item to edit</h3>
                <p>Or add a new chapter/exam from the sidebar.</p>
            </div>
        </div>
    </div>
    </div>

    <!-- Templates (Hidden) -->
    <template id="tpl-chapter-editor">
        <div class="form-section">
            <h3 style="margin-bottom: 1.5rem;">Edit Chapter</h3>
            <div class="form-group">
                <label class="form-label">Chapter Title</label>
                <input type="text" class="form-control item-title" oninput="updateActiveItem('title', this.value)">
            </div>
            <div class="form-group">
                <label class="form-label">Video URL (YouTube/Embed)</label>
                <input type="text" class="form-control item-video" oninput="updateActiveItem('videoUrl', this.value)">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-control item-desc" rows="3"
                    oninput="updateActiveItem('description', this.value)"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <label style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" class="item-is-live"
                        onchange="updateActiveItem('isLiveChapter', this.checked)">
                    Is Recorded Live
                </label>
                <label style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" class="item-mandatory"
                        onchange="updateActiveItem('isMandatory', this.checked)">
                    Mandatory
                </label>
            </div>
            <button class="btn btn-danger btn-sm" onclick="deleteActiveItem()">Delete Chapter</button>
        </div>
    </template>

    <template id="tpl-exam-editor">
        <div class="form-section">
            <h3 style="margin-bottom: 1.5rem;">Edit Exam</h3>

            <div class="form-group">
                <label class="form-label">Exam Title</label>
                <input type="text" class="form-control item-title" oninput="updateActiveItem('title', this.value)">
            </div>

            <div style="display: flex; gap: 1rem;">
                <div class="form-group" style="flex:1;">
                    <label class="form-label">Exam Type</label>
                    <select class="form-control item-exam-type"
                        onchange="updateActiveItem('examType', this.value); renderQuestions()">
                        <option value="mid">Mid-Course (MCQ Only - Auto Check)</option>
                        <option value="end">End-Course (Certificate - Admin Review)</option>
                    </select>
                </div>
                <div class="form-group" style="width: 150px;">
                    <label class="form-label">Pass %</label>
                    <input type="number" class="form-control item-pass" value="50"
                        oninput="updateActiveItem('passPercentage', this.value)">
                </div>
            </div>

            <div style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem;">
                <div style="display:flex; justify-content:space-between; margin-bottom: 1rem;">
                    <h4>Questions</h4>
                    <button class="btn btn-sm btn-secondary" onclick="addQuestion()">+ Add Query</button>
                </div>
                <div id="questions-list"></div>
            </div>

            <button class="btn btn-danger btn-sm" style="margin-top: 2rem;" onclick="deleteActiveItem()">Delete
                Exam</button>
        </div>
    </template>

    <footer style="text-align: center; padding: 2rem; color: #6b7280; font-size: 0.85rem; margin-top: auto;">
        powered by <a href="https://www.gridify.in" target="_blank"
            style="color: inherit; text-decoration: underline;">Gridify</a>
    </footer>

    <script type="module" src="../scripts/firebase-config.js"></script>
    <script src="../scripts/auth.js"></script>
    <script src="../scripts/db.js"></script>

    <script>
        // Global State
        let courseData = {
            title: '',
            description: '',
            category: 'Technology',
            isPremium: false,
            price: 0,
            syllabus: [] // Array of items
        };
        let activeItemId = null;
        let isEditing = false;
        let courseId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            const isAuth = await Auth.checkProtection('admin');
            if (!isAuth) return;

            // Check URL Params
            const urlParams = new URLSearchParams(window.location.search);
            courseId = urlParams.get('id');

            if (courseId) {
                document.getElementById('page-title').innerText = 'Edit Course';
                await loadCourse(courseId);
                isEditing = true;
            }

            loadCategories();
        });

        async function loadCategories() {
            const select = document.getElementById('c-cat');
            try {
                const cats = await DB.getCategories();
                const activeCats = cats.filter(c => c.status !== 'paused' || (isEditing && c.name === courseData.category));

                if (activeCats.length === 0) {
                    select.innerHTML = '<option value="">No active categories</option>';
                    return;
                }
                select.innerHTML = activeCats.map(c => `<option value="${c.name}">${c.name} ${c.status === 'paused' ? '(Paused)' : ''}</option>`).join('');

                // If editing, re-apply the correct category after loading list
                if (isEditing && courseData.category) {
                    select.value = courseData.category;
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadCourse(id) {
            try {
                const courses = await DB.getCourses();
                const found = courses.find(c => c.id === id);
                if (found) {
                    // Safe Merge
                    courseData = {
                        ...courseData,
                        ...found,
                        syllabus: Array.isArray(found.syllabus) ? found.syllabus : []
                    };

                    // Populate Basic Info
                    document.getElementById('c-title').value = courseData.title || '';
                    document.getElementById('c-desc').value = courseData.description || '';
                    document.getElementById('c-cat').value = courseData.category || 'Technology';
                    document.getElementById('c-premium').checked = !!courseData.isPremium;
                    document.getElementById('c-price').value = courseData.price || 0;
                    togglePriceField();

                    renderSyllabusList();
                } else {
                    Auth.showToast('Course not found', 'error');
                }
            } catch (e) {
                console.error(e);
                Auth.showToast('Error loading course', 'error');
            }
        }

        // --- Core Data Logic ---

        window.updateCourseMeta = () => {
            courseData.title = document.getElementById('c-title').value;
            courseData.description = document.getElementById('c-desc').value;
            courseData.category = document.getElementById('c-cat').value;
            courseData.isPremium = document.getElementById('c-premium').checked;
            courseData.price = parseFloat(document.getElementById('c-price').value) || 0;
            togglePriceField();
        };

        function togglePriceField() {
            const isPrem = document.getElementById('c-premium').checked;
            document.getElementById('price-container').style.display = isPrem ? 'block' : 'none';
        }

        window.addNewItem = (type) => {
            console.log('Adding new item:', type); // Debugging
            const id = 'item_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
            const newItem = {
                id,
                type,
                title: (type === 'chapter' || type === 'live_chapter') ? 'New Chapter' : 'New Exam',
                description: '',
                videoUrl: '',
                examType: 'mid',
                passPercentage: 50,
                questions: [],
                isLiveChapter: type === 'live_chapter',
                isMandatory: true // Default to mandatory
            };
            // Normalize type for internal logic if needed, or keep distinct
            if (type === 'live_chapter') newItem.type = 'chapter';

            if (!courseData.syllabus) courseData.syllabus = [];

            courseData.syllabus.push(newItem);
            renderSyllabusList();

            // Short delay to ensure DOM update before selection
            setTimeout(() => selectItem(id), 50);
        };

        window.selectItem = (id) => {
            console.log('Selecting item:', id); // Debugging
            activeItemId = id;
            renderSyllabusList();

            const item = courseData.syllabus.find(i => i.id === id);
            if (!item) return;

            const area = document.getElementById('editor-area');
            area.innerHTML = '';

            if (item.type === 'chapter') {
                const tpl = document.getElementById('tpl-chapter-editor').content.cloneNode(true);
                // Safe Setters relying on class names
                const setTitle = tpl.querySelector('.item-title');
                if (setTitle) setTitle.value = item.title || '';

                const setVid = tpl.querySelector('.item-video');
                if (setVid) setVid.value = item.videoUrl || '';

                const setDesc = tpl.querySelector('.item-desc');
                if (setDesc) setDesc.value = item.description || '';

                const setLive = tpl.querySelector('.item-is-live');
                if (setLive) setLive.checked = !!item.isLiveChapter;

                const setMandatory = tpl.querySelector('.item-mandatory');
                if (setMandatory) setMandatory.checked = item.isMandatory !== false; // Default true

                area.appendChild(tpl);
            } else {
                const tpl = document.getElementById('tpl-exam-editor').content.cloneNode(true);

                const setTitle = tpl.querySelector('.item-title');
                if (setTitle) setTitle.value = item.title || '';

                const setType = tpl.querySelector('.item-exam-type');
                if (setType) setType.value = item.examType || 'mid';

                const setPass = tpl.querySelector('.item-pass');
                if (setPass) setPass.value = item.passPercentage || 50;

                area.appendChild(tpl);
                renderQuestions();
            }
        };

        window.updateActiveItem = (key, value) => {
            if (!activeItemId) return;
            const item = courseData.syllabus.find(i => i.id === activeItemId);
            if (item) {
                item[key] = value;
                if (key === 'title') {
                    const el = document.querySelector(`.syllabus-item[data-id="${activeItemId}"] strong`);
                    if (el) el.innerText = value;
                }
            }
        };

        window.deleteActiveItem = () => {
            if (!confirm("Delete this item?")) return;
            courseData.syllabus = courseData.syllabus.filter(i => i.id !== activeItemId);
            activeItemId = null;
            renderSyllabusList();
            document.getElementById('editor-area').innerHTML = `
                <div class="card" style="padding: 3rem; text-align: center; color: var(--text-muted);">
                    <i class="fas fa-layer-group fa-3x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                    <h3>Select an item to edit</h3>
                </div>`;
        };

        // UI Renders
        function renderSyllabusList() {
            const list = document.getElementById('syllabus-list');
            list.innerHTML = '';

            if (!courseData.syllabus || courseData.syllabus.length === 0) {
                const empty = document.getElementById('empty-state');
                if (empty) empty.style.display = 'block';
                return;
            }
            const empty = document.getElementById('empty-state');
            if (empty) empty.style.display = 'none';

            courseData.syllabus.forEach(item => {
                const el = document.createElement('div');
                el.className = `syllabus-item ${item.id === activeItemId ? 'active' : ''}`;
                el.dataset.id = item.id;
                // preventDefault on click just in case
                el.onclick = (e) => { e.preventDefault(); selectItem(item.id); };

                let badge = '';
                if (item.type === 'chapter') {
                    if (item.isLiveChapter) badge += '<span class="badge badge-sm badge-chapter" style="background:#e0f2fe; color:#0284c7;">Recorded Live</span> ';
                    else badge += '<span class="badge badge-sm badge-chapter">Chapter</span> ';

                    if (item.isMandatory === false) badge += '<span class="badge badge-sm" style="background:#f3f4f6; color:#6b7280;">Optional</span>';
                }
                else if (item.examType === 'end') badge = '<span class="badge badge-sm badge-exam-end">Final Exam</span>';
                else badge = '<span class="badge badge-sm badge-exam-mid">Quiz</span>';

                el.innerHTML = `
                    <div style="display:flex; flex-direction:column; pointer-events:none;">
                        <strong>${item.title || 'Untitled'}</strong>
                        <small class="text-muted" style="font-size:0.7em;">${item.type.toUpperCase()}</small>
                    </div>
                    <div>${badge}</div>
                `;
                list.appendChild(el);
            });
        }

        // --- Question Builder Logic ---

        window.renderQuestions = () => {
            const item = courseData.syllabus.find(i => i.id === activeItemId);
            if (!item) return;

            // Ensure questions array exists
            if (!item.questions) item.questions = [];

            const container = document.getElementById('questions-list');
            if (!container) return;
            container.innerHTML = '';

            item.questions.forEach((q, idx) => {
                const box = document.createElement('div');
                box.className = 'question-box';

                const isEndExam = item.examType === 'end';

                // Question Type Selector (Only for end exam, mid is MCQ only)
                let typeSelect = '';
                if (isEndExam) {
                    typeSelect = `
                        <select class="form-control" style="width:120px; font-size:0.8rem; margin-bottom:0.5rem;" 
                            onchange="updateQuestion(${idx}, 'type', this.value)">
                            <option value="mcq" ${q.type === 'mcq' ? 'selected' : ''}>MCQ</option>
                            <option value="text" ${q.type === 'text' ? 'selected' : ''}>Input Text</option>
                        </select>
                    `;
                }

                // Options HTML (Only for MCQ)
                let optionsHtml = '';
                if (q.type === 'mcq') {
                    // Ensure options array has at least 4 items
                    if (!q.options || !Array.isArray(q.options)) q.options = ['', '', '', ''];
                    while (q.options.length < 4) q.options.push('');

                    optionsHtml = `<div style="margin-top:0.5rem;">
                        <label style="font-size:0.8rem; font-weight:600;">Options</label>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                            <input type="text" class="form-control" placeholder="Option A" 
                                value="${q.options[0] || ''}" 
                                oninput="updateQuestionOption(${idx}, 0, this.value)">
                            <input type="text" class="form-control" placeholder="Option B" 
                                value="${q.options[1] || ''}" 
                                oninput="updateQuestionOption(${idx}, 1, this.value)">
                            <input type="text" class="form-control" placeholder="Option C" 
                                value="${q.options[2] || ''}" 
                                oninput="updateQuestionOption(${idx}, 2, this.value)">
                            <input type="text" class="form-control" placeholder="Option D" 
                                value="${q.options[3] || ''}" 
                                oninput="updateQuestionOption(${idx}, 3, this.value)">
                        </div>
                        
                        <label style="font-size:0.8rem; font-weight:600; margin-top:0.5rem; display:block;">Correct Answer</label>
                        <select class="form-control" onchange="updateQuestion(${idx}, 'correctAnswer', this.value)">
                            <option value="">Select Correct Answer...</option>
                            <option value="${q.options[0]}" ${q.correctAnswer === q.options[0] ? 'selected' : ''}>A: ${q.options[0]}</option>
                            <option value="${q.options[1]}" ${q.correctAnswer === q.options[1] ? 'selected' : ''}>B: ${q.options[1]}</option>
                            <option value="${q.options[2]}" ${q.correctAnswer === q.options[2] ? 'selected' : ''}>C: ${q.options[2]}</option>
                            <option value="${q.options[3]}" ${q.correctAnswer === q.options[3] ? 'selected' : ''}>D: ${q.options[3]}</option>
                        </select>
                         <small class="text-muted">Select the correct option from above.</small>
                    </div>`;
                }

                box.innerHTML = `
                    <div class="remove-q-btn" onclick="removeQuestion(${idx})">&times;</div>
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <span style="font-weight:700; color:var(--text-muted);">Q${idx + 1}</span>
                        ${typeSelect}
                    </div>
                    <input type="text" class="form-control" placeholder="Question Text" style="font-weight:600;"
                        value="${q.questionText || ''}" oninput="updateQuestion(${idx}, 'questionText', this.value)">
                    
                    <div style="display:flex; gap:1rem; margin-top:0.5rem;">
                         <div style="flex:1;">
                             ${optionsHtml}
                         </div>
                         <div style="width:80px;">
                            <label style="font-size:0.8rem;">Score</label>
                            <input type="number" class="form-control" value="${q.score || 5}" 
                                oninput="updateQuestion(${idx}, 'score', this.value)">
                         </div>
                    </div>
                `;
                container.appendChild(box);
            });
        };

        window.addQuestion = () => {
            const item = courseData.syllabus.find(i => i.id === activeItemId);
            if (!item) return;

            if (!item.questions) item.questions = [];

            item.questions.push({
                type: 'mcq', // Default
                questionText: '',
                options: ['', '', '', ''],
                correctAnswer: '',
                score: 5
            });
            renderQuestions();
        };

        window.removeQuestion = (idx) => {
            const item = courseData.syllabus.find(i => i.id === activeItemId);
            if (!item) return;
            item.questions.splice(idx, 1);
            renderQuestions();
        };

        window.updateQuestion = (idx, field, value) => {
            const item = courseData.syllabus.find(i => i.id === activeItemId);
            if (!item) return;

            if (field === 'score') {
                value = parseInt(value) || 0;
            }

            item.questions[idx][field] = value;

            // Re-render if type changes to show/hide options or if needed
            if (field === 'type') renderQuestions();
        };

        window.updateQuestionOption = (qIdx, optIdx, value) => {
            const item = courseData.syllabus.find(i => i.id === activeItemId);
            if (!item) return;

            if (!item.questions[qIdx].options) item.questions[qIdx].options = ['', '', '', ''];
            item.questions[qIdx].options[optIdx] = value;

            // Optional: If correct answer matches old text, could try to update it, 
            // but simpler to just let user re-select if they change text significantly.
            // We could trigger re-render of just the select, but standard render might lose focus.
            // For now, let's just update the data.

            // Update the specific option text in the dropdown dynamically to avoid re-render focus loss?
            // That's complex. Let's just store the value. 
            // Ideally we should re-render or at least update the dropdown text if possible.
            // But re-rendering the whole list while typing causes focus loss.
            // So we do NOT re-render here. We just update data. 
            // The Dropdown texts will update on next render (e.g. adding question or changing something else).
        };

        // --- Save Logic ---

        window.saveCourse = async () => {
            // Validation
            if (!courseData.title) { Auth.showToast('Please enter a course title', 'error'); return; }
            if (!courseData.syllabus || courseData.syllabus.length === 0) {
                Auth.showToast('Please add at least one chapter/exam', 'error'); return;
            }

            const btn = document.querySelector('.btn-success');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const payload = { ...courseData, updatedAt: new Date() };

                if (isEditing && courseId) {
                    await DB.updateCourse(courseId, payload);
                    Auth.showToast('Course Updated!', 'success');
                } else {
                    payload.createdAt = new Date();
                    await DB.createCourse(payload);
                    Auth.showToast('Course Created!', 'success');
                    setTimeout(() => window.location.href = 'courses.html', 1000);
                }
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save Course';
            } catch (e) {
                console.error(e);
                Auth.showToast('Error saving: ' + e.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save"></i> Save Course';
            }
        };

    </script>
</body>

</html>