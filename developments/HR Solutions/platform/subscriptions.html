<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscriptions - Gridify Platform</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="auth-check.js"></script>
</head>

<body>
    <div class="portal-layout">
        <aside class="sidebar">
            <div style="margin-bottom: 2rem; padding: 0 0.5rem; text-align: center;">
                <img src="https://www.gridify.in/assets/images/logos/logo.png" alt="Gridify"
                    style="height: 48px; margin-bottom: 0.5rem;">
                <div style="font-size: 0.75rem; letter-spacing: 0.1em; color: var(--success-color); font-weight: 700;">
                    PLATFORM</div>
            </div>

            <nav>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home nav-icon"></i> Dashboard
                </a>
                <a href="organizations.html" class="nav-item">
                    <i class="fas fa-building nav-icon"></i> Organizations
                </a>
                <a href="#" class="nav-item active">
                    <i class="fas fa-credit-card nav-icon"></i> Subscriptions
                </a>
                <a href="users.html" class="nav-item">
                    <i class="fas fa-users-cog nav-icon"></i> Platform Users
                </a>
                <a href="security.html" class="nav-item">
                    <i class="fas fa-shield-alt nav-icon"></i> Security Logs
                </a>
            </nav>

            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
                <div class="nav-item" style="cursor: pointer;" onclick="logout()">
                    <i class="fas fa-sign-out-alt nav-icon"></i> Logout
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 1.75rem;">Subscriptions</h1>
                    <p style="color: var(--text-secondary);">Manage tenant billing, active plans, and limits</p>
                </div>
            </header>

            <!-- Tabs -->
            <div
                style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 1rem;">
                <button class="btn btn-outline active-tab" id="tabOrgs" onclick="switchTab('orgs')">Org
                    Subscriptions</button>
                <button class="btn btn-outline" id="tabPlans" onclick="switchTab('plans')">Plan Definitions</button>
            </div>

            <!-- Org Subscriptions Section -->
            <div id="sectionOrgs" class="glass-panel" style="padding: 0;">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--glass-border);">
                    <h3 style="font-size: 1.1rem;">Organization Plans</h3>
                </div>
                <div id="subsList" style="padding: 1.5rem;">
                    <div style="text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin"></i> Loading subscriptions...
                    </div>
                </div>
            </div>

            <!-- Plan Definitions Section -->
            <div id="sectionPlans" class="glass-panel" style="padding: 0; display: none;">
                <div
                    style="padding: 1.5rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="font-size: 1.1rem;">Plan Definitions</h3>
                    <button class="btn btn-primary" onclick="openPlanDefModal()">
                        <i class="fas fa-plus"></i> New Plan
                    </button>
                </div>
                <div id="plansList" style="padding: 1.5rem;">
                    <div style="text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin"></i> Loading plans...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Org Subscription Modal -->
    <div id="planModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
        <div class="glass-panel" style="width: 100%; max-width: 450px; padding: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Manage Org Subscription</h3>
            <div id="planOrgName"
                style="font-weight: 800; color: var(--success-color); margin-bottom: 1.5rem; font-size: 1.2rem;"></div>
            <form id="updatePlanForm" onsubmit="handleUpdateOrgSub(event)">
                <input type="hidden" id="subOrgId">
                <div class="form-group">
                    <label class="form-label">Select Plan</label>
                    <select id="selectedPlanId" class="form-input" required>
                        <!-- Populated via JS -->
                    </select>
                </div>
                <div class="grid-cols-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Start Date</label>
                        <input type="date" id="subStartDate" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" id="subEndDate" class="form-input" required>
                    </div>
                </div>

                <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="subSaveBtn">Save Subscription</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Plan Definition Modal -->
    <div id="planDefModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
        <div class="glass-panel" style="width: 100%; max-width: 400px; padding: 2rem;">
            <h3 id="planDefTitle" style="margin-bottom: 1.5rem;">New Plan Definition</h3>
            <form id="planDefForm" onsubmit="handlePlanDefSubmit(event)">
                <input type="hidden" id="planDefId">
                <div class="form-group">
                    <label class="form-label">Plan Name</label>
                    <input type="text" id="planName" class="form-input" placeholder="e.g. Starter" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Price ($/mo)</label>
                    <input type="number" id="planPrice" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Max Employees</label>
                    <input type="number" id="planMaxEmp" class="form-input" placeholder="e.g. 10" required>
                </div>

                <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="planDefBtn">Create Plan</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .active-tab {
            background: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
        }
    </style>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, getDocs, query, orderBy, doc, updateDoc, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        let currentPlans = [];

        window.switchTab = (tab) => {
            document.getElementById('sectionOrgs').style.display = tab === 'orgs' ? 'block' : 'none';
            document.getElementById('sectionPlans').style.display = tab === 'plans' ? 'block' : 'none';
            document.getElementById('tabOrgs').classList.toggle('active-tab', tab === 'orgs');
            document.getElementById('tabPlans').classList.toggle('active-tab', tab === 'plans');
            if (tab === 'orgs') loadSubscriptions();
            else loadPlans();
        };

        window.closeModal = () => {
            document.getElementById('planModal').style.display = 'none';
            document.getElementById('planDefModal').style.display = 'none';
        };

        async function loadPlans() {
            const list = document.getElementById('plansList');
            try {
                const q = query(collection(db, "subscription_plans"), orderBy("price"));
                const snapshot = await getDocs(q);
                currentPlans = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                if (currentPlans.length === 0) {
                    list.innerHTML = `<div style="text-align: center; padding: 2rem;">No plans defined.</div>`;
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse; text-align: left;">';
                html += `
                    <thead>
                        <tr style="color: var(--text-secondary); font-size: 0.85rem; border-bottom: 1px solid var(--glass-border);">
                            <th style="padding: 0.75rem 0;">PLAN NAME</th>
                            <th style="padding: 0.75rem 0;">PRICE</th>
                            <th style="padding: 0.75rem 0;">MAX EMPLOYEES</th>
                            <th style="padding: 0.75rem 0; text-align: right;">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                currentPlans.forEach(plan => {
                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 1rem 0; font-weight: 500;">${plan.name}</td>
                            <td style="padding: 1rem 0;">$${plan.price}/mo</td>
                            <td style="padding: 1rem 0;">${plan.maxEmployees} Employees</td>
                            <td style="padding: 1rem 0; text-align: right;">
                                <button onclick="editPlanDef('${plan.id}')" class="btn btn-icon"><i class="fas fa-edit"></i></button>
                                <button onclick="deletePlanDef('${plan.id}')" class="btn btn-icon"><i class="fas fa-trash" style="color:var(--error-color)"></i></button>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (err) {
                console.error(err);
                list.innerHTML = "Error loading plans.";
            }
        }

        async function loadSubscriptions() {
            const list = document.getElementById('subsList');
            try {
                // Ensure plans are loaded first for the dropdown
                const planSnap = await getDocs(collection(db, "subscription_plans"));
                currentPlans = planSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                const q = query(collection(db, "organizations"), orderBy("name"));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    list.innerHTML = `<div style="text-align: center; padding: 2rem;">No organizations found.</div>`;
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse; text-align: left;">';
                html += `
                    <thead>
                        <tr style="color: var(--text-secondary); font-size: 0.85rem; border-bottom: 1px solid var(--glass-border);">
                            <th style="padding: 0.75rem 0;">ORGANIZATION</th>
                            <th style="padding: 0.75rem 0;">ACTIVE PLAN</th>
                            <th style="padding: 0.75rem 0;">PERIOD</th>
                            <th style="padding: 0.75rem 0;">STATUS</th>
                            <th style="padding: 0.75rem 0; text-align: right;">ACTION</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const id = docSnap.id;

                    const planName = currentPlans.find(p => p.id === data.subscriptionPlanId)?.name || 'NO PLAN';
                    const startDate = data.subscriptionStartDate || 'N/A';
                    const endDate = data.subscriptionEndDate || 'N/A';

                    // Check if expired
                    const now = new Date().toISOString().split('T')[0];
                    const isExpired = endDate !== 'N/A' && endDate < now;

                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 1rem 0;">
                                <div style="font-weight: 500;">${data.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">ID: ${data.orgId || 'N/A'}</div>
                            </td>
                            <td style="padding: 1rem 0;">
                                <span class="badge badge-primary" style="background: rgba(99, 102, 241, 0.2); color: #818cf8;">
                                    ${planName}
                                </span>
                            </td>
                            <td style="padding: 1rem 0; font-size: 0.85rem;">
                                ${startDate} to ${endDate}
                            </td>
                            <td style="padding: 1rem 0;">
                                <span class="badge ${isExpired ? 'badge-error' : 'badge-success'}">${isExpired ? 'EXPIRED' : data.status}</span>
                            </td>
                            <td style="padding: 1rem 0; text-align: right;">
                                <button onclick="openPlanModal('${id}', '${data.name}', '${data.subscriptionPlanId}', '${startDate}', '${endDate}')" class="btn btn-outline" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                                    Manage Sub
                                </button>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                list.innerHTML = html;
            } catch (error) {
                console.error("Load Error:", error);
                list.innerHTML = `<div style="color: var(--error-color);">Error loading data.</div>`;
            }
        }

        window.openPlanDefModal = () => {
            document.getElementById('planDefId').value = '';
            document.getElementById('planName').value = '';
            document.getElementById('planPrice').value = '';
            document.getElementById('planMaxEmp').value = '';
            document.getElementById('planDefTitle').textContent = 'New Plan Definition';
            document.getElementById('planDefBtn').textContent = 'Create Plan';
            document.getElementById('planDefModal').style.display = 'flex';
        };

        window.editPlanDef = (id) => {
            const plan = currentPlans.find(p => p.id === id);
            if (!plan) return;
            document.getElementById('planDefId').value = id;
            document.getElementById('planName').value = plan.name;
            document.getElementById('planPrice').value = plan.price;
            document.getElementById('planMaxEmp').value = plan.maxEmployees;
            document.getElementById('planDefTitle').textContent = 'Edit Plan Definition';
            document.getElementById('planDefBtn').textContent = 'Save Changes';
            document.getElementById('planDefModal').style.display = 'flex';
        };

        window.handlePlanDefSubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('planDefId').value;
            const data = {
                name: document.getElementById('planName').value,
                price: parseFloat(document.getElementById('planPrice').value),
                maxEmployees: parseInt(document.getElementById('planMaxEmp').value),
                status: 'ACTIVE'
            };
            const btn = document.getElementById('planDefBtn');
            btn.disabled = true;
            try {
                if (id) await updateDoc(doc(db, "subscription_plans", id), data);
                else await addDoc(collection(db, "subscription_plans"), data);
                closeModal();
                loadPlans();
            } catch (err) { alert(err.message); }
            finally { btn.disabled = false; }
        };

        window.deletePlanDef = async (id) => {
            if (!confirm("Are you sure? Organizations using this plan will lose their plan reference.")) return;
            await deleteDoc(doc(db, "subscription_plans", id));
            loadPlans();
        };

        window.openPlanModal = (id, name, planId, start, end) => {
            document.getElementById('subOrgId').value = id;
            document.getElementById('planOrgName').textContent = name;

            const select = document.getElementById('selectedPlanId');
            select.innerHTML = '<option value="">Select Plan</option>' +
                currentPlans.map(p => `<option value="${p.id}" ${p.id === planId ? 'selected' : ''}>${p.name} (${p.maxEmployees} Emp)</option>`).join('');

            document.getElementById('subStartDate').value = start !== 'N/A' ? start : '';
            document.getElementById('subEndDate').value = end !== 'N/A' ? end : '';
            document.getElementById('planModal').style.display = 'flex';
        };

        window.handleUpdateOrgSub = async (e) => {
            e.preventDefault();
            const id = document.getElementById('subOrgId').value;
            const planId = document.getElementById('selectedPlanId').value;
            const start = document.getElementById('subStartDate').value;
            const end = document.getElementById('subEndDate').value;

            const btn = document.getElementById('subSaveBtn');
            btn.disabled = true;

            try {
                await updateDoc(doc(db, "organizations", id), {
                    subscriptionPlanId: planId,
                    subscriptionStartDate: start,
                    subscriptionEndDate: end
                });
                closeModal();
                loadSubscriptions();
            } catch (err) { alert(err.message); }
            finally { btn.disabled = false; }
        };

        switchTab('orgs');
    </script>
</body>

</html>