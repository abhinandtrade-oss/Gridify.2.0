<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Platform Users - Gridify Platform</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="auth-check.js"></script>
</head>

<body>
    <div class="portal-layout">
        <aside class="sidebar">
            <div style="margin-bottom: 2rem; padding: 0 0.5rem; text-align: center;">
                <img src="https://www.gridify.in/assets/images/logos/logo.png" alt="Gridify"
                    style="height: 48px; margin-bottom: 0.5rem;">
                <div style="font-size: 0.75rem; letter-spacing: 0.1em; color: var(--success-color); font-weight: 700;">
                    PLATFORM</div>
            </div>

            <nav>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home nav-icon"></i> Dashboard
                </a>
                <a href="organizations.html" class="nav-item">
                    <i class="fas fa-building nav-icon"></i> Organizations
                </a>
                <a href="subscriptions.html" class="nav-item">
                    <i class="fas fa-credit-card nav-icon"></i> Subscriptions
                </a>
                <a href="#" class="nav-item active">
                    <i class="fas fa-users-cog nav-icon"></i> Platform Users
                </a>
                <a href="security.html" class="nav-item">
                    <i class="fas fa-shield-alt nav-icon"></i> Security Logs
                </a>
            </nav>

            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
                <div class="nav-item" style="cursor: pointer;" onclick="logout()">
                    <i class="fas fa-sign-out-alt nav-icon"></i> Logout
                </div>
            </div>
        </aside>

        <main class="main-content">
            <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h1 style="font-size: 1.75rem;">Platform Users</h1>
                    <p style="color: var(--text-secondary);">View internal team members with platform access</p>
                </div>
                <button class="btn btn-primary" onclick="openModal()">
                    <i class="fas fa-user-plus" style="margin-right: 0.5rem;"></i> Add Admin
                </button>
            </header>

            <div class="glass-panel" style="padding: 0;">
                <div style="padding: 1.5rem; border-bottom: 1px solid var(--glass-border);">
                    <h3 style="font-size: 1.1rem;">Active Administrators</h3>
                </div>
                <div id="usersList" style="padding: 1.5rem;">
                    <div style="text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-spinner fa-spin"></i> Loading users...
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create User Modal -->
    <div id="createModal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
        <div class="glass-panel" style="width: 100%; max-width: 400px; padding: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Add Platform Admin</h3>
            <form id="createUserForm" onsubmit="handleCreateUser(event)">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="userEmail" class="form-input" placeholder="name@gridify.in" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Initial Password</label>
                    <input type="text" id="userPassword" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="userRole" class="form-input">
                        <option value="PLATFORM_ADMIN">Platform Admin</option>
                        <option value="SUPER_ADMIN">Super Admin</option>
                        <option value="SUPPORT_LEAD">Support Lead</option>
                    </select>
                </div>

                <div style="margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 1rem;">
                    <button type="button" class="btn btn-outline" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, getDocs, query, orderBy, addDoc, serverTimestamp, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        window.openModal = () => document.getElementById('createModal').style.display = 'flex';
        window.closeModal = () => document.getElementById('createModal').style.display = 'none';

        async function loadUsers() {
            const list = document.getElementById('usersList');
            try {
                const q = query(collection(db, "platform_users"), orderBy("grantedAt", "desc"));
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    list.innerHTML = `<div style="text-align: center; padding: 2rem;">No users found.</div>`;
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse; text-align: left;">';
                html += `
                    <thead>
                        <tr style="color: var(--text-secondary); font-size: 0.85rem; border-bottom: 1px solid var(--glass-border);">
                            <th style="padding: 0.75rem 0;">USER</th>
                            <th style="padding: 0.75rem 0;">ROLE</th>
                            <th style="padding: 0.75rem 0;">STATUS</th>
                            <th style="padding: 0.75rem 0; text-align: right;">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    const isSuspended = data.status === 'SUSPENDED';

                    html += `
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                            <td style="padding: 1rem 0;">
                                <div style="font-weight: 500;">${data.email}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Added: ${data.grantedAt?.toDate().toLocaleDateString() || 'N/A'}</div>
                            </td>
                            <td style="padding: 1rem 0;">
                                <span class="badge ${data.role === 'SUPER_ADMIN' ? 'badge-success' : 'badge-primary'}" style="background: ${data.role === 'SUPER_ADMIN' ? '' : 'rgba(99, 102, 241, 0.2); color: #818cf8;'}">${data.role}</span>
                            </td>
                            <td style="padding: 1rem 0;">
                                <span class="status-dot ${isSuspended ? 'rejected' : 'approved'}"></span>
                                <span style="font-size: 0.85rem; opacity: 0.8;">${data.status}</span>
                            </td>
                            <td style="padding: 1rem 0; text-align: right;">
                                <button onclick="toggleUserStatus('${id}', '${data.status}')" class="btn btn-icon" title="${isSuspended ? 'Activate' : 'Suspend'}">
                                    <i class="fas ${isSuspended ? 'fa-play' : 'fa-pause'}" style="color: ${isSuspended ? 'var(--success-color)' : 'var(--warning-color)'}"></i>
                                </button>
                                <button onclick="deleteUser('${id}')" class="btn btn-icon" title="Delete">
                                    <i class="fas fa-trash" style="color: var(--error-color)"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table>';
                list.innerHTML = html;

            } catch (error) {
                console.error("Load Error:", error);
                list.innerHTML = `<div style="color: var(--error-color); text-align: center;">Error loading users.</div>`;
            }
        }

        window.handleCreateUser = async function (e) {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

            try {
                await addDoc(collection(db, "platform_users"), {
                    email: document.getElementById('userEmail').value,
                    password: document.getElementById('userPassword').value,
                    role: document.getElementById('userRole').value,
                    status: 'ACTIVE',
                    grantedAt: serverTimestamp()
                });

                closeModal();
                loadUsers();
                e.target.reset();
            } catch (err) {
                alert("Error adding user: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Add User';
            }
        };

        window.toggleUserStatus = async (id, currentStatus) => {
            const newStatus = currentStatus === 'ACTIVE' ? 'SUSPENDED' : 'ACTIVE';
            if (!confirm(`Switch user to ${newStatus}?`)) return;
            try {
                await updateDoc(doc(db, "platform_users", id), { status: newStatus });
                loadUsers();
            } catch (err) {
                alert("Error updating status: " + err.message);
            }
        };

        window.deleteUser = async (id) => {
            if (!confirm("Permanently delete this platform admin?")) return;
            try {
                await deleteDoc(doc(db, "platform_users", id));
                loadUsers();
            } catch (err) {
                alert("Error deleting user: " + err.message);
            }
        };

        loadUsers();
    </script>
</body>

</html>