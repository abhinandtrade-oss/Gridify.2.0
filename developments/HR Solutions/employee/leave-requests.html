<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Management - Portal</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Fix selected option visibility on Windows */
        option {
            background-color: #0f172a;
            color: white;
        }
    </style>
</head>

<body>
    <div class="portal-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div style="margin-bottom: 3rem; padding: 0.5rem; display: flex; align-items: center; gap: 1rem;">
                <div
                    style="width: 45px; height: 45px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-family: 'Outfit'; font-size: 1.25rem; box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2);">
                    G</div>
                <div>
                    <div class="logo" style="font-size: 1.25rem; margin-bottom: 0;">Gridify</div>
                    <div
                        style="font-size: 0.65rem; color: var(--success-color); font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;">
                        Employee Hub</div>
                </div>
            </div>

            <nav>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-th-large nav-icon"></i> Overview
                </a>
                <a href="attendance.html" class="nav-item">
                    <i class="fas fa-fingerprint nav-icon"></i> Attendance
                </a>
                <a href="leave-requests.html" class="nav-item active">
                    <i class="fas fa-calendar-plus nav-icon"></i> Absences
                </a>
                <a href="payslips.html" class="nav-item">
                    <i class="fas fa-file-invoice-dollar nav-icon"></i> Financials
                </a>
                <a href="profile.html" class="nav-item">
                    <i class="fas fa-user-shield nav-icon"></i> Profile
                </a>
            </nav>

            <div
                style="margin-top: auto; padding: 1.5rem; background: rgba(259, 68, 68, 0.05); border-radius: 16px; border: 1px solid rgba(239, 68, 68, 0.1);">
                <div class="nav-item" style="cursor: pointer; color: #ef4444; margin: 0; padding: 0;"
                    onclick="logout()">
                    <i class="fas fa-power-off nav-icon"></i> Disconnect
                </div>
            </div>
        </aside>
        <div class="sidebar-overlay" onclick="document.getElementById('sidebar').classList.remove('active')"></div>

        <!-- Main Content -->
        <main class="main-content">
            <header
                style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2.5rem;">
                <div>
                    <h1 style="font-size: 2rem; margin-bottom: 0.25rem;">Absence Management</h1>
                    <p style="color: var(--text-secondary);">Request time off and track your operational status.</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" style="padding: 0.75rem 1.5rem; font-weight: 700;"
                        onclick="openLeaveModal()">
                        <i class="fas fa-plus" style="margin-right: 0.5rem;"></i> INITIALIZE REQUEST
                    </button>
                    <div class="mobile-nav-toggle"
                        onclick="document.getElementById('sidebar').classList.toggle('active')">
                        <i class="fas fa-bars"></i>
                    </div>
                </div>
            </header>

            <!-- Real-time Quotas -->
            <div class="card-grid" style="margin-bottom: 2.5rem;">
                <div class="glass-panel stat-card" style="position: relative; overflow: hidden;">
                    <div
                        style="position: absolute; top: -10px; right: -10px; opacity: 0.05; font-size: 5rem; transform: rotate(-15deg);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-label">Approved Duration</div>
                    <div id="statApproved" class="stat-value" style="font-size: 2.5rem; color: var(--success-color);">0
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">Allocated days this
                        cycle</p>
                </div>
                <div class="glass-panel stat-card" style="position: relative; overflow: hidden;">
                    <div
                        style="position: absolute; top: -10px; right: -10px; opacity: 0.05; font-size: 5rem; transform: rotate(-15deg);">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="stat-label">Pending Verification</div>
                    <div id="statPending" class="stat-value" style="font-size: 2.5rem; color: var(--warning-color);">0
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">Awaiting
                        administrative review</p>
                </div>
                <div class="glass-panel stat-card"
                    style="position: relative; overflow: hidden; border-color: rgba(99, 102, 241, 0.3);">
                    <div
                        style="position: absolute; top: -10px; right: -10px; opacity: 0.05; font-size: 5rem; transform: rotate(-15deg);">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <div class="stat-label">Available Quota</div>
                    <div id="statQuota" class="stat-value" style="font-size: 2.5rem; color: var(--primary-color);">24
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">Standard baseline
                        protocol</p>
                </div>
            </div>

            <div class="glass-panel" style="padding: 2rem;">
                <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-history" style="color: var(--primary-color);"></i> Operational Log
                </h3>
                <div class="table-responsive">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0 0.75rem; min-width: 800px;">
                        <thead>
                            <tr
                                style="text-align: left; color: var(--text-secondary); text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.1em;">
                                <th style="padding: 0 1.25rem;">Protocol Type</th>
                                <th style="padding: 0 1.25rem;">Temporal Range</th>
                                <th style="padding: 0 1.25rem;">Units</th>
                                <th style="padding: 0 1.25rem;">Justification</th>
                                <th style="padding: 0 1.25rem;">Synchronized</th>
                                <th style="padding: 0 1.25rem;">State</th>
                            </tr>
                        </thead>
                        <tbody id="leaveList">
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 4rem;">
                                    <div class="loading-spinner" style="border-top-color: var(--primary-color);"></div>
                                    <p style="margin-top: 1rem; color: var(--text-secondary);">Syncing with cloud
                                        central...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Initialization Modal -->
    <div id="leaveModal" class="flex-center"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 2000; backdrop-filter: blur(12px);">
        <div class="glass-panel"
            style="width: 90%; max-width: 500px; padding: 2.5rem; border: 1px solid var(--glass-border); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <h3 style="margin: 0; font-family: 'Outfit';">Initialize Absence Request</h3>
                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">Submit your
                        temporal override for review.</p>
                </div>
                <button onclick="closeLeaveModal()"
                    style="background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: var(--text-muted); cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="leaveForm" onsubmit="submitLeave(event)">
                <div class="form-group">
                    <label class="form-label" style="display:flex; justify-content:space-between;">
                        <span>Classification</span>
                        <span id="quotaInfo" style="font-size: 0.8rem; color: var(--text-muted);">Fetching...</span>
                    </label>
                    <select id="leaveType" class="form-input"
                        style="background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); color: white;"
                        required>
                        <option value="Casual Leave">Casual Leave</option>
                        <option value="Sick Leave">Sick Leave</option>
                        <option value="Earned Leave">Earned Leave</option>
                        <option value="Comp Off">Comp Off</option>
                        <option value="Personal Duty">Personal Duty</option>
                    </select>
                </div>
                <div class="stack-on-mobile" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div class="form-group">
                        <label class="form-label">Genesis Date</label>
                        <input type="date" id="startDate" class="form-input" required onchange="calcDays()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Termination Date</label>
                        <input type="date" id="endDate" class="form-input" required onchange="calcDays()">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Calculated Telemetry</label>
                    <div
                        style="display: flex; align-items: center; gap: 1rem; background: rgba(99, 102, 241, 0.1); padding: 1rem; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.2);">
                        <i class="fas fa-calculator" style="color: var(--primary-color);"></i>
                        <span id="dayPreview" style="font-weight: 700; color: white;">0 Day(s) Total</span>
                        <input type="hidden" id="totalDays" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Operational Justification</label>
                    <textarea id="leaveReason" class="form-input" rows="3"
                        placeholder="Provide context for the request..." style="resize: none;" required></textarea>
                </div>

                <button type="submit" class="btn btn-primary"
                    style="width: 100%; margin-top: 1rem; font-weight: 800; height: 55px; font-size: 1rem; letter-spacing: 0.05em;">
                    INITIALIZE SUBMISSION
                </button>
            </form>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, addDoc, query, where, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const userData = JSON.parse(sessionStorage.getItem('empUser'));
        if (!userData) window.location.href = '../index.html';

        window.logout = () => { sessionStorage.clear(); window.location.href = '../index.html'; };

        // Handle URL trigger
        const params = new URLSearchParams(window.location.search);
        if (params.get('action') === 'new') setTimeout(() => openLeaveModal(), 500);

        // Modal Logic
        window.openLeaveModal = () => document.getElementById('leaveModal').style.display = 'flex';
        window.closeLeaveModal = () => document.getElementById('leaveModal').style.display = 'none';

        window.calcDays = () => {
            const s = document.getElementById('startDate').value;
            const e = document.getElementById('endDate').value;
            if (s && e) {
                const start = new Date(s);
                const end = new Date(e);
                const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                const val = diff > 0 ? diff : 0;
                document.getElementById('totalDays').value = val;
                document.getElementById('dayPreview').textContent = `${val} Day(s) Total`;
            }
        };

        // Initialize Quota
        let leaveQuota = userData.leaveQuota || {
            'Casual Leave': 0, 'Sick Leave': 0, 'Earned Leave': 0, 'Comp Off': 0, 'Personal Duty': 0 // Defaults if not set
        };

        // Fetch fresh quota to handle updates without re-login
        async function fetchLatestQuota() {
            try {
                const searchEmail = userData.email.toLowerCase().trim();
                const q = query(
                    collection(db, "organizations", userData.orgId, "employees"),
                    where("email", "==", searchEmail)
                );
                const snap = await getDocs(q);
                if (!snap.empty) {
                    const freshData = snap.docs[0].data();
                    if (freshData.leaveQuota) {
                        leaveQuota = freshData.leaveQuota;
                        updateQuotaDisplay();
                    }
                }
            } catch (e) {
                console.error("Quota sync failed", e);
            }
        }
        fetchLatestQuota();

        function getQuota(type) {
            return leaveQuota[type] || 0;
        }

        // Update UI with Quota Info
        function updateQuotaDisplay() {
            const type = document.getElementById('leaveType').value;
            const total = getQuota(type);

            // Calculate used
            let used = 0;
            const rows = document.querySelectorAll('#leaveList tr');
            // This is hacky client-side check. Better to filter `qs` data if available globally
            // We can use the cached `currentLeaveData` if we store it
            if (window.currentLeaveData) {
                window.currentLeaveData.forEach(d => {
                    if (d.type === type && d.status !== 'Rejected') used += d.days;
                });
            }

            const remaining = total - used;
            document.getElementById('quotaInfo').textContent = `Quota: ${remaining} / ${total} Remaining`;
            document.getElementById('quotaInfo').style.color = remaining > 0 ? 'var(--success-color)' : 'var(--error-color)';

            // Update Dashboard Stat
            const totalQuotaAll = Object.values(leaveQuota).reduce((a, b) => a + b, 0);
            if (window.currentLeaveData) {
                document.getElementById('statQuota').textContent = Math.max(0, totalQuotaAll - window.currentLeaveData.filter(d => d.status !== 'Rejected').reduce((sum, d) => sum + d.days, 0));
            }
        }

        document.getElementById('leaveType').addEventListener('change', updateQuotaDisplay);

        window.submitLeave = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const original = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> TRANSMITTING...';
            btn.disabled = true;

            try {
                const type = document.getElementById('leaveType').value;
                const days = parseInt(document.getElementById('totalDays').value);
                if (days <= 0) throw new Error("Invalid temporal range detected.");

                // Check Quota
                const totalQuota = getQuota(type);
                // Calculate currently used + pending
                let used = 0;
                if (window.currentLeaveData) {
                    window.currentLeaveData.forEach(d => {
                        if (d.type === type && d.status !== 'Rejected') used += d.days;
                    });
                }

                if (used + days > totalQuota) {
                    throw new Error(`Insufficient Quota for ${type}. Authorized: ${totalQuota}, Used/Pending: ${used}, Requested: ${days}.`);
                }

                const userEmailNormalized = userData.email.toLowerCase().trim();
                await addDoc(collection(db, "organizations", userData.orgId, "leave_requests"), {
                    userId: userEmailNormalized,
                    userName: userData.name || userData.email,
                    orgId: userData.orgId,
                    type: type,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    reason: document.getElementById('leaveReason').value,
                    days: days,
                    status: 'Pending',
                    appliedAt: serverTimestamp()
                });

                closeLeaveModal();
                e.target.reset();
                document.getElementById('dayPreview').textContent = '0 Day(s) Total';
            } catch (err) {
                alert(err.message);
            } finally {
                btn.innerHTML = original;
                btn.disabled = false;
            }
        };

        // Real-time History Link
        const searchEmail = userData.email.toLowerCase().trim();
        const q = query(
            collection(db, "organizations", userData.orgId, "leave_requests"),
            where("userId", "==", searchEmail)
        );

        onSnapshot(q, (snapshot) => {
            const list = document.getElementById('leaveList');
            let approved = 0, pending = 0;
            list.innerHTML = '';

            // Store globally for validation
            window.currentLeaveData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

            // Client-side Sort
            const docs = window.currentLeaveData
                .sort((a, b) => (b.appliedAt?.seconds || 0) - (a.appliedAt?.seconds || 0));

            if (docs.length === 0) {
                // ... empty ...
                list.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 4rem; color: var(--text-secondary);">No historical records detected.</td></tr>';
            }

            docs.forEach(data => {
                if (data.status === 'Approved') approved += (data.days || 0);
                if (data.status === 'Pending') pending += (data.days || 0);

                const row = document.createElement('tr');
                row.style.background = 'rgba(255,255,255,0.02)';
                row.style.borderRadius = '12px';

                row.innerHTML = `
                    <td style="padding: 1.5rem; border-top-left-radius: 12px; border-bottom-left-radius: 12px;">
                        <span style="font-weight: 700; color: white;">${data.type}</span>
                    </td>
                    <td style="padding: 1.5rem; font-family: monospace;">${data.startDate} â†’ ${data.endDate}</td>
                    <td style="padding: 1.5rem;"><span style="background: rgba(255,255,255,0.05); padding: 0.4rem 0.8rem; border-radius: 8px; font-weight: 600;">${data.days} D</span></td>
                    <td style="padding: 1.5rem; max-width: 200px;"><div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.9rem;" title="${data.reason}">${data.reason}</div></td>
                    <td style="padding: 1.5rem; color: var(--text-muted); font-size: 0.8rem;">${data.appliedAt ? new Date(data.appliedAt.seconds * 1000).toLocaleString() : 'Processing...'}</td>
                    <td style="padding: 1.5rem; border-top-right-radius: 12px; border-bottom-right-radius: 12px;">
                        <span class="badge ${getBadgeClass(data.status)}">${data.status.toUpperCase()}</span>
                    </td>
                `;
                list.appendChild(row);
            });

            document.getElementById('statApproved').textContent = approved;
            document.getElementById('statPending').textContent = pending;
            // Update Stat Quota - Show total remaining across all types? Or generic "Leave Quota"? 
            // Let's show "Casual Leave" quota as default or just generic "Total Available"
            const totalQuotaAll = Object.values(leaveQuota).reduce((a, b) => a + b, 0);
            const totalUsed = approved + pending; // Or should we track usage per type strictly? 
            // Ideally track per type. But the card needs a single number. 
            // Let's sum all quotas match against all usage.
            document.getElementById('statQuota').textContent = Math.max(0, totalQuotaAll - window.currentLeaveData.filter(d => d.status !== 'Rejected').reduce((sum, d) => sum + d.days, 0));

            // Also update the form display
            updateQuotaDisplay();
        });

        function getBadgeClass(status) {
            if (status === 'Approved') return 'badge-success';
            if (status === 'Pending') return 'badge-warning';
            if (status === 'Rejected') return 'badge-error';
            return 'badge-info';
        }
    </script>
</body>

</html>
</body>

</html>