<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payroll & Treasury - Gridify</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="portal-layout">
        <aside class="sidebar" id="sidebar">
            <div style="margin-bottom: 2.5rem; text-align: left; padding: 0.5rem;">
                <div class="logo" style="margin-bottom: 0.25rem;">Gridify</div>
                <p
                    style="font-size: 0.75rem; color: var(--text-muted); font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">
                    Organization Console</p>
            </div>

            <nav>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-th-large"></i> Overview
                </a>
                <a href="employees.html" class="nav-item">
                    <i class="fas fa-users"></i> Employees
                </a>
                <a href="departments.html" class="nav-item">
                    <i class="fas fa-layer-group"></i> Departments
                </a>
                <a href="approvals.html" class="nav-item">
                    <i class="fas fa-inbox"></i> Approval Hub
                </a>
                <a href="attendance.html" class="nav-item">
                    <i class="fas fa-calendar-check"></i> Attendance
                </a>
                <a href="leave-requests.html" class="nav-item">
                    <i class="fas fa-envelope-open-text"></i> Leave Requests
                </a>
                <a href="payroll.html" class="nav-item active">
                    <i class="fas fa-file-invoice-dollar"></i> Payroll
                </a>
                <a href="settings.html" class="nav-item">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </nav>

            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
                <div class="nav-item" style="cursor: pointer; color: var(--error-color);" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </div>
            </div>
        </aside>
        <div class="sidebar-overlay" onclick="document.getElementById('sidebar').classList.remove('active')"></div>

        <main class="main-content">
            <header
                style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2.5rem;">
                <div>
                    <h1 style="font-size: 2rem; margin-bottom: 0.25rem;">Treasury & Payroll</h1>
                    <p style="color: var(--text-secondary);">Execute and monitor financial disbursements.</p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="openRunPayroll()">
                        <i class="fas fa-bolt" style="margin-right: 0.6rem;"></i> Execute Batch
                    </button>
                    <div class="mobile-nav-toggle"
                        onclick="document.getElementById('sidebar').classList.toggle('active')">
                        <i class="fas fa-bars"></i>
                    </div>
                </div>
            </header>

            <div class="tab-container"
                style="display: flex; gap: 2.5rem; border-bottom: 1px solid var(--glass-border); margin-bottom: 2.5rem;">
                <div id="tabDisb" class="tab-item active" onclick="switchTab('disbursements')">
                    <i class="fas fa-file-invoice-dollar" style="margin-right: 0.5rem;"></i> Disbursement History
                </div>
                <div id="tabBene" class="tab-item" onclick="switchTab('benefits')">
                    <i class="fas fa-gift" style="margin-right: 0.5rem;"></i> Benefits Configuration
                </div>
            </div>

            <div id="disbursementsPanel" class="tab-content">
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem;">
                    <div class="glass-panel" style="padding: 1.5rem; border-left: 4px solid var(--primary-color);">
                        <p
                            style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
                            Total Monthly Payout</p>
                        <h3 id="statTotalPayout" style="font-size: 1.75rem; font-weight: 800; color: white;">₹ 0.00</h3>
                    </div>
                    <div class="glass-panel" style="padding: 1.5rem; border-left: 4px solid var(--secondary-color);">
                        <p
                            style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
                            Active Payees</p>
                        <h3 id="statActivePayees" style="font-size: 1.75rem; font-weight: 800; color: white;">0</h3>
                    </div>
                    <div class="glass-panel" style="padding: 1.5rem; border-left: 4px solid var(--success-color);">
                        <p
                            style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em;">
                            Last Cycle Status</p>
                        <h3 style="font-size: 1.75rem; font-weight: 800; color: var(--success-color);">Finalized</h3>
                    </div>
                </div>

                <div class="glass-panel" style="padding:0; overflow: hidden; border: 1px solid var(--glass-border);">
                    <div
                        style="padding: 1.5rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="font-size: 1.1rem; font-weight: 700;">Financial Archives</h3>
                        <div style="display: flex; gap: 0.75rem;">
                            <input type="month" id="payrollMonth" class="form-input"
                                style="width: auto; height: 36px; margin:0;" onchange="loadPayrollHistory()">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr
                                    style="text-align: left; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--glass-border);">
                                    <th style="padding: 1.25rem;">Staff Member</th>
                                    <th style="padding: 1.25rem;">Remuneration Breakup</th>
                                    <th style="padding: 1.25rem;">Net Payout</th>
                                    <th style="padding: 1.25rem; text-align: right;">Authorization</th>
                                </tr>
                            </thead>
                            <tbody id="payrollHistory">
                                <tr>
                                    <td colspan="4" style="text-align: center; padding: 5rem; opacity: 0.5;">
                                        <i class="fas fa-folder-open fa-2x" style="margin-bottom: 1rem;"></i>
                                        <p>No financial archives for this period.</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="benefitsPanel" class="tab-content" style="display: none;">
                <div class="glass-panel" style="padding: 2.5rem; margin-bottom: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h3 style="font-size: 1.25rem; font-weight: 700;">Active Benefits Inventory</h3>
                        <button class="btn btn-primary btn-sm" onclick="openBenefitModal()">
                            <i class="fas fa-plus"></i> New Benefit Policy
                        </button>
                    </div>
                    <div id="benefitsList"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                        <!-- Benefits list -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Run Payroll Modal -->
    <div id="runPayrollModal" class="flex-center"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; backdrop-filter: blur(12px);">
        <div class="glass-panel"
            style="width: 95%; max-width: 1000px; height: 90vh; padding: 0; display: flex; flex-direction: column; border: 1px solid var(--glass-border);">
            <div
                style="padding: 2rem; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3 style="font-size: 1.5rem;">Execute Disbursement Cycle</h3>
                    <p style="font-size: 0.85rem; color: var(--text-muted);">Calculating salaries based on attendance
                        metrics and structures.</p>
                </div>
                <button onclick="closeRunPayroll()" class="btn btn-outline"
                    style="min-width: unset; padding: 0.5rem 0.75rem; border-radius: 50%;"><i
                        class="fas fa-times"></i></button>
            </div>
            <div style="flex:1; overflow-y: auto; padding: 2rem;">
                <div id="runPayrollList"></div>
            </div>
            <div
                style="padding: 1.5rem 2rem; border-top: 1px solid var(--glass-border); background: rgba(255,255,255,0.02); display: flex; justify-content: flex-end; gap: 1rem;">
                <div style="margin-right: auto; text-align: left;">
                    <p style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">Total Batch Net
                    </p>
                    <h4 id="batchNetTotal" style="font-size: 1.25rem; font-weight: 700;">₹ 0.00</h4>
                </div>
                <button class="btn btn-outline" onclick="closeRunPayroll()">Abort</button>
                <button class="btn btn-primary" onclick="finalizePayroll()">Finalize & Release</button>
            </div>
        </div>
    </div>

    <!-- Benefit Modal -->
    <div id="benefitModal" class="flex-center"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 4000; backdrop-filter: blur(8px);">
        <div class="glass-panel" style="width: 90%; max-width: 450px; padding: 2.5rem;">
            <h3 style="margin-bottom: 1.5rem;">Define Benefit Policy</h3>
            <form id="benefitForm" onsubmit="handleBenefitSubmit(event)">
                <div class="form-group">
                    <label class="form-label">Policy Name</label>
                    <input type="text" id="beneName" class="form-input" placeholder="e.g. Health Insurance" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Classification</label>
                    <select id="beneType" class="form-input">
                        <option value="Fixed">Fixed Amount</option>
                        <option value="Percentage">Percentage of Base</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Effect</label>
                    <select id="beneEffect" class="form-input">
                        <option value="Credit">Allowance (+)</option>
                        <option value="Debit">Deduction (-)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Value</label>
                    <input type="number" id="beneValue" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Create Policy</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, query, where, getDocs, doc, getDoc, setDoc, serverTimestamp, addDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const userData = JSON.parse(sessionStorage.getItem('orgUser'));
        if (!userData) window.location.href = 'index.html';

        window.logout = () => { sessionStorage.removeItem('orgUser'); window.location.href = 'index.html'; };

        let activeEmployees = [];
        let globalBenefits = [];

        function switchTab(tab) {
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            if (tab === 'disbursements') {
                document.getElementById('tabDisb').classList.add('active');
                document.getElementById('disbursementsPanel').style.display = 'block';
            } else {
                document.getElementById('tabBene').classList.add('active');
                document.getElementById('benefitsPanel').style.display = 'block';
            }
        }
        window.switchTab = switchTab;

        async function init() {
            console.log('Initializing Payroll. OrgID:', userData.orgId);
            document.getElementById('payrollMonth').value = new Date().toISOString().slice(0, 7);

            // Employees Listener
            onSnapshot(query(collection(db, "organizations", userData.orgId, "employees")),
                (snap) => {
                    activeEmployees = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    document.getElementById('statActivePayees').textContent = activeEmployees.length;
                },
                (error) => { console.error("Error watching employees:", error); document.getElementById('statActivePayees').textContent = 'Sys Error'; }
            );

            // Benefits Listener
            onSnapshot(collection(db, "organizations", userData.orgId, "benefits"),
                (snap) => {
                    globalBenefits = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderBenefits();
                },
                (error) => { console.error("Error watching benefits:", error); }
            );

            loadPayrollHistory();
        }

        function renderBenefits() {
            const list = document.getElementById('benefitsList');
            if (globalBenefits.length === 0) {
                list.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:3rem; opacity:0.5;">No active policies defined.</div>';
                return;
            }
            list.innerHTML = globalBenefits.map(b => `
                <div class="glass-panel" style="padding: 1.5rem; position:relative; border-left: 4px solid ${b.effect === 'Credit' ? 'var(--success-color)' : 'var(--error-color)'};">
                    <button onclick="deleteBenefit('${b.id}')" style="position:absolute; top:1rem; right:1rem; background:none; border:none; color:var(--text-muted); cursor:pointer;"><i class="fas fa-trash"></i></button>
                    <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:0.5rem;">${b.effect} • ${b.type}</div>
                    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem;">${b.name}</h3>
                    <div style="font-size: 1.5rem; font-weight: 800; color:white;">
                        ${b.type === 'Fixed' ? '₹' + b.value.toLocaleString() : b.value + '%'} 
                        <span style="font-size:0.8rem; font-weight:400; color:var(--text-muted);">/ mo</span>
                    </div>
                </div>
            `).join('');
        }

        window.openBenefitModal = () => document.getElementById('benefitModal').style.display = 'flex';
        window.handleBenefitSubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            try {
                const bData = {
                    name: document.getElementById('beneName').value,
                    type: document.getElementById('beneType').value,
                    value: parseFloat(document.getElementById('beneValue').value),
                    effect: document.getElementById('beneEffect').value,
                    createdAt: serverTimestamp()
                };
                await addDoc(collection(db, "organizations", userData.orgId, "benefits"), bData);
                document.getElementById('benefitModal').style.display = 'none';
                e.target.reset();
            } catch (err) { alert('Error: ' + err.message); }
            btn.disabled = false;
        };


        window.deleteBenefit = async (id) => { if (confirm('Retire this policy?')) await deleteDoc(doc(db, "organizations", userData.orgId, "benefits", id)); };

        window.loadPayrollHistory = async () => {
            const month = document.getElementById('payrollMonth').value;
            const tbody = document.getElementById('payrollHistory');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 5rem; opacity: 0.5;"><i class="fas fa-sync fa-spin"></i></td></tr>';

            try {
                const q = query(collection(db, "organizations", userData.orgId, "payroll"), where("month", "==", month));
                const snap = await getDocs(q);
                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 5rem; opacity: 0.5;">Empty archive for this period.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                let total = 0;
                snap.forEach(d => {
                    const p = d.data();
                    total += p.netSalary;
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid var(--glass-border)';
                    row.innerHTML = `
                        <td style="padding: 1.25rem;">
                            <div style="font-weight: 700;">${p.userName}</div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">${p.userId}</div>
                        </td>
                        <td style="padding: 1.25rem; font-size: 0.85rem;">
                            Base: ₹ ${p.baseSalary.toLocaleString()} | Adjust: ₹ ${p.adjustments.toLocaleString()} | LOP: ₹ ${p.lopDeduction.toLocaleString()}
                        </td>
                        <td style="padding: 1.25rem;"><div style="font-weight: 800; color: white;">₹ ${p.netSalary.toLocaleString()}</div></td>
                        <td style="padding: 1.25rem; text-align: right;"><span class="badge badge-success">FINALIZED</span></td>
                    `;
                    tbody.appendChild(row);
                });
                document.getElementById('statTotalPayout').textContent = `₹ ${total.toLocaleString()}`;
            } catch (error) {
                console.error("Payroll Access Error:", error);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 5rem; color: var(--error-color);">Secure access required. Contact Admin.</td></tr>';
            }
        };

        let currentBatchData = [];

        window.openRunPayroll = async () => {
            const modal = document.getElementById('runPayrollModal');
            const list = document.getElementById('runPayrollList');
            if (activeEmployees.length === 0) {
                list.innerHTML = '<tr><td colspan="7" class="text-center p-4">No active employees found to pay.</td></tr>';
                modal.style.display = 'flex';
                return;
            }

            // 1. Fetch Attendance for THIS MONTH for all users
            // Optimization: Fetch all attendance for org-month in one go if possible, or per user.
            // Current structure: collection 'attendance' -> doc -> fields.
            // We need to query attendance where orgId == userData.orgId AND date starts with month string
            // Actually, attendance is stored by YYYY-MM-DD.
            // Let's fetch all attendance for this org for this month range.
            const month = document.getElementById('payrollMonth').value; // YYYY-MM
            const [y, m] = month.split('-');
            const daysInMonth = new Date(y, m, 0).getDate();
            const startStr = `${month}-01`;
            const endStr = `${month}-${daysInMonth}`;

            // Fetch Organization Settings for Working Days
            let workingDays = [1, 2, 3, 4, 5]; // Default Mon-Fri
            try {
                const orgDoc = await getDoc(doc(db, "organizations", userData.orgId));
                if (orgDoc.exists() && orgDoc.data().workingDays) {
                    workingDays = orgDoc.data().workingDays;
                }
            } catch (e) { console.error("Settings Load Error", e); }

            list.innerHTML = '<div style="text-align:center; padding:5rem;"><i class="fas fa-sync fa-spin fa-2x"></i><br>Analyzing attendance & structures...</div>';
            modal.style.display = 'flex';

            const attQuery = query(
                collection(db, "organizations", userData.orgId, "attendance"),
                where("date", ">=", startStr),
                where("date", "<=", endStr)
            );

            const attSnap = await getDocs(attQuery);
            const attendanceMap = {}; // userId -> [records]
            attSnap.forEach(doc => {
                const d = doc.data();
                const uid = d.userId || d.email; // Ensure consistent key
                if (!attendanceMap[uid]) attendanceMap[uid] = [];
                attendanceMap[uid].push(d);
            });

            // 2. Calculate Payslips
            // We pass global benefits? We should fetch them too but they are in 'userData'? No, hidden. 
            // Assuming globalBenefits is loaded.
            currentBatchData = activeEmployees.map(emp => calculatePayslip(emp, attendanceMap[emp.email] || [], daysInMonth, month, workingDays));

            // 3. Render
            renderBatchResults(currentBatchData);
        };

        function calculatePayslip(emp, attendanceRecords, daysInMonth, monthStr, workingDaysConfig) {
            // Index attendance by date for easy lookup
            const attByDate = {};
            attendanceRecords.forEach(r => attByDate[r.date] = r);

            // A. Attendance Metrics - Day by Day Analysis
            let present = 0;
            let approvedLeaves = 0;
            let weeklyOffs = 0;
            let holidays = 0;
            let lopDays = 0;
            let halfDays = 0; // Track half days separately

            let late = 0;
            let overtimeHours = 0;

            const [year, month] = monthStr.split('-').map(Number);

            for (let d = 1; d <= daysInMonth; d++) {
                // Construct date string YYYY-MM-DD
                const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const dateObj = new Date(year, month - 1, d);
                const dayOfWeek = dateObj.getDay(); // 0=Sun, 1=Mon...

                const record = attByDate[dateStr];

                if (record) {
                    // Record Exists: Trust the status
                    const s = record.status || '';
                    const attendanceType = record.attendanceType || 'Full Day';

                    if (['Present', 'Completed', 'Comp Off'].includes(s)) {
                        // Check if it's a half day due to late arrival
                        if (attendanceType === 'Half Day' || record.isLate) {
                            halfDays++;
                            present += 0.5; // Half day credit
                        } else {
                            present++; // Full day credit
                        }
                    } else if (s === 'Holiday') {
                        holidays++;
                    } else if (['Leave Approved'].includes(s) || s.startsWith('Leave (Approved)')) {
                        approvedLeaves++;
                    } else {
                        // Absent/Unapproved or Pending -> Treated as LOP if working day? 
                        // If record says 'Absent' explicitly
                        lopDays++;
                    }

                    if (record.lateIn || record.earlyOut) late++;
                    if (record.overtime) overtimeHours += (parseFloat(record.overtime) || 0);

                } else {
                    // No Record: Check Policy
                    // Is it a Working Day?
                    if (workingDaysConfig.includes(dayOfWeek)) {
                        // Expected to work, but no record -> LOP (Absent)
                        lopDays++;
                    } else {
                        // Not a working day -> Weekly Off (Paid)
                        weeklyOffs++;
                    }
                }
            }

            // Total Paid Days = Present + ApprovedLeaves + Holidays + WeeklyOffs
            // (Assuming ApprovedLeaves are Paid Leaves like CL/PL)
            // LOP is strictly the count of working days missed without approval.
            const paidDays = present + approvedLeaves + holidays + weeklyOffs;

            // Adjust LOP if total > daysInMonth (sanity check)
            // Should be exactly daysInMonth = paidDays + lopDays?
            // Yes, iterating 1..N ensures (paid + lop) == daysInMonth.

            const absentDays = lopDays; // "Absent" in summary usually implies unpaid absence

            // B. Financial Structure
            const s = emp.salaryStructure || { base: parseFloat(emp.salary) || 0, allowances: [], deductions: [] };
            const baseSalary = parseFloat(s.base) || 0;

            // Earnings
            let fixedEarnings = [];
            // Basic -> Prorated based on Paid Days
            // Formula: (MonthlyRate / DaysInMonth) * PaidDays
            // const basicAmount = (baseSalary / daysInMonth) * paidDays;
            // fixedEarnings.push({ name: 'Basic Salary', amount: basicAmount });

            // if(s.allowances) {
            //     s.allowances.forEach(a => {
            //         const val = parseFloat(a.amount)||0;
            //         fixedEarnings.push({ name: a.name, amount: (val / daysInMonth) * paidDays });
            //     });
            // }

            // globalBenefits.filter(b => b.effect === 'Credit').forEach(b => {
            //      let val = parseFloat(b.value) || 0;
            //      if(b.type === 'Percentage') val = (baseSalary * val) / 100;
            //      // Benefits also usually prorated? Or fixed? Assuming prorated as they are monthly.
            //      fixedEarnings.push({ name: b.name, amount: (val / daysInMonth) * paidDays });
            // });

            // Variable Earnings (OT)
            let variableEarnings = [];
            if (overtimeHours > 0) {
                const hourlyRate = (baseSalary / 30) / 9;
                variableEarnings.push({ name: 'Overtime Pay', amount: hourlyRate * overtimeHours });
            }

            // Deductions
            let deductions = [];

            // LOP Deduction
            // Ideally: We just pay 'basicAmount' which is already reduced.
            // BUT, payslips often show "Annual/Monthly Basic" and then "LOP Deduction".
            // If we want to show "LOP Deduction", we must start with FULL Basic in the Earnings list.
            // Let's stick to the method: Show FULL Earnings, then Deduct LOP.
            // This is clearer for the employee ("Why is my basic less? Oh, LOP deduction").

            // Recalculate Fixed Earnings as FULL MONTHLY
            fixedEarnings = [];
            fixedEarnings.push({ name: 'Basic Salary', amount: baseSalary });
            if (s.allowances) s.allowances.forEach(a => fixedEarnings.push({ name: a.name, amount: parseFloat(a.amount) || 0 }));
            globalBenefits.filter(b => b.effect === 'Credit').forEach(b => {
                let val = parseFloat(b.value) || 0;
                if (b.type === 'Percentage') val = (baseSalary * val) / 100;
                fixedEarnings.push({ name: b.name, amount: val });
            });

            // Calculate LOP Value
            const grossMonthly = fixedEarnings.reduce((sum, i) => sum + i.amount, 0);
            const perDay = grossMonthly / daysInMonth;
            const lopValue = lopDays * perDay;

            if (lopDays > 0) {
                deductions.push({ name: 'Loss of Pay', amount: lopValue });
            }

            // Fixed Deductions
            if (s.deductions) s.deductions.forEach(d => deductions.push({ name: d.name, amount: parseFloat(d.amount) || 0 }));

            globalBenefits.filter(b => b.effect === 'Debit').forEach(b => {
                let val = parseFloat(b.value) || 0;
                if (b.type === 'Percentage') val = (baseSalary * val) / 100;
                deductions.push({ name: b.name, amount: val });
            });

            // D. Totals
            const gross = fixedEarnings.concat(variableEarnings).reduce((acc, i) => acc + i.amount, 0);
            const totalDed = deductions.reduce((acc, i) => acc + i.amount, 0);
            const net = gross - totalDed;

            return {
                empId: emp.id,
                details: {
                    name: `${emp.firstName} ${emp.lastName}`,
                    email: emp.email,
                    pan: emp.pan || 'N/A',
                    uan: emp.uan || 'N/A',
                    esi: emp.esi || 'N/A',
                    accountNumber: emp.accountNumber || '****',
                    designation: emp.designation,
                    department: emp.department,
                    joiningDate: emp.joiningDate
                },
                attendance: {
                    daysInMonth,
                    paidDays,
                    lopDays,
                    absentDays,
                    approvedLeaves,
                    weeklyOffs, // Included for reference
                    halfDays, // Late arrival half days
                    overtimeHours,
                    late
                },
                earnings: { fixed: fixedEarnings, variable: variableEarnings },
                deductions,
                totals: { gross, totalDeductions: totalDed, net }
            };
        }

        function renderBatchResults(data) {
            const list = document.getElementById('runPayrollList');
            list.innerHTML = `
                <table style="width:100%; border-collapse: collapse;">
                    <thead><tr style="text-align:left; opacity:0.6; font-size:0.8rem; border-bottom:1px solid var(--glass-border);">
                        <th style="padding:1rem;">EMPLOYEE</th>
                        <th style="padding:1rem;">ATTENDANCE</th>
                        <th style="padding:1rem;">GROSS</th>
                        <th style="padding:1rem;">DEDUCTIONS</th>
                        <th style="padding:1rem;">NET PAY</th>
                        <th style="padding:1rem;">ADJUSTMENT</th>
                    </tr></thead>
                    <tbody>${data.map((d, i) => `
                        <tr style="border-bottom: 1px solid var(--glass-border);">
                            <td style="padding:1.25rem;">
                                <div style="font-weight:600;">${d.details.name}</div>
                                <div style="font-size:0.75rem; opacity:0.7;">${d.details.designation}</div>
                            </td>
                            <td style="padding:1.25rem;">
                                <div style="font-size:0.9rem;">${d.attendance.paidDays.toFixed(1)} / ${d.attendance.daysInMonth}</div>
                                <div style="font-size:0.75rem; color:var(--error-color);">LOP: ${d.attendance.lopDays.toFixed(1)}</div>
                                ${d.attendance.halfDays > 0 ? `<div style="font-size:0.75rem; color:var(--warning-color);">Half Days: ${d.attendance.halfDays}</div>` : ''}
                            </td>
                            <td style="padding:1.25rem;">₹ ${d.totals.gross.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                            <td style="padding:1.25rem; color:var(--error-color);">- ₹ ${d.totals.totalDeductions.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                            <td style="padding:1.25rem; font-weight:800; font-size:1.1rem;" id="net-disp-${i}">₹ ${d.totals.net.toLocaleString(undefined, { maximumFractionDigits: 0 })}</td>
                            <td style="padding:1.25rem;">
                                <input type="number" class="form-input" style="width:100px; height:30px;" placeholder="Adjust" onchange="updateAdjustment(${i}, this.value)">
                            </td>
                        </tr>`).join('')}</tbody>
                </table>`;
            recalculateBatchTotalUI();
        }

        window.updateAdjustment = (index, val) => {
            currentBatchData[index].adjustment = parseFloat(val) || 0;
            const finalNet = currentBatchData[index].totals.net + currentBatchData[index].adjustment;
            document.getElementById(`net-disp-${index}`).textContent = `₹ ${finalNet.toLocaleString(undefined, { maximumFractionDigits: 0 })}`;
            recalculateBatchTotalUI();
        };

        function recalculateBatchTotalUI() {
            const total = currentBatchData.reduce((acc, d) => acc + d.totals.net + (d.adjustment || 0), 0);
            document.getElementById('batchNetTotal').textContent = `₹ ${total.toLocaleString()}`;
        }

        window.closeRunPayroll = () => document.getElementById('runPayrollModal').style.display = 'none';

        window.finalizePayroll = async () => {
            if (!confirm('AUTHORIZE PROTOCOL: Finalize disbursement batch?')) return;
            const month = document.getElementById('payrollMonth').value;
            const btn = document.querySelector('button[onclick="finalizePayroll()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            try {
                // Batch write would be better, but loop is fine for < 500 docs
                for (const item of currentBatchData) {
                    const adj = item.adjustment || 0;
                    const finalNet = item.totals.net + adj;

                    // Inject adjustment into structure for visibility in Detailed Payslip
                    if (adj !== 0) {
                        if (adj > 0) {
                            item.earnings.fixed.push({ name: 'Manual Adjustment', amount: adj });
                            item.totals.gross += adj;
                        } else {
                            item.deductions.push({ name: 'Manual Adjustment', amount: Math.abs(adj) });
                            item.totals.totalDeductions += Math.abs(adj);
                        }
                        item.totals.net = finalNet;
                    }

                    // Create rich document
                    const payDoc = {
                        month,
                        userId: item.details.email, // Key reference
                        userName: item.details.name,
                        releasedAt: serverTimestamp(),
                        status: 'Released',

                        // Core Financials for querying
                        netSalary: finalNet,
                        baseSalary: item.earnings.fixed.find(f => f.name.includes('Basic'))?.amount || 0,
                        lopDeduction: item.deductions.find(d => d.name.includes('Loss of Pay'))?.amount || 0,
                        adjustments: adj,

                        // RICH DATA (The full object)
                        fullDetails: item // Store everything!
                    };

                    await addDoc(collection(db, "organizations", userData.orgId, "payroll"), payDoc);
                }
                alert('Success: Payroll released.');
                closeRunPayroll();
                loadPayrollHistory();
            } catch (e) {
                alert('Error: ' + e.message);
                console.error(e);
            } finally {
                btn.innerHTML = 'Finalize & Release';
                btn.disabled = false;
            }
        };

        init();
    </script>
</body>

</html>