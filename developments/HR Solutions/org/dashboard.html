<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Dashboard - Gridify</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="portal-layout">
        <aside class="sidebar" id="sidebar">
            <div style="margin-bottom: 2.5rem; text-align: left; padding: 0.5rem;">
                <div class="logo" style="margin-bottom: 0.25rem;">Gridify</div>
                <p
                    style="font-size: 0.75rem; color: var(--text-muted); font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">
                    Organization Console</p>
            </div>

            <nav>
                <a href="dashboard.html" class="nav-item active">
                    <i class="fas fa-th-large"></i> Overview
                </a>
                <a href="employees.html" class="nav-item">
                    <i class="fas fa-users"></i> Employees
                </a>
                <a href="departments.html" class="nav-item">
                    <i class="fas fa-layer-group"></i> Departments
                </a>
                <a href="approvals.html" class="nav-item">
                    <i class="fas fa-inbox"></i> Approval Hub
                </a>
                <a href="attendance.html" class="nav-item">
                    <i class="fas fa-calendar-check"></i> Attendance
                </a>
                <a href="leave-requests.html" class="nav-item">
                    <i class="fas fa-envelope-open-text"></i> Leave Requests
                </a>
                <a href="payroll.html" class="nav-item">
                    <i class="fas fa-file-invoice-dollar"></i> Payroll
                </a>
                <a href="settings.html" class="nav-item">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </nav>

            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
                <div class="nav-item" style="cursor: pointer; color: var(--error-color);" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </div>
            </div>
        </aside>
        <div class="sidebar-overlay" onclick="document.getElementById('sidebar').classList.remove('active')"></div>

        <main class="main-content">
            <header
                style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2.5rem;">
                <div>
                    <h1 style="font-size: 2rem; margin-bottom: 0.25rem;">Admin Dashboard</h1>
                    <p style="color: var(--text-secondary);">Command center for <span id="orgNameSpan"
                            style="color: var(--primary-color); font-weight: 600;">...</span></p>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <div class="glass-panel"
                        style="padding: 0.75rem 1.25rem; display: flex; align-items: center; gap: 0.75rem;">
                        <div class="pulse"
                            style="width: 8px; height: 8px; border-radius: 50%; background: var(--success-color);">
                        </div>
                        <span style="font-weight: 600; font-size: 0.85rem; letter-spacing: 0.02em;">SYSTEM ONLINE</span>
                    </div>
                    <div class="mobile-nav-toggle"
                        onclick="document.getElementById('sidebar').classList.toggle('active')">
                        <i class="fas fa-bars"></i>
                    </div>
                </div>
            </header>

            <div class="card-grid">
                <!-- Workforce Status -->
                <div class="glass-panel stat-card"
                    style="background: linear-gradient(135deg, var(--surface-color), rgba(99, 102, 241, 0.05)); border-left: 4px solid var(--primary-color);">
                    <div class="stat-label">Active Workforce</div>
                    <div id="totalEmpCount" class="stat-value">0</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                        <span class="badge badge-success">Live Tracking</span>
                    </div>
                </div>

                <!-- Approvals Widget -->
                <div id="pendingLeavesCard" class="glass-panel stat-card" onclick="location.href='approvals.html'"
                    style="cursor: pointer; transition: var(--transition);">
                    <div class="stat-label">Pending Reviews</div>
                    <div id="pendingLeavesCount" class="stat-value">0</div>
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Leave requests
                        awaiting action</div>
                </div>

                <!-- Next Sync -->
                <div class="glass-panel stat-card">
                    <div class="stat-label">Next Payroll Cycle</div>
                    <div id="nextPayroll" class="stat-value" style="font-size: 1.5rem; margin-top: 0.5rem;">Feb 01, 2026
                    </div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Automated processing</div>
                </div>
            </div>

            <div class="stack-on-mobile"
                style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 2.5rem; margin-top: 2.5rem;">
                <!-- Main Operations -->
                <div>
                    <h3 style="margin-bottom: 1.5rem;">Critical Operations</h3>
                    <div class="quick-action-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                        <div class="quick-action-btn" onclick="location.href='employees.html'">
                            <i class="fas fa-user-plus"></i>
                            <span>Onboard Staff</span>
                        </div>
                        <div class="quick-action-btn" onclick="location.href='attendance.html'">
                            <i class="fas fa-clipboard-check"></i>
                            <span>Audit Logs</span>
                        </div>
                        <div class="quick-action-btn" onclick="location.href='payroll.html'">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Disburse Salary</span>
                        </div>
                        <div class="quick-action-btn" onclick="location.href='settings.html'">
                            <i class="fas fa-sliders-h"></i>
                            <span>Org Rules</span>
                        </div>
                        <div class="quick-action-btn" onclick="location.href='departments.html'">
                            <i class="fas fa-layer-group"></i>
                            <span>Departments</span>
                        </div>
                    </div>
                </div>

                <!-- Live Health -->
                <div>
                    <h3 style="margin-bottom: 1.5rem;">Deployment Status</h3>
                    <div class="glass-panel" style="padding: 1.5rem;">
                        <div style="display: flex; flex-direction: column; gap: 1.25rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.9rem; color: var(--text-secondary);">Database Sync</span>
                                <span class="badge badge-success">Optimized</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.9rem; color: var(--text-secondary);">Security Layer</span>
                                <span class="badge badge-info">AES-256</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.9rem; color: var(--text-secondary);">Tenant Isolation</span>
                                <span class="badge badge-success">Strict</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const userData = JSON.parse(sessionStorage.getItem('orgUser'));
        if (!userData) window.location.href = 'index.html';

        document.getElementById('orgNameSpan').textContent = userData.orgName || 'Organization';

        window.logout = () => { sessionStorage.removeItem('orgUser'); window.location.href = 'index.html'; };

        function initDashboard() {
            // workforce stats
            onSnapshot(query(collection(db, "organizations", userData.orgId, "employees")), (snap) => {
                document.getElementById('totalEmpCount').textContent = snap.size;
            });

            // approvals stats - Client-side Filtering to avoid index issues
            let pendingL = 0, pendingA = 0, pendingE = 0;
            const updateCount = () => {
                const count = pendingL + pendingA + pendingE;
                document.getElementById('pendingLeavesCount').textContent = count;
                const card = document.getElementById('pendingLeavesCard');
                card.style.borderColor = count > 0 ? 'var(--warning-color)' : 'var(--glass-border)';
                if (count > 0) card.classList.add('pulse-soft'); else card.classList.remove('pulse-soft');
            };

            onSnapshot(collection(db, "organizations", userData.orgId, "leave_requests"), (snap) => {
                pendingL = snap.docs.filter(d => d.data().status === 'Pending').length;
                updateCount();
            });

            onSnapshot(collection(db, "organizations", userData.orgId, "attendance_requests"), (snap) => {
                pendingA = snap.docs.filter(d => d.data().status === 'Pending').length;
                updateCount();
            });

            onSnapshot(collection(db, "organizations", userData.orgId, "employee_updates"), (snap) => {
                pendingE = snap.docs.filter(d => d.data().status === 'Pending').length;
                updateCount();
            });
        }
        initDashboard();
    </script>
</body>

</html>