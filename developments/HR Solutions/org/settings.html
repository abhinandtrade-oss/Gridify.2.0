<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Gridify Organization</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="portal-layout">
        <aside class="sidebar" id="sidebar">
            <div style="margin-bottom: 2.5rem; text-align: left; padding: 0.5rem;">
                <div class="logo" style="margin-bottom: 0.25rem;">Gridify</div>
                <p
                    style="font-size: 0.75rem; color: var(--text-muted); font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase;">
                    Organization Console</p>
            </div>

            <nav>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-th-large"></i> Overview
                </a>
                <a href="employees.html" class="nav-item">
                    <i class="fas fa-users"></i> Employees
                </a>
                <a href="departments.html" class="nav-item">
                    <i class="fas fa-layer-group"></i> Departments
                </a>
                <a href="approvals.html" class="nav-item">
                    <i class="fas fa-inbox"></i> Approval Hub
                </a>
                <a href="attendance.html" class="nav-item">
                    <i class="fas fa-calendar-check"></i> Attendance
                </a>
                <a href="leave-requests.html" class="nav-item">
                    <i class="fas fa-envelope-open-text"></i> Leave Requests
                </a>
                <a href="payroll.html" class="nav-item">
                    <i class="fas fa-file-invoice-dollar"></i> Payroll
                </a>
                <a href="settings.html" class="nav-item active">
                    <i class="fas fa-cog"></i> Settings
                </a>
            </nav>

            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
                <div class="nav-item" style="cursor: pointer; color: var(--error-color);" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </div>
            </div>
        </aside>
        <div class="sidebar-overlay" onclick="document.getElementById('sidebar').classList.remove('active')"></div>

        <main class="main-content">
            <header
                style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2.5rem;">
                <div>
                    <h1 style="font-size: 2rem; margin-bottom: 0.25rem;">Terminal Settings</h1>
                    <p style="color: var(--text-secondary);">Configure core protocols and secure your access.</p>
                </div>
                <div class="mobile-nav-toggle" onclick="document.getElementById('sidebar').classList.toggle('active')">
                    <i class="fas fa-bars"></i>
                </div>
            </header>

            <div class="stack-on-mobile"
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">
                <!-- Identity Panel -->
                <div class="glass-panel" style="padding: 2rem; border: 1px solid var(--glass-border);">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div
                            style="width: 48px; height: 48px; background: rgba(99, 102, 241, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary-color);">
                            <i class="fas fa-building fa-lg"></i>
                        </div>
                        <h3 style="font-size: 1.25rem; font-weight: 700;">Entity identity</h3>
                    </div>
                    <form onsubmit="handleIdentityUpdate(event)">
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="form-label"
                                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Authorized
                                Name</label>
                            <input type="text" class="form-input" id="orgNameDisp" required
                                style="background: rgba(255,255,255,0.05); border-color: var(--glass-border);">
                        </div>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="form-label"
                                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Physical
                                Address</label>
                            <textarea class="form-input" id="orgAddressDisp" rows="3" required
                                style="background: rgba(255,255,255,0.05); border-color: var(--glass-border); resize:none;"></textarea>
                        </div>
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="form-label"
                                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Logo
                                URL</label>
                            <input type="url" class="form-input" id="orgLogoDisp"
                                placeholder="https://example.com/logo.png"
                                style="background: rgba(255,255,255,0.05); border-color: var(--glass-border);">
                        </div>

                        <!-- Work Week Config -->
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="form-label"
                                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Operable
                                Days (Paid)</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <label class="checkbox-btn"><input type="checkbox" name="workday" value="1">
                                    <span>Mon</span></label>
                                <label class="checkbox-btn"><input type="checkbox" name="workday" value="2">
                                    <span>Tue</span></label>
                                <label class="checkbox-btn"><input type="checkbox" name="workday" value="3">
                                    <span>Wed</span></label>
                                <label class="checkbox-btn"><input type="checkbox" name="workday" value="4">
                                    <span>Thu</span></label>
                                <label class="checkbox-btn"><input type="checkbox" name="workday" value="5">
                                    <span>Fri</span></label>
                                <label class="checkbox-btn"><input type="checkbox" name="workday" value="6">
                                    <span>Sat</span></label>
                                <label class="checkbox-btn"><input type="checkbox" name="workday" value="0">
                                    <span>Sun</span></label>
                            </div>
                        </div>
                        <style>
                            .checkbox-btn input {
                                display: none;
                            }

                            .checkbox-btn span {
                                display: inline-block;
                                padding: 0.5rem 0.75rem;
                                border: 1px solid var(--glass-border);
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 0.8rem;
                                transition: all 0.2s;
                                color: var(--text-muted);
                            }

                            .checkbox-btn input:checked+span {
                                background: var(--primary-color);
                                border-color: var(--primary-color);
                                color: white;
                            }
                        </style>

                        <button type="submit" id="updateIdBtn" class="btn btn-outline" style="width: 100%;">
                            Update Identity
                        </button>
                    </form>
                </div>

                <!-- Security Panel -->
                <div class="glass-panel" style="padding: 2rem; border: 1px solid var(--glass-border);">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                        <div
                            style="width: 48px; height: 48px; background: rgba(236, 72, 153, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--secondary-color);">
                            <i class="fas fa-shield-alt fa-lg"></i>
                        </div>
                        <h3 style="font-size: 1.25rem; font-weight: 700;">Access Security</h3>
                    </div>
                    <form onsubmit="handlePasswordChange(event)">
                        <div class="form-group" style="margin-bottom: 1.25rem;">
                            <label class="form-label">Current Access Key</label>
                            <input type="password" id="currentPassword" class="form-input" required
                                placeholder="••••••••">
                        </div>
                        <div class="stack-on-mobile"
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label class="form-label">New Key</label>
                                <input type="password" id="newPassword" class="form-input" required
                                    placeholder="New Secret">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Verify Key</label>
                                <input type="password" id="confirmPassword" class="form-input" required
                                    placeholder="Repeat Secret">
                            </div>
                        </div>
                        <button type="submit" id="changePassBtn" class="btn btn-primary" style="width: 100%;">
                            <i class="fas fa-key" style="margin-right: 0.6rem;"></i> Rotate Access Keys
                        </button>
                    </form>
                </div>
            </div>

            <!-- Work Time & Attendance Rules Panel -->
            <div class="glass-panel"
                style="padding: 2rem; border: 1px solid var(--glass-border); grid-column: 1/-1; margin-top: 2rem;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;">
                    <div
                        style="width: 48px; height: 48px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--success-color);">
                        <i class="fas fa-clock fa-lg"></i>
                    </div>
                    <h3 style="font-size: 1.25rem; font-weight: 700;">Work Time & Attendance Rules</h3>
                </div>
                <form onsubmit="handleWorkTimeUpdate(event)">
                    <div class="stack-on-mobile"
                        style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label class="form-label"
                                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Official
                                Work Start Time</label>
                            <input type="time" id="workStartTime" class="form-input" required
                                style="background: rgba(255,255,255,0.05); border-color: var(--glass-border);">
                        </div>
                        <div class="form-group">
                            <label class="form-label"
                                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Official
                                Work End Time</label>
                            <input type="time" id="workEndTime" class="form-input" required
                                style="background: rgba(255,255,255,0.05); border-color: var(--glass-border);">
                        </div>
                        <div class="form-group">
                            <label class="form-label"
                                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;">Grace
                                Period (Minutes)</label>
                            <input type="number" id="gracePeriod" class="form-input" min="0" max="60" value="15"
                                required style="background: rgba(255,255,255,0.05); border-color: var(--glass-border);">
                        </div>
                    </div>

                    <div
                        style="background: rgba(14, 165, 233, 0.05); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(14, 165, 233, 0.1); margin-bottom: 1.5rem;">
                        <p style="font-size: 0.85rem; color: var(--info-color); line-height: 1.6; margin: 0;">
                            <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                            <strong>Attendance Behavior:</strong> Employees punching in on or before <strong>Start Time
                                + Grace Period</strong> will be marked as <strong>Present (Full Day)</strong>.
                            Late arrivals will be marked as <strong>Late - Half Day</strong> with automatic 50% salary
                            deduction for that day.
                        </p>
                    </div>

                    <div
                        style="background: rgba(245, 158, 11, 0.05); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.1); margin-bottom: 1.5rem;">
                        <p style="font-size: 0.85rem; color: var(--warning-color); line-height: 1.6; margin: 0;">
                            <i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem;"></i>
                            <strong>Important:</strong> Changes to this policy apply only from the effective date
                            forward. Past attendance records will not be recalculated.
                        </p>
                    </div>

                    <button type="submit" id="updateWorkTimeBtn" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-save" style="margin-right: 0.6rem;"></i> Save Attendance Rules
                    </button>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        import { db } from '../js/firebase-config.js';
        import { collection, query, where, getDocs, updateDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const userData = JSON.parse(sessionStorage.getItem('orgUser'));
        if (!userData) window.location.href = 'index.html';

        window.logout = () => { sessionStorage.removeItem('orgUser'); window.location.href = 'index.html'; };

        async function loadSettings() {
            if (userData) {
                document.getElementById('orgNameDisp').value = userData.orgName || '';
                // document.getElementById('adminEmailDisp').value = userData.email; // Removed from HTML

                try {
                    if (userData.orgId) {
                        const orgDoc = await getDoc(doc(db, "organizations", userData.orgId));
                        if (orgDoc.exists()) {
                            const od = orgDoc.data();
                            document.getElementById('orgNameDisp').value = od.name || userData.orgName || '';
                            document.getElementById('orgAddressDisp').value = od.address || '';
                            document.getElementById('orgLogoDisp').value = od.logoUrl || '';

                            // Load Working Days
                            const days = od.workingDays || [1, 2, 3, 4, 5]; // Default Mon-Fri
                            document.querySelectorAll('input[name="workday"]').forEach(cb => {
                                cb.checked = days.includes(parseInt(cb.value));
                            });

                            // Load Work Time Configuration
                            document.getElementById('workStartTime').value = od.workStartTime || '09:00';
                            document.getElementById('workEndTime').value = od.workEndTime || '18:00';
                            document.getElementById('gracePeriod').value = od.gracePeriod || 15;
                        }
                    }
                } catch (e) { console.error(e); }
            }
        }

        window.handleIdentityUpdate = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('updateIdBtn');
            const newName = document.getElementById('orgNameDisp').value;
            const newAddr = document.getElementById('orgAddressDisp').value;
            const newLogo = document.getElementById('orgLogoDisp').value;

            // Get selected days
            const workingDays = [];
            document.querySelectorAll('input[name="workday"]:checked').forEach(cb => {
                workingDays.push(parseInt(cb.value));
            });

            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Writing...';
            btn.disabled = true;

            try {
                if (userData.orgId) {
                    await setDoc(doc(db, "organizations", userData.orgId), {
                        name: newName,
                        address: newAddr,
                        logoUrl: newLogo,
                        workingDays: workingDays
                    }, { merge: true });

                    // Update session partially
                    userData.orgName = newName;
                    sessionStorage.setItem('orgUser', JSON.stringify(userData));

                    alert("Entity identity & policies updated.");
                }
            } catch (e) {
                alert("Update failed: " + e.message);
            } finally {
                btn.innerHTML = 'Update Identity';
                btn.disabled = false;
            }
        }

        loadSettings();

        window.handleWorkTimeUpdate = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('updateWorkTimeBtn');
            const workStartTime = document.getElementById('workStartTime').value;
            const workEndTime = document.getElementById('workEndTime').value;
            const gracePeriod = parseInt(document.getElementById('gracePeriod').value);

            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Saving...';
            btn.disabled = true;

            try {
                if (userData.orgId) {
                    await setDoc(doc(db, "organizations", userData.orgId), {
                        workStartTime: workStartTime,
                        workEndTime: workEndTime,
                        gracePeriod: gracePeriod,
                        attendanceRuleEffectiveDate: new Date().toISOString().split('T')[0]
                    }, { merge: true });

                    alert("Work time & attendance rules updated successfully!");
                }
            } catch (e) {
                alert("Update failed: " + e.message);
            } finally {
                btn.innerHTML = '<i class="fas fa-save"></i> Save Attendance Rules';
                btn.disabled = false;
            }
        };

        window.handlePasswordChange = async function (e) {
            e.preventDefault();
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            const btn = document.getElementById('changePassBtn');

            if (newPass !== confirmPass) { alert("Access keys do not match!"); return; }

            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Authorizing...';
            btn.disabled = true;

            try {
                const q = query(collection(db, "org_admins"), where("email", "==", userData.email));
                const snapshot = await getDocs(q);

                if (snapshot.empty) throw new Error("Protocol break: Record not found.");

                const userDoc = snapshot.docs[0];
                const data = userDoc.data();

                if (data.password !== currentPass) { alert("Invalid current access key."); return; }

                await updateDoc(doc(db, "org_admins", userDoc.id), { password: newPass });
                alert("Access sequence updated successfully!");
                e.target.reset();
            } catch (error) {
                alert("Authorization failure: " + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>

</html>