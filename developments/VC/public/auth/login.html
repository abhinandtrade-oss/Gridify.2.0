<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Gridify Video Conf</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="portal-toast-container" id="toastContainer"></div>
    <div class="container auth-container">
        <div class="glass-panel">
            <div class="auth-header">
                <h1>Welcome Back</h1>
                <p>Sign in to continue to your dashboard</p>
            </div>

            <form id="loginForm">
                <div class="input-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" class="form-control" placeholder="name@example.com" required>
                </div>

                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="••••••••" required>
                    <div style="text-align: right; margin-top: 0.5rem;">
                        <a href="#" id="forgotPasswordBtn"
                            style="font-size: 0.8rem; color: var(--text-muted); text-decoration: none;">Forgot
                            Password?</a>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>

            <div
                style="margin: 1.5rem 0; display: flex; align-items: center; gap: 1rem; color: var(--text-muted); font-size: 0.8rem;">
                <div style="flex: 1; height: 1px; background: var(--border);"></div>
                <span>OR</span>
                <div style="flex: 1; height: 1px; background: var(--border);"></div>
            </div>

            <button id="googleLoginBtn" class="btn btn-google" style="width: 100%; margin-bottom: 0.8rem;">
                <i class="fab fa-google"></i> Continue with Google
            </button>

            <button id="guestLoginBtn" class="btn btn-secondary" style="width: 100%">
                <i class="fas fa-user-secret"></i> Continue as Guest
            </button>

            <div style="margin-top: 1.5rem; text-align: center; font-size: 0.9rem;">
                <p class="text-muted">Don't have an account? <a href="register.html">Register here</a></p>
            </div>
        </div>
    </div>

    <footer>
        <p>Powered by <a href="https://www.gridify.in" target="_blank">GRIDIFY</a></p>
    </footer>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="forgotPasswordModal" style="display: none;">
        <div class="glass-panel" style="width: 90%; max-width: 400px; animation: slideUp 0.3s ease;">
            <div style="margin-bottom: 1.5rem;">
                <h3 style="margin-bottom: 0.5rem;">Reset Password</h3>
                <p class="text-muted" style="font-size: 0.9rem;">Enter your email address to receive a password reset
                    link.</p>
            </div>

            <div class="input-group">
                <label for="resetEmail">Email Address</label>
                <input type="email" id="resetEmail" class="form-control" placeholder="name@example.com">
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 1rem;">
                <button class="btn btn-secondary" id="cancelResetBtn">Cancel</button>
                <button class="btn btn-primary" id="confirmResetBtn">Send Link</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { loginUser, continueAsGuest, loginWithGoogle, subscribeToPublicConfig, sendPasswordReset } from '../assets/js/auth.js';

        // Toast Helper
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `portal-toast ${type}`;

            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';

            toast.innerHTML = `<i class="fas fa-${icon}"></i> <span>${message}</span>`;

            container.appendChild(toast);

            // Remove after 4s
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        };

        // Forgot Password Logic
        const forgotBtn = document.getElementById('forgotPasswordBtn');
        const modal = document.getElementById('forgotPasswordModal');
        const cancelBtn = document.getElementById('cancelResetBtn');
        const confirmBtn = document.getElementById('confirmResetBtn');
        const resetEmailInput = document.getElementById('resetEmail');

        if (forgotBtn && modal) {
            // Open Modal
            forgotBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // Pre-fill email if user typed it in main form
                const mainEmail = document.getElementById('email').value;
                if (mainEmail) resetEmailInput.value = mainEmail;

                modal.style.display = 'flex';
                resetEmailInput.focus();
            });

            // Close Modal
            const closeModal = () => {
                modal.style.display = 'none';
                resetEmailInput.value = ''; // Clear or keep? Better to clear or reset to main email next time
            };

            cancelBtn.addEventListener('click', closeModal);

            // Close on click outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal();
            });

            // Confirm Reset
            confirmBtn.addEventListener('click', async () => {
                const email = resetEmailInput.value.trim();
                if (!email) {
                    // Show a tiny error or just focus?
                    // Let's use a temporary border red
                    resetEmailInput.style.borderColor = 'var(--accent-red)';
                    setTimeout(() => resetEmailInput.style.borderColor = '', 2000);
                    return;
                }

                try {
                    confirmBtn.disabled = true;
                    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

                    const msg = await sendPasswordReset(email);

                    // Show success toast
                    showToast(msg, 'success');

                    confirmBtn.innerHTML = '<i class="fas fa-check"></i> Sent!';
                    confirmBtn.style.background = 'var(--accent-green)';

                    setTimeout(() => {
                        closeModal();
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = 'Send Link';
                        confirmBtn.style.background = ''; // Reset to default
                    }, 1500);

                } catch (error) {
                    console.error(error);
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Retry';
                    showToast(error.message, 'error');
                }
            });
        }

        // Load Config and Apply UI Logic Real-time
        window.addEventListener('DOMContentLoaded', () => {
            subscribeToPublicConfig((config) => {
                if (config) {
                    const guestBtn = document.getElementById('guestLoginBtn');
                    if (guestBtn) {
                        guestBtn.style.display = config.guestAccess !== false ? 'block' : 'none';
                    }

                    const googleBtn = document.getElementById('googleLoginBtn');
                    if (googleBtn) {
                        googleBtn.style.display = config.googleAuthEnabled !== false ? 'block' : 'none';
                    }

                    const regLink = document.querySelector('a[href="register.html"]');
                    if (regLink) {
                        const container = regLink.closest('p');
                        if (container) {
                            container.style.display = config.registrationEnabled !== false ? 'block' : 'none';
                        }
                    }
                }
            });
        });

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const btn = e.target.querySelector('button');

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                await loginUser(email, password);
            } catch (error) {
                showToast(error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
            }
        });

        document.getElementById('googleLoginBtn').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
                await loginWithGoogle();
            } catch (error) {
                showToast(error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fab fa-google"></i> Continue with Google';
            }
        });

        document.getElementById('guestLoginBtn').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Entering...';
                await continueAsGuest();
            } catch (error) {
                showToast(error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-user-secret"></i> Continue as Guest';
            }
        });
    </script>
</body>

</html>