<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Management | House of Pachu Admin</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="../assets/vendor/bootstrap/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Admin CSS -->
    <link rel="stylesheet" href="css/admin.css">
    <style>
        .storage-card {
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .usage-stats {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .usage-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(#f72c5b var(--percentage, 0%), #f1f5f9 0);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .usage-circle::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 50%;
        }

        .usage-circle span {
            position: relative;
            z-index: 1;
            font-weight: 700;
            font-size: 1.25rem;
            color: #1e293b;
        }

        .usage-details h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: #1e293b;
        }

        .usage-details p {
            color: #64748b;
            margin: 0;
        }

        .table-responsive {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .file-list-table th {
            background: #f8fafc;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
            color: #64748b;
            padding: 1rem;
        }

        .file-list-table td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #f1f5f9;
        }

        .file-preview {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            object-fit: cover;
            background: #f1f5f9;
        }

        .badge-storage {
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 600;
            border-radius: 6px;
        }

        .limit-alert {
            display: none;
            margin-bottom: 1.5rem;
        }
    </style>

    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide/dist/umd/lucide.min.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supabase-config.js"></script>
    <script src="js/auth-check.js"></script>
</head>

<body>

    <button class="sidebar-toggle">
        <i data-lucide="menu"></i>
    </button>

    <div class="sidebar-overlay"></div>

    <main class="admin-main">
        <header class="page-header">
            <div class="page-title">
                <h1>Storage Management</h1>
                <p>Monitor Cloudflare R2 usage, manage files, and set storage limits.</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-outline-secondary d-flex align-items-center gap-2" id="btn-refresh-stats">
                    <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                    Refresh Stats
                </button>
            </div>
        </header>

        <div class="alert alert-warning limit-alert" id="storage-warning">
            <div class="d-flex align-items-center gap-2">
                <i data-lucide="alert-triangle"></i>
                <div>
                    <strong>Storage Limit Approaching!</strong> You have used <span id="usage-warning-percent">0</span>%
                    of your allocated storage.
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- Usage Overview -->
                <div class="storage-card">
                    <h5 class="mb-4 d-flex align-items-center gap-2">
                        <i data-lucide="pie-chart" style="width: 20px;"></i>
                        Storage Usage Overview
                    </h5>

                    <div class="usage-stats">
                        <div class="usage-circle" id="usage-circle">
                            <span id="usage-percent">0%</span>
                        </div>
                        <div class="usage-details">
                            <h3 id="used-size">0.00 MB</h3>
                            <p>Used of <span id="total-limit">10.00 GB</span></p>
                            <p class="small mt-2" id="file-count">Total Files: 0</p>
                        </div>
                    </div>

                    <div class="progress mb-2" style="height: 10px; border-radius: 5px;">
                        <div class="progress-bar" id="usage-progress-bar" role="progressbar"
                            style="width: 0%; background-color: #f72c5b;"></div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>0 GB</span>
                        <span id="limit-label">10 GB</span>
                    </div>
                </div>

                <!-- Recent Files Management -->
                <div class="storage-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0 d-flex align-items-center gap-2">
                            <i data-lucide="files" style="width: 20px;"></i>
                            Recently Uploaded Files
                        </h5>
                        <div class="input-group" style="max-width: 250px;">
                            <span class="input-group-text bg-white border-end-0"><i data-lucide="search"
                                    style="width: 16px;"></i></span>
                            <input type="text" class="form-control border-start-0 ps-0" id="file-search"
                                placeholder="Search files...">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table file-list-table mb-0">
                            <thead>
                                <tr>
                                    <th>Preview</th>
                                    <th>File Name</th>
                                    <th>Size</th>
                                    <th>Uploaded At</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="file-list-body">
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <div class="spinner-border text-primary spinner-border-sm me-2"></div>
                                        Loading files from R2...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-end">
                        <button class="btn btn-sm btn-link text-decoration-none" id="btn-load-more">Load more
                            files...</button>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- Storage Configuration -->
                <div class="storage-card">
                    <h5 class="mb-4 d-flex align-items-center gap-2">
                        <i data-lucide="settings-2" style="width: 20px;"></i>
                        Storage Settings
                    </h5>

                    <div class="mb-4">
                        <label class="form-label fw-semibold">Hard Storage Limit (GB)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="storage-limit-input" value="10" min="1"
                                step="0.1">
                            <span class="input-group-text">GB</span>
                        </div>
                        <div class="form-text mt-2">Prevent new uploads once this limit is reached.</div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-semibold">Worker URL</label>
                        <input type="url" class="form-control" id="worker-url-input"
                            placeholder="https://your-worker.workers.dev">
                        <div class="form-text mt-2">The Cloudflare Worker handling R2 operations.</div>
                    </div>

                    <button class="btn btn-primary w-100" id="btn-save-storage-settings">
                        Save Storage Settings
                    </button>
                </div>

                <!-- Integration Instructions -->
                <div class="storage-card">
                    <h6 class="mb-3">Cloudflare Integration</h6>
                    <p class="text-muted small">
                        To enable monitoring and management, your Cloudflare Worker needs to support <code>LIST</code>
                        and <code>DELETE</code> operations and report bucket statistics.
                    </p>
                    <a href="javascript:void(0)" class="btn btn-sm btn-outline-primary w-100" id="btn-show-worker-code">
                        View Required Worker Code
                    </a>
                </div>
            </div>
        </div>
    </main>

    <!-- Worker Code Modal -->
    <div class="modal fade" id="workerCodeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cloudflare Worker Implementation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">Copy and paste this code into your Cloudflare Worker to enable the
                        storage management features. Make sure your R2 bucket is bound to <code>BUCKET</code>.</p>
                    <pre class="bg-dark text-light p-3 rounded"
                        style="font-size: 13px; max-height: 400px; overflow-y: auto;">
export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    const key = url.searchParams.get('key');
    const method = request.method;

    // 1. Get Stats (Usage Monitoring)
    if (url.pathname === '/stats' && method === 'GET') {
      const objects = await env.BUCKET.list({ limit: 1000 });
      let totalSize = 0;
      let count = 0;
      
      // Note: For very large buckets, this simple list might not cover everything.
      // For accurate billing-grade stats, use Cloudflare's GraphQL API.
      for (const obj of objects.objects) {
        totalSize += obj.size;
        count++;
      }
      
      return new Response(JSON.stringify({
        totalSize,
        count,
        bucketName: 'glamer-images'
      }), { headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' } });
    }

    // 2. List Files (Management)
    if (url.pathname === '/list' && method === 'GET') {
      const prefix = url.searchParams.get('prefix') || '';
      const cursor = url.searchParams.get('cursor') || undefined;
      const objects = await env.BUCKET.list({ prefix, limit: 100, cursor });
      
      return new Response(JSON.stringify(objects), { 
        headers: { 'Content-Type': 'application/json', 'Access-Control-Allow-Origin': '*' } 
      });
    }

    // 3. Delete File (Management)
    if (method === 'DELETE') {
      if (!key) return new Response('Key missing', { status: 400 });
      await env.BUCKET.delete(key);
      return new Response('Deleted', { 
        status: 200, 
        headers: { 'Access-Control-Allow-Origin': '*' } 
      });
    }

    // 4. Existing Upload Logic (PUT)
    if (method === 'PUT') {
      if (!key) return new Response('Key missing', { status: 400 });
      await env.BUCKET.put(key, request.body, {
        httpMetadata: request.headers,
      });
      return new Response('Success', { 
        headers: { 'Access-Control-Allow-Origin': '*' } 
      });
    }

    // Handle CORS Preflight
    if (method === 'OPTIONS') {
      return new Response(null, {
        headers: {
          'Access-Control-Allow-Origin': '*',
          'Access-Control-Allow-Methods': 'GET, PUT, DELETE, OPTIONS',
          'Access-Control-Allow-Headers': 'Content-Type',
        }
      });
    }

    return new Response('Not Found', { status: 404 });
  }
};
                    </pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="copyWorkerCode()">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/vendor/bootstrap/bootstrap.bundle.min.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/storage.js"></script>
    <script>
        // Ialide Icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        const workerCodeModal = new bootstrap.Modal(document.getElementById('workerCodeModal'));
        document.getElementById('btn-show-worker-code').addEventListener('click', () => {
            workerCodeModal.show();
        });

        function copyWorkerCode() {
            const code = document.querySelector('pre').innerText;
            navigator.clipboard.writeText(code).then(() => {
                alert('Worker code copied to clipboard!');
            });
        }
    </script>
</body>

</html>